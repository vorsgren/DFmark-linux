
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DFHack Lua API &#8212; DFHack 0.44.12-r2 documentation</title>
    <link rel="stylesheet" href="../_static/dfhack.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.44.12-r2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/dfhack-icon.ico"/>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Structure Definition Syntax" href="../library/xml/SYNTAX.html" />
    <link rel="prev" title="Development Changelog" href="NEWS-dev.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="dfhack-lua-api">
<span id="lua-api"></span><h1><a class="toc-backref" href="#id15">DFHack Lua API</a><a class="headerlink" href="#dfhack-lua-api" title="Permalink to this headline">¶</a></h1>
<p>DFHack has extensive support for
the <a class="reference external" href="http://www.lua.org">Lua</a> scripting language, providing access to:</p>
<ol class="arabic simple">
<li>Raw data structures used by the game.</li>
<li>Many C++ functions for high-level access to these
structures, and interaction with dfhack itself.</li>
<li>Some functions exported by C++ plugins.</li>
</ol>
<p>Lua code can be used both for writing scripts, which
are treated by DFHack command line prompt almost as
native C++ commands, and invoked by plugins written in C++.</p>
<p>This document describes native API available to Lua in detail.
It does not describe all of the utility functions
implemented by Lua files located in <code class="file docutils literal"><span class="pre">hack/lua/*</span></code>
(<code class="file docutils literal"><span class="pre">library/lua/*</span></code> in the git repo).</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#dfhack-lua-api" id="id15">DFHack Lua API</a><ul>
<li><a class="reference internal" href="#df-data-structure-wrapper" id="id16">DF data structure wrapper</a><ul>
<li><a class="reference internal" href="#typed-object-references" id="id17">Typed object references</a></li>
<li><a class="reference internal" href="#named-types" id="id18">Named types</a></li>
<li><a class="reference internal" href="#global-functions" id="id19">Global functions</a></li>
<li><a class="reference internal" href="#recursive-table-assignment" id="id20">Recursive table assignment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dfhack-api" id="id21">DFHack API</a><ul>
<li><a class="reference internal" href="#native-utilities" id="id22">Native utilities</a></li>
<li><a class="reference internal" href="#c-function-wrappers" id="id23">C++ function wrappers</a></li>
<li><a class="reference internal" href="#core-interpreter-context" id="id24">Core interpreter context</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lua-modules" id="id25">Lua Modules</a><ul>
<li><a class="reference internal" href="#global-environment" id="id26">Global environment</a></li>
<li><a class="reference internal" href="#utils" id="id27">utils</a></li>
<li><a class="reference internal" href="#dumper" id="id28">dumper</a></li>
<li><a class="reference internal" href="#profiler" id="id29">profiler</a></li>
<li><a class="reference internal" href="#class" id="id30">class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#in-game-ui-library" id="id31">In-game UI Library</a><ul>
<li><a class="reference internal" href="#gui" id="id32">gui</a></li>
<li><a class="reference internal" href="#gui-widgets" id="id33">gui.widgets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugins" id="id34">Plugins</a><ul>
<li><a class="reference internal" href="#blueprint" id="id35">blueprint</a></li>
<li><a class="reference internal" href="#burrows" id="id36">burrows</a></li>
<li><a class="reference internal" href="#sort" id="id37">sort</a></li>
<li><a class="reference internal" href="#eventful" id="id38">Eventful</a></li>
<li><a class="reference internal" href="#building-hacks" id="id39">Building-hacks</a></li>
<li><a class="reference internal" href="#luasocket" id="id40">Luasocket</a></li>
<li><a class="reference internal" href="#cxxrandom" id="id41">cxxrandom</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scripts" id="id42">Scripts</a><ul>
<li><a class="reference internal" href="#enabling-and-disabling-scripts" id="id43">Enabling and disabling scripts</a></li>
<li><a class="reference internal" href="#save-init-script" id="id44">Save init script</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="df-data-structure-wrapper">
<h2><a class="toc-backref" href="#id16">DF data structure wrapper</a><a class="headerlink" href="#df-data-structure-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id1">
<ul class="simple">
<li><a class="reference internal" href="#typed-object-references" id="id45">Typed object references</a><ul>
<li><a class="reference internal" href="#primitive-references" id="id46">Primitive references</a></li>
<li><a class="reference internal" href="#struct-references" id="id47">Struct references</a></li>
<li><a class="reference internal" href="#container-references" id="id48">Container references</a></li>
<li><a class="reference internal" href="#bitfield-references" id="id49">Bitfield references</a></li>
</ul>
</li>
<li><a class="reference internal" href="#named-types" id="id50">Named types</a></li>
<li><a class="reference internal" href="#global-functions" id="id51">Global functions</a></li>
<li><a class="reference internal" href="#recursive-table-assignment" id="id52">Recursive table assignment</a></li>
</ul>
</div>
<p>Data structures of the game are defined in XML files located in <code class="file docutils literal"><span class="pre">library/xml</span></code>
(and <a class="reference external" href="http://github.com/DFHack/df-structures">online</a>, and automatically exported
to lua code as a tree of objects and functions under the <code class="docutils literal"><span class="pre">df</span></code> global, which
also broadly maps to the <code class="docutils literal"><span class="pre">df</span></code> namespace in the headers generated for C++.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The wrapper provides almost raw access to the memory
of the game, so mistakes in manipulating objects are as likely to
crash the game as equivalent plain C++ code would be.</p>
<p class="last">eg. NULL pointer access is safely detected, but dangling pointers aren’t.</p>
</div>
<p>Objects managed by the wrapper can be broadly classified into the following groups:</p>
<ol class="arabic">
<li><p class="first">Typed object pointers (references).</p>
<p>References represent objects in DF memory with a known type.</p>
<p>In addition to fields and methods defined by the wrapped type,
every reference has some built-in properties and methods.</p>
</li>
<li><p class="first">Untyped pointers</p>
<p>Represented as lightuserdata.</p>
<p>In assignment to a pointer NULL can be represented either as
<code class="docutils literal"><span class="pre">nil</span></code>, or a NULL lightuserdata; reading a NULL pointer field
returns <code class="docutils literal"><span class="pre">nil</span></code>.</p>
</li>
<li><p class="first">Named types</p>
<p>Objects in the <code class="docutils literal"><span class="pre">df</span></code> tree that represent identity of struct, class,
enum and bitfield types. They host nested named types, static
methods, builtin properties &amp; methods, and, for enums and bitfields,
the bi-directional mapping between key names and values.</p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">global</span></code> object</p>
<p><code class="docutils literal"><span class="pre">df.global</span></code> corresponds to the <code class="docutils literal"><span class="pre">df::global</span></code> namespace, and
behaves as a mix between a named type and a reference, containing
both nested types and fields corresponding to global symbols.</p>
</li>
</ol>
<p>In addition to the <code class="docutils literal"><span class="pre">global</span></code> object and top-level types the <code class="docutils literal"><span class="pre">df</span></code>
global also contains a few global builtin utility functions.</p>
<div class="section" id="typed-object-references">
<h3><a class="toc-backref" href="#id45">Typed object references</a><a class="headerlink" href="#typed-object-references" title="Permalink to this headline">¶</a></h3>
<p>The underlying primitive lua object is userdata with a metatable.
Every structured field access produces a new userdata instance.</p>
<p>All typed objects have the following built-in features:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">ref1</span> <span class="pre">==</span> <span class="pre">ref2</span></code>, <code class="docutils literal"><span class="pre">tostring(ref)</span></code></p>
<p>References implement equality by type &amp; pointer value, and string conversion.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pairs(ref)</span></code></p>
<p>Returns an iterator for the sequence of actual C++ field names
and values. Fields are enumerated in memory order. Methods and
lua wrapper properties are not included in the iteration.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">a few of the data structures (like ui_look_list)
contain unions with pointers to different types with vtables.
Using pairs on such structs is an almost sure way to crash with
an access violation.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref._kind</span></code></p>
<p>Returns one of: <code class="docutils literal"><span class="pre">primitive</span></code>, <code class="docutils literal"><span class="pre">struct</span></code>, <code class="docutils literal"><span class="pre">container</span></code>,
or <code class="docutils literal"><span class="pre">bitfield</span></code>, as appropriate for the referenced object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref._type</span></code></p>
<p>Returns the named type object or a string that represents
the referenced object type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:sizeof()</span></code></p>
<p>Returns <em>size, address</em></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:new()</span></code></p>
<p>Allocates a new instance of the same type, and copies data
from the current object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:delete()</span></code></p>
<p>Destroys the object with the C++ <code class="docutils literal"><span class="pre">delete</span></code> operator. If the destructor is not
available, returns <em>false</em>. (This typically only occurs when trying to delete
an instance of a DF class with virtual methods whose vtable address has not
been found; it is impossible for <code class="docutils literal"><span class="pre">delete()</span></code> to determine the validity of
<code class="docutils literal"><span class="pre">ref</span></code>.)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">ref</span></code> <strong>must</strong> be an object allocated with <code class="docutils literal"><span class="pre">new</span></code>, like in C++. Calling
<code class="docutils literal"><span class="pre">obj.field:delete()</span></code> where <code class="docutils literal"><span class="pre">obj</span></code> was allocated with <code class="docutils literal"><span class="pre">new</span></code> will not
work. After <code class="docutils literal"><span class="pre">delete()</span></code> returns, <code class="docutils literal"><span class="pre">ref</span></code> remains as a dangling pointer,
like a raw C++ pointer would. Any accesses to <code class="docutils literal"><span class="pre">ref</span></code> after <code class="docutils literal"><span class="pre">ref:delete()</span></code>
has been called are undefined behavior.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:assign(object)</span></code></p>
<p>Assigns data from object to ref. Object must either be another
ref of a compatible type, or a lua table; in the latter case
special recursive assignment rules are applied.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:_displace(index[,step])</span></code></p>
<p>Returns a new reference with the pointer adjusted by index*step.
Step defaults to the natural object size.</p>
</li>
</ul>
<div class="section" id="primitive-references">
<h4><a class="toc-backref" href="#id46">Primitive references</a><a class="headerlink" href="#primitive-references" title="Permalink to this headline">¶</a></h4>
<p>References of the <em>_kind</em> <code class="docutils literal"><span class="pre">'primitive'</span></code> are used for objects
that don’t fit any of the other reference types. Such
references can only appear as a value of a pointer field,
or as a result of calling the <code class="docutils literal"><span class="pre">_field()</span></code> method.</p>
<p>They behave as structs with one field <code class="docutils literal"><span class="pre">value</span></code> of the right type.</p>
<p>To make working with numeric buffers easier, they also allow
numeric indices. Note that other than excluding negative values
no bound checking is performed, since buffer length is not available.
Index 0 is equivalent to the <code class="docutils literal"><span class="pre">value</span></code> field.</p>
</div>
<div class="section" id="struct-references">
<h4><a class="toc-backref" href="#id47">Struct references</a><a class="headerlink" href="#struct-references" title="Permalink to this headline">¶</a></h4>
<p>Struct references are used for class and struct objects.</p>
<p>They implement the following features:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">ref.field</span></code>, <code class="docutils literal"><span class="pre">ref.field</span> <span class="pre">=</span> <span class="pre">value</span></code></p>
<p>Valid fields of the structure may be accessed by subscript.</p>
<p>Primitive typed fields, i.e. numbers &amp; strings, are converted
to/from matching lua values. The value of a pointer is a reference
to the target, or <code class="docutils literal"><span class="pre">nil</span></code>/NULL. Complex types are represented by
a reference to the field within the structure; unless recursive
lua table assignment is used, such fields can only be read.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In case of inheritance, <em>superclass</em> fields have precedence
over the subclass, but fields shadowed in this way can still
be accessed as <code class="docutils literal"><span class="pre">ref['subclasstype.field']</span></code>.</p>
<p class="last">This shadowing order is necessary because vtable-based classes
are automatically exposed in their exact type, and the reverse
rule would make access to superclass fields unreliable.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref._field(field)</span></code></p>
<p>Returns a reference to a valid field. That is, unlike regular
subscript, it returns a reference to the field within the structure
even for primitive typed fields and pointers.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:vmethod(args...)</span></code></p>
<p>Named virtual methods are also exposed, subject to the same
shadowing rules.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pairs(ref)</span></code></p>
<p>Enumerates all real fields (but not methods) in memory
order, which is the same as declaration order.</p>
</li>
</ul>
</div>
<div class="section" id="container-references">
<h4><a class="toc-backref" href="#id48">Container references</a><a class="headerlink" href="#container-references" title="Permalink to this headline">¶</a></h4>
<p>Containers represent vectors and arrays, possibly resizable.</p>
<p>A container field can associate an enum to the container
reference, which allows accessing elements using string keys
instead of numerical indices.</p>
<p>Note that two-dimensional arrays in C++ (ie pointers to pointers)
are exposed to lua as one-dimensional.  The best way to handle this
is probably <code class="docutils literal"><span class="pre">array[x].value:_displace(y)</span></code>.</p>
<p>Implemented features:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">ref._enum</span></code></p>
<p>If the container has an associated enum, returns the matching
named type object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">#ref</span></code></p>
<p>Returns the <em>length</em> of the container.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref[index]</span></code></p>
<p>Accesses the container element, using either a <em>0-based</em> numerical
index, or, if an enum is associated, a valid enum key string.</p>
<p>Accessing an invalid index is an error, but some container types
may return a default value, or auto-resize instead for convenience.
Currently this relaxed mode is implemented by df-flagarray aka BitArray.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref._field(index)</span></code></p>
<p>Like with structs, returns a pointer to the array element, if possible.
Flag and bit arrays cannot return such pointer, so it fails with an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pairs(ref)</span></code>, <code class="docutils literal"><span class="pre">ipairs(ref)</span></code></p>
<p>If the container has no associated enum, both behave identically,
iterating over numerical indices in order. Otherwise, ipairs still
uses numbers, while pairs tries to substitute enum keys whenever
possible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:resize(new_size)</span></code></p>
<p>Resizes the container if supported, or fails with an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:insert(index,item)</span></code></p>
<p>Inserts a new item at the specified index. To add at the end,
use <code class="docutils literal"><span class="pre">#ref</span></code>, or just <code class="docutils literal"><span class="pre">'#'</span></code> as index.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ref:erase(index)</span></code></p>
<p>Removes the element at the given valid index.</p>
</li>
</ul>
</div>
<div class="section" id="bitfield-references">
<h4><a class="toc-backref" href="#id49">Bitfield references</a><a class="headerlink" href="#bitfield-references" title="Permalink to this headline">¶</a></h4>
<p>Bitfields behave like special fixed-size containers.
Consider them to be something in between structs and
fixed-size vectors.</p>
<p>The <code class="docutils literal"><span class="pre">_enum</span></code> property points to the bitfield type.
Numerical indices correspond to the shift value,
and if a subfield occupies multiple bits, the
<code class="docutils literal"><span class="pre">ipairs</span></code> order would have a gap.</p>
<p>Since currently there is no API to allocate a bitfield
object fully in GC-managed lua heap, consider using the
lua table assignment feature outlined below in order to
pass bitfield values to dfhack API functions that need
them, e.g. <code class="docutils literal"><span class="pre">matinfo:matches{metal=true}</span></code>.</p>
</div>
</div>
<div class="section" id="named-types">
<h3><a class="toc-backref" href="#id50">Named types</a><a class="headerlink" href="#named-types" title="Permalink to this headline">¶</a></h3>
<p>Named types are exposed in the <code class="docutils literal"><span class="pre">df</span></code> tree with names identical
to the C++ version, except for the <code class="docutils literal"><span class="pre">::</span></code> vs <code class="docutils literal"><span class="pre">.</span></code> difference.</p>
<p>All types and the global object have the following features:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">type._kind</span></code></p>
<p>Evaluates to one of <code class="docutils literal"><span class="pre">struct-type</span></code>, <code class="docutils literal"><span class="pre">class-type</span></code>, <code class="docutils literal"><span class="pre">enum-type</span></code>,
<code class="docutils literal"><span class="pre">bitfield-type</span></code> or <code class="docutils literal"><span class="pre">global</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">type._identity</span></code></p>
<p>Contains a lightuserdata pointing to the underlying
<code class="docutils literal"><span class="pre">DFHack::type_instance</span></code> object.</p>
</li>
</ul>
<p>Types excluding the global object also support:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">type:sizeof()</span></code></p>
<p>Returns the size of an object of the type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">type:new()</span></code></p>
<p>Creates a new instance of an object of the type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">type:is_instance(object)</span></code></p>
<p>Returns true if object is same or subclass type, or a reference
to an object of same or subclass type. It is permissible to pass
<code class="docutils literal"><span class="pre">nil</span></code>, NULL or non-wrapper value as object; in this case the
method returns <code class="docutils literal"><span class="pre">nil</span></code>.</p>
</li>
</ul>
<p>In addition to this, enum and bitfield types contain a
bi-directional mapping between key strings and values, and
also map <code class="docutils literal"><span class="pre">_first_item</span></code> and <code class="docutils literal"><span class="pre">_last_item</span></code> to the min and
max values.</p>
<p>Struct and class types with instance-vector attribute in the
xml have a <code class="docutils literal"><span class="pre">type.find(key)</span></code> function that wraps the find
method provided in C++.</p>
</div>
<div class="section" id="global-functions">
<h3><a class="toc-backref" href="#id51">Global functions</a><a class="headerlink" href="#global-functions" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">df</span></code> table itself contains the following functions and values:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">NULL</span></code>, <code class="docutils literal"><span class="pre">df.NULL</span></code></p>
<p>Contains the NULL lightuserdata.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.isnull(obj)</span></code></p>
<p>Evaluates to true if obj is nil or NULL; false otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.isvalid(obj[,allow_null])</span></code></p>
<p>For supported objects returns one of <code class="docutils literal"><span class="pre">type</span></code>, <code class="docutils literal"><span class="pre">voidptr</span></code>, <code class="docutils literal"><span class="pre">ref</span></code>.</p>
<p>If <em>allow_null</em> is true, and obj is nil or NULL, returns <code class="docutils literal"><span class="pre">null</span></code>.</p>
<p>Otherwise returns <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.sizeof(obj)</span></code></p>
<p>For types and refs identical to <code class="docutils literal"><span class="pre">obj:sizeof()</span></code>.
For lightuserdata returns <em>nil, address</em></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.new(obj)</span></code>, <code class="docutils literal"><span class="pre">df.delete(obj)</span></code>, <code class="docutils literal"><span class="pre">df.assign(obj,</span> <span class="pre">obj2)</span></code></p>
<p>Equivalent to using the matching methods of obj.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df._displace(obj,index[,step])</span></code></p>
<p>For refs equivalent to the method, but also works with
lightuserdata (step is mandatory then).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.is_instance(type,obj)</span></code></p>
<p>Equivalent to the method, but also allows a reference as proxy for its type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.new(ptype[,count])</span></code></p>
<p>Allocate a new instance, or an array of built-in types.
The <code class="docutils literal"><span class="pre">ptype</span></code> argument is a string from the following list:
<code class="docutils literal"><span class="pre">string</span></code>, <code class="docutils literal"><span class="pre">int8_t</span></code>, <code class="docutils literal"><span class="pre">uint8_t</span></code>, <code class="docutils literal"><span class="pre">int16_t</span></code>, <code class="docutils literal"><span class="pre">uint16_t</span></code>,
<code class="docutils literal"><span class="pre">int32_t</span></code>, <code class="docutils literal"><span class="pre">uint32_t</span></code>, <code class="docutils literal"><span class="pre">int64_t</span></code>, <code class="docutils literal"><span class="pre">uint64_t</span></code>, <code class="docutils literal"><span class="pre">bool</span></code>,
<code class="docutils literal"><span class="pre">float</span></code>, <code class="docutils literal"><span class="pre">double</span></code>. All of these except <code class="docutils literal"><span class="pre">string</span></code> can be
used with the count argument to allocate an array.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">df.reinterpret_cast(type,ptr)</span></code></p>
<p>Converts ptr to a ref of specified type. The type may be anything
acceptable to <code class="docutils literal"><span class="pre">df.is_instance</span></code>. Ptr may be <em>nil</em>, a ref,
a lightuserdata, or a number.</p>
<p>Returns <em>nil</em> if NULL, or a ref.</p>
</li>
</ul>
</div>
<div class="section" id="recursive-table-assignment">
<span id="lua-api-table-assignment"></span><h3><a class="toc-backref" href="#id52">Recursive table assignment</a><a class="headerlink" href="#recursive-table-assignment" title="Permalink to this headline">¶</a></h3>
<p>Recursive assignment is invoked when a lua table is assigned
to a C++ object or field, i.e. one of:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ref:assign{...}</span></code></li>
<li><code class="docutils literal"><span class="pre">ref.field</span> <span class="pre">=</span> <span class="pre">{...}</span></code></li>
</ul>
<p>The general mode of operation is that all fields of the table
are assigned to the fields of the target structure, roughly
emulating the following code:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">rec_assign</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">table</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">ref</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Since assigning a table to a field using = invokes the same
process, it is recursive.</p>
<p>There are however some variations to this process depending
on the type of the field being assigned to:</p>
<ol class="arabic">
<li><p class="first">If the table contains an <code class="docutils literal"><span class="pre">assign</span></code> field, it is
applied first, using the <code class="docutils literal"><span class="pre">ref:assign(value)</span></code> method.
It is never assigned as a usual field.</p>
</li>
<li><p class="first">When a table is assigned to a non-NULL pointer field
using the <code class="docutils literal"><span class="pre">ref.field</span> <span class="pre">=</span> <span class="pre">{...}</span></code> syntax, it is applied
to the target of the pointer instead.</p>
<p>If the pointer is NULL, the table is checked for a <code class="docutils literal"><span class="pre">new</span></code> field:</p>
<ol class="loweralpha simple">
<li>If it is <em>nil</em> or <em>false</em>, assignment fails with an error.</li>
<li>If it is <em>true</em>, the pointer is initialized with a newly
allocated object of the declared target type of the pointer.</li>
<li>Otherwise, <code class="docutils literal"><span class="pre">table.new</span></code> must be a named type, or an
object of a type compatible with the pointer. The pointer
is initialized with the result of calling <code class="docutils literal"><span class="pre">table.new:new()</span></code>.</li>
</ol>
<p>After this auto-vivification process, assignment proceeds
as if the pointer wasn’t NULL.</p>
<p>Obviously, the <code class="docutils literal"><span class="pre">new</span></code> field inside the table is always skipped
during the actual per-field assignment processing.</p>
</li>
<li><p class="first">If the target of the assignment is a container, a separate
rule set is used:</p>
<ol class="loweralpha">
<li><p class="first">If the table contains neither <code class="docutils literal"><span class="pre">assign</span></code> nor <code class="docutils literal"><span class="pre">resize</span></code>
fields, it is interpreted as an ordinary <em>1-based</em> lua
array. The container is resized to the #-size of the
table, and elements are assigned in numeric order:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ref</span><span class="p">:</span><span class="n">resize</span><span class="p">(</span><span class="c1">#table);</span>
<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="c1">#table do ref[i-1] = table[i] end</span>
</pre></div>
</div>
</li>
<li><p class="first">Otherwise, <code class="docutils literal"><span class="pre">resize</span></code> must be <em>true</em>, <em>false</em>, or
an explicit number. If it is not false, the container
is resized. After that the usual struct-like ‘pairs’
assignment is performed.</p>
<p>In case <code class="docutils literal"><span class="pre">resize</span></code> is <em>true</em>, the size is computed
by scanning the table for the largest numeric key.</p>
</li>
</ol>
<p>This means that in order to reassign only one element of
a container using this system, it is necessary to use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">resize</span><span class="o">=</span><span class="n">false</span><span class="p">,</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">value</span> <span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>Since <code class="docutils literal"><span class="pre">nil</span></code> inside a table is indistinguishable from missing key,
it is necessary to use <code class="docutils literal"><span class="pre">df.NULL</span></code> as a null pointer value.</p>
<p>This system is intended as a way to define a nested object
tree using pure lua data structures, and then materialize it in
C++ memory in one go. Note that if pointer auto-vivification
is used, an error in the middle of the recursive walk would
not destroy any objects allocated in this way, so the user
should be prepared to catch the error and do the necessary
cleanup.</p>
</div>
</div>
<div class="section" id="dfhack-api">
<h2><a class="toc-backref" href="#id21">DFHack API</a><a class="headerlink" href="#dfhack-api" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id2">
<ul class="simple">
<li><a class="reference internal" href="#native-utilities" id="id53">Native utilities</a><ul>
<li><a class="reference internal" href="#input-output" id="id54">Input &amp; Output</a></li>
<li><a class="reference internal" href="#exception-handling" id="id55">Exception handling</a></li>
<li><a class="reference internal" href="#miscellaneous" id="id56">Miscellaneous</a></li>
<li><a class="reference internal" href="#locking-and-finalization" id="id57">Locking and finalization</a></li>
<li><a class="reference internal" href="#persistent-configuration-storage" id="id58">Persistent configuration storage</a></li>
<li><a class="reference internal" href="#material-info-lookup" id="id59">Material info lookup</a></li>
<li><a class="reference internal" href="#random-number-generation" id="id60">Random number generation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#c-function-wrappers" id="id61">C++ function wrappers</a><ul>
<li><a class="reference internal" href="#gui-module" id="id62">Gui module</a><ul>
<li><a class="reference internal" href="#screens" id="id63">Screens</a></li>
<li><a class="reference internal" href="#general-purpose-selections" id="id64">General-purpose selections</a></li>
<li><a class="reference internal" href="#fortress-mode" id="id65">Fortress mode</a></li>
<li><a class="reference internal" href="#announcements" id="id66">Announcements</a></li>
<li><a class="reference internal" href="#other" id="id67">Other</a></li>
</ul>
</li>
<li><a class="reference internal" href="#job-module" id="id68">Job module</a></li>
<li><a class="reference internal" href="#units-module" id="id69">Units module</a></li>
<li><a class="reference internal" href="#items-module" id="id70">Items module</a></li>
<li><a class="reference internal" href="#maps-module" id="id71">Maps module</a></li>
<li><a class="reference internal" href="#burrows-module" id="id72">Burrows module</a></li>
<li><a class="reference internal" href="#buildings-module" id="id73">Buildings module</a><ul>
<li><a class="reference internal" href="#general" id="id74">General</a></li>
<li><a class="reference internal" href="#low-level" id="id75">Low-level</a></li>
<li><a class="reference internal" href="#high-level" id="id76">High-level</a></li>
</ul>
</li>
<li><a class="reference internal" href="#constructions-module" id="id77">Constructions module</a></li>
<li><a class="reference internal" href="#kitchen-module" id="id78">Kitchen module</a></li>
<li><a class="reference internal" href="#screen-api" id="id79">Screen API</a></li>
<li><a class="reference internal" href="#penarray-class" id="id80">PenArray class</a></li>
<li><a class="reference internal" href="#filesystem-module" id="id81">Filesystem module</a></li>
<li><a class="reference internal" href="#console-api" id="id82">Console API</a></li>
<li><a class="reference internal" href="#internal-api" id="id83">Internal API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#core-interpreter-context" id="id84">Core interpreter context</a><ul>
<li><a class="reference internal" href="#event-type" id="id85">Event type</a></li>
</ul>
</li>
</ul>
</div>
<p>DFHack utility functions are placed in the <code class="docutils literal"><span class="pre">dfhack</span></code> global tree.</p>
<div class="section" id="native-utilities">
<h3><a class="toc-backref" href="#id53">Native utilities</a><a class="headerlink" href="#native-utilities" title="Permalink to this headline">¶</a></h3>
<div class="section" id="input-output">
<h4><a class="toc-backref" href="#id54">Input &amp; Output</a><a class="headerlink" href="#input-output" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.print(args...)</span></code></p>
<p>Output tab-separated args as standard lua print would do,
but without a newline.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">print(args...)</span></code>, <code class="docutils literal"><span class="pre">dfhack.println(args...)</span></code></p>
<p>A replacement of the standard library print function that
works with DFHack output infrastructure.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.printerr(args...)</span></code></p>
<p>Same as println; intended for errors. Uses red color and logs to stderr.log.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.color([color])</span></code></p>
<p>Sets the current output color. If color is <em>nil</em> or <em>-1</em>, resets to default.
Returns the previous color value.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.is_interactive()</span></code></p>
<p>Checks if the thread can access the interactive console and returns <em>true</em> or <em>false</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.lineedit([prompt[,history_filename]])</span></code></p>
<p>If the thread owns the interactive console, shows a prompt
and returns the entered string. Otherwise returns <em>nil, error</em>.</p>
<p>Depending on the context, this function may actually yield the
running coroutine and let the C++ code release the core suspend
lock. Using an explicit <code class="docutils literal"><span class="pre">dfhack.with_suspend</span></code> will prevent
this, forcing the function to block on input with lock held.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.interpreter([prompt[,history_filename[,env]]])</span></code></p>
<p>Starts an interactive lua interpreter, using the specified prompt
string, global environment and command-line history file.</p>
<p>If the interactive console is not accessible, returns <em>nil, error</em>.</p>
</li>
</ul>
</div>
<div class="section" id="exception-handling">
<h4><a class="toc-backref" href="#id55">Exception handling</a><a class="headerlink" href="#exception-handling" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.error(msg[,level[,verbose]])</span></code></p>
<p>Throws a dfhack exception object with location and stack trace.
The verbose parameter controls whether the trace is printed by default.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">qerror(msg[,level])</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">dfhack.error()</span></code> with <code class="docutils literal"><span class="pre">verbose</span></code> being <em>false</em>. Intended to
be used for user-caused errors in scripts, where stack traces are not
desirable.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.pcall(f[,args...])</span></code></p>
<p>Invokes f via xpcall, using an error function that attaches
a stack trace to the error. The same function is used by SafeCall
in C++, and dfhack.safecall.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">safecall(f[,args...])</span></code>, <code class="docutils literal"><span class="pre">dfhack.safecall(f[,args...])</span></code></p>
<p>Just like pcall, but also prints the error using printerr before
returning. Intended as a convenience function.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.saferesume(coroutine[,args...])</span></code></p>
<p>Compares to coroutine.resume like dfhack.safecall vs pcall.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.exception</span></code></p>
<p>Metatable of error objects used by dfhack. The objects have the
following properties:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">err.where</span></code></dt>
<dd><p class="first last">The location prefix string, or <em>nil</em>.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">err.message</span></code></dt>
<dd><p class="first last">The base message string.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">err.stacktrace</span></code></dt>
<dd><p class="first last">The stack trace string, or <em>nil</em>.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">err.cause</span></code></dt>
<dd><p class="first last">A different exception object, or <em>nil</em>.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">err.thread</span></code></dt>
<dd><p class="first last">The coroutine that has thrown the exception.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">err.verbose</span></code></dt>
<dd><p class="first last">Boolean, or <em>nil</em>; specifies if where and stacktrace should be printed.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">tostring(err)</span></code>, or <code class="docutils literal"><span class="pre">err:tostring([verbose])</span></code></dt>
<dd><p class="first last">Converts the exception to string.</p>
</dd>
</dl>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.exception.verbose</span></code></p>
<p>The default value of the <code class="docutils literal"><span class="pre">verbose</span></code> argument of <code class="docutils literal"><span class="pre">err:tostring()</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="miscellaneous">
<h4><a class="toc-backref" href="#id56">Miscellaneous</a><a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.VERSION</span></code></p>
<p>DFHack version string constant.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.curry(func,args...)</span></code>, or <code class="docutils literal"><span class="pre">curry(func,args...)</span></code></p>
<p>Returns a closure that invokes the function with args combined
both from the curry call and the closure call itself. I.e.
<code class="docutils literal"><span class="pre">curry(func,a,b)(c,d)</span></code> equals <code class="docutils literal"><span class="pre">func(a,b,c,d)</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="locking-and-finalization">
<h4><a class="toc-backref" href="#id57">Locking and finalization</a><a class="headerlink" href="#locking-and-finalization" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.with_suspend(f[,args...])</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">f</span></code> with arguments after grabbing the DF core suspend lock.
Suspending is necessary for accessing a consistent state of DF memory.</p>
<p>Returned values and errors are propagated through after releasing
the lock. It is safe to nest suspends.</p>
<p>Every thread is allowed only one suspend per DF frame, so it is best
to group operations together in one big critical section. A plugin
can choose to run all lua code inside a C++-side suspend lock.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.call_with_finalizer(num_cleanup_args,always,cleanup_fn[,cleanup_args...],fn[,args...])</span></code></p>
<p>Invokes <code class="docutils literal"><span class="pre">fn</span></code> with <code class="docutils literal"><span class="pre">args</span></code>, and after it returns or throws an
error calls <code class="docutils literal"><span class="pre">cleanup_fn</span></code> with <code class="docutils literal"><span class="pre">cleanup_args</span></code>. Any return values from
<code class="docutils literal"><span class="pre">fn</span></code> are propagated, and errors are re-thrown.</p>
<p>The <code class="docutils literal"><span class="pre">num_cleanup_args</span></code> integer specifies the number of <code class="docutils literal"><span class="pre">cleanup_args</span></code>,
and the <code class="docutils literal"><span class="pre">always</span></code> boolean specifies if cleanup should be called in any case,
or only in case of an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.with_finalize(cleanup_fn,fn[,args...])</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">fn</span></code> with arguments, then finalizes with <code class="docutils literal"><span class="pre">cleanup_fn</span></code>.
Implemented using <code class="docutils literal"><span class="pre">call_with_finalizer(0,true,...)</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.with_onerror(cleanup_fn,fn[,args...])</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">fn</span></code> with arguments, then finalizes with <code class="docutils literal"><span class="pre">cleanup_fn</span></code> on any thrown error.
Implemented using <code class="docutils literal"><span class="pre">call_with_finalizer(0,false,...)</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.with_temp_object(obj,fn[,args...])</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">fn(obj,args...)</span></code>, then finalizes with <code class="docutils literal"><span class="pre">obj:delete()</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="persistent-configuration-storage">
<h4><a class="toc-backref" href="#id58">Persistent configuration storage</a><a class="headerlink" href="#persistent-configuration-storage" title="Permalink to this headline">¶</a></h4>
<p>This api is intended for storing configuration options in the world itself.
It probably should be restricted to data that is world-dependent.</p>
<p>Entries are identified by a string <code class="docutils literal"><span class="pre">key</span></code>, but it is also possible to manage
multiple entries with the same key; their identity is determined by <code class="docutils literal"><span class="pre">entry_id</span></code>.
Every entry has a mutable string <code class="docutils literal"><span class="pre">value</span></code>, and an array of 7 mutable <code class="docutils literal"><span class="pre">ints</span></code>.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.persistent.get(key)</span></code>, <code class="docutils literal"><span class="pre">entry:get()</span></code></p>
<p>Retrieves a persistent config record with the given string key,
or refreshes an already retrieved entry. If there are multiple
entries with the same key, it is undefined which one is retrieved
by the first version of the call.</p>
<p>Returns entry, or <em>nil</em> if not found.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.persistent.delete(key)</span></code>, <code class="docutils literal"><span class="pre">entry:delete()</span></code></p>
<p>Removes an existing entry. Returns <em>true</em> if succeeded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.persistent.get_all(key[,match_prefix])</span></code></p>
<p>Retrieves all entries with the same key, or starting with key..’/’.
Calling <code class="docutils literal"><span class="pre">get_all('',true)</span></code> will match all entries.</p>
<p>If none found, returns nil; otherwise returns an array of entries.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.persistent.save({key=str1,</span> <span class="pre">...}[,new])</span></code>, <code class="docutils literal"><span class="pre">entry:save([new])</span></code></p>
<p>Saves changes in an entry, or creates a new one. Passing true as
new forces creation of a new entry even if one already exists;
otherwise the existing one is simply updated.
Returns <em>entry, did_create_new</em></p>
</li>
</ul>
<p>Since the data is hidden in data structures owned by the DF world,
and automatically stored in the save game, these save and retrieval
functions can just copy values in memory without doing any actual I/O.
However, currently every entry has a 180+-byte dead-weight overhead.</p>
<p>It is also possible to associate one bit per map tile with an entry,
using these two methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">entry:getTilemask(block[,</span> <span class="pre">create])</span></code></p>
<p>Retrieves the tile bitmask associated with this entry in the given map
block. If <code class="docutils literal"><span class="pre">create</span></code> is <em>true</em>, an empty mask is created if none exists;
otherwise the function returns <em>nil</em>, which must be assumed to be the same
as an all-zero mask.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">entry:deleteTilemask(block)</span></code></p>
<p>Deletes the associated tile mask from the given map block.</p>
</li>
</ul>
<p>Note that these masks are only saved in fortress mode, and also that deleting
the persistent entry will <strong>NOT</strong> delete the associated masks.</p>
</div>
<div class="section" id="material-info-lookup">
<h4><a class="toc-backref" href="#id59">Material info lookup</a><a class="headerlink" href="#material-info-lookup" title="Permalink to this headline">¶</a></h4>
<p>A material info record has fields:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">type</span></code>, <code class="docutils literal"><span class="pre">index</span></code>, <code class="docutils literal"><span class="pre">material</span></code></p>
<p>DF material code pair, and a reference to the material object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">mode</span></code></p>
<p>One of <code class="docutils literal"><span class="pre">'builtin'</span></code>, <code class="docutils literal"><span class="pre">'inorganic'</span></code>, <code class="docutils literal"><span class="pre">'plant'</span></code>, <code class="docutils literal"><span class="pre">'creature'</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">inorganic</span></code>, <code class="docutils literal"><span class="pre">plant</span></code>, <code class="docutils literal"><span class="pre">creature</span></code></p>
<p>If the material is of the matching type, contains a reference to the raw object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">figure</span></code></p>
<p>For a specific creature material contains a ref to the historical figure.</p>
</li>
</ul>
<p>Functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.matinfo.decode(type,index)</span></code></p>
<p>Looks up material info for the given number pair; if not found, returs <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">....decode(matinfo)</span></code>, <code class="docutils literal"><span class="pre">....decode(item)</span></code>, <code class="docutils literal"><span class="pre">....decode(obj)</span></code></p>
<p>Uses <code class="docutils literal"><span class="pre">matinfo.type</span></code>/<code class="docutils literal"><span class="pre">matinfo.index</span></code>, item getter vmethods,
or <code class="docutils literal"><span class="pre">obj.mat_type</span></code>/<code class="docutils literal"><span class="pre">obj.mat_index</span></code> to get the code pair.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.matinfo.find(token[,token...])</span></code></p>
<p>Looks up material by a token string, or a pre-split string token sequence.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.matinfo.getToken(...)</span></code>, <code class="docutils literal"><span class="pre">info:getToken()</span></code></p>
<p>Applies <code class="docutils literal"><span class="pre">decode</span></code> and constructs a string token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">info:toString([temperature[,named]])</span></code></p>
<p>Returns the human-readable name at the given temperature.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">info:getCraftClass()</span></code></p>
<p>Returns the classification used for craft skills.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">info:matches(obj)</span></code></p>
<p>Checks if the material matches job_material_category or job_item.
Accept dfhack_material_category auto-assign table.</p>
</li>
</ul>
</div>
<div class="section" id="random-number-generation">
<span id="lua-api-random"></span><h4><a class="toc-backref" href="#id60">Random number generation</a><a class="headerlink" href="#random-number-generation" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.random.new([seed[,perturb_count]])</span></code></p>
<p>Creates a new random number generator object. Without any
arguments, the object is initialized using current time.
Otherwise, the seed must be either a non-negative integer,
or a list of such integers. The second argument may specify
the number of additional randomization steps performed to
improve the initial state.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:init([seed[,perturb_count]])</span></code></p>
<p>Re-initializes an already existing random number generator object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:random([limit])</span></code></p>
<p>Returns a random integer. If <code class="docutils literal"><span class="pre">limit</span></code> is specified, the value
is in the range [0, limit); otherwise it uses the whole 32-bit
unsigned integer range.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:drandom()</span></code></p>
<p>Returns a random floating-point number in the range [0,1).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:drandom0()</span></code></p>
<p>Returns a random floating-point number in the range (0,1).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:drandom1()</span></code></p>
<p>Returns a random floating-point number in the range [0,1].</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:unitrandom()</span></code></p>
<p>Returns a random floating-point number in the range [-1,1].</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rng:unitvector([size])</span></code></p>
<p>Returns multiple values that form a random vector of length 1,
uniformly distributed over the corresponding sphere surface.
The default size is 3.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">fn</span> <span class="pre">=</span> <span class="pre">rng:perlin([dim]);</span> <span class="pre">fn(x[,y[,z]])</span></code></p>
<p>Returns a closure that computes a classical Perlin noise function
of dimension <em>dim</em>, initialized from this random generator.
Dimension may be 1, 2 or 3 (default).</p>
</li>
</ul>
</div>
</div>
<div class="section" id="c-function-wrappers">
<h3><a class="toc-backref" href="#id61">C++ function wrappers</a><a class="headerlink" href="#c-function-wrappers" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="id3">
<ul class="simple">
<li><a class="reference internal" href="#gui-module" id="id86">Gui module</a><ul>
<li><a class="reference internal" href="#screens" id="id87">Screens</a></li>
<li><a class="reference internal" href="#general-purpose-selections" id="id88">General-purpose selections</a></li>
<li><a class="reference internal" href="#fortress-mode" id="id89">Fortress mode</a></li>
<li><a class="reference internal" href="#announcements" id="id90">Announcements</a></li>
<li><a class="reference internal" href="#other" id="id91">Other</a></li>
</ul>
</li>
<li><a class="reference internal" href="#job-module" id="id92">Job module</a></li>
<li><a class="reference internal" href="#units-module" id="id93">Units module</a></li>
<li><a class="reference internal" href="#items-module" id="id94">Items module</a></li>
<li><a class="reference internal" href="#maps-module" id="id95">Maps module</a></li>
<li><a class="reference internal" href="#burrows-module" id="id96">Burrows module</a></li>
<li><a class="reference internal" href="#buildings-module" id="id97">Buildings module</a><ul>
<li><a class="reference internal" href="#general" id="id98">General</a></li>
<li><a class="reference internal" href="#low-level" id="id99">Low-level</a></li>
<li><a class="reference internal" href="#high-level" id="id100">High-level</a></li>
</ul>
</li>
<li><a class="reference internal" href="#constructions-module" id="id101">Constructions module</a></li>
<li><a class="reference internal" href="#kitchen-module" id="id102">Kitchen module</a></li>
<li><a class="reference internal" href="#screen-api" id="id103">Screen API</a></li>
<li><a class="reference internal" href="#penarray-class" id="id104">PenArray class</a></li>
<li><a class="reference internal" href="#filesystem-module" id="id105">Filesystem module</a></li>
<li><a class="reference internal" href="#console-api" id="id106">Console API</a></li>
<li><a class="reference internal" href="#internal-api" id="id107">Internal API</a></li>
</ul>
</div>
<p>Thin wrappers around C++ functions, similar to the ones for virtual methods.
One notable difference is that these explicit wrappers allow argument count
adjustment according to the usual lua rules, so trailing false/nil arguments
can be omitted.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getOSType()</span></code></p>
<p>Returns the OS type string from <code class="docutils literal"><span class="pre">symbols.xml</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getDFVersion()</span></code></p>
<p>Returns the DF version string from <code class="docutils literal"><span class="pre">symbols.xml</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getDFHackVersion()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getDFHackRelease()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getDFHackBuildID()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getCompiledDFVersion()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getGitDescription()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getGitCommit()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.isRelease()</span></code></p>
<p>Return information about the DFHack build in use.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">getCompiledDFVersion()</span></code> returns the DF version specified at compile time,
while <code class="docutils literal"><span class="pre">getDFVersion()</span></code> returns the version and typically the OS as well.
These do not necessarily match - for example, DFHack 0.34.11-r5 worked with
DF 0.34.10 and 0.34.11, so the former function would always return <code class="docutils literal"><span class="pre">0.34.11</span></code>
while the latter would return <code class="docutils literal"><span class="pre">v0.34.10</span> <span class="pre">&lt;platform&gt;</span></code> or <code class="docutils literal"><span class="pre">v0.34.11</span> <span class="pre">&lt;platform&gt;</span></code>.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getDFPath()</span></code></p>
<p>Returns the DF directory path.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getHackPath()</span></code></p>
<p>Returns the dfhack directory path, i.e. <code class="docutils literal"><span class="pre">&quot;.../df/hack/&quot;</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getSavePath()</span></code></p>
<p>Returns the path to the current save directory, or <em>nil</em> if no save loaded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getTickCount()</span></code></p>
<p>Returns the tick count in ms, exactly as DF ui uses.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.isWorldLoaded()</span></code></p>
<p>Checks if the world is loaded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.isMapLoaded()</span></code></p>
<p>Checks if the world and map are loaded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.TranslateName(name[,in_english,only_last_name])</span></code></p>
<p>Convert a language_name or only the last name part to string.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.df2utf(string)</span></code></p>
<p>Convert a string from DF’s CP437 encoding to UTF-8.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.df2console()</span></code></p>
<p>Convert a string from DF’s CP437 encoding to the correct encoding for the
DFHack console.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.utf2df(string)</span></code></p>
<p>Convert a string from UTF-8 to DF’s CP437 encoding.</p>
</li>
</ul>
<p><strong>Note:</strong> When printing CP437-encoded text to the console (for example, names
returned from TranslateName()), use <code class="docutils literal"><span class="pre">print(dfhack.df2console(text)</span></code> to ensure
proper display on all platforms.</p>
<div class="section" id="gui-module">
<h4><a class="toc-backref" href="#id86">Gui module</a><a class="headerlink" href="#gui-module" title="Permalink to this headline">¶</a></h4>
<div class="section" id="screens">
<h5><a class="toc-backref" href="#id87">Screens</a><a class="headerlink" href="#screens" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getCurViewscreen([skip_dismissed])</span></code></p>
<p>Returns the topmost viewscreen. If <code class="docutils literal"><span class="pre">skip_dismissed</span></code> is <em>true</em>,
ignores screens already marked to be removed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getFocusString(viewscreen)</span></code></p>
<p>Returns a string representation of the current focus position
in the ui. The string has a “screen/foo/bar/baz…” format.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getCurFocus([skip_dismissed])</span></code></p>
<p>Returns the focus string of the current viewscreen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getViewscreenByType(type</span> <span class="pre">[,</span> <span class="pre">depth])</span></code></p>
<p>Returns the topmost viewscreen out of the top <code class="docutils literal"><span class="pre">depth</span></code> viewscreens with
the specified type (e.g. <code class="docutils literal"><span class="pre">df.viewscreen_titlest</span></code>), or <code class="docutils literal"><span class="pre">nil</span></code> if none match.
If <code class="docutils literal"><span class="pre">depth</span></code> is not specified or is less than 1, all viewscreens are checked.</p>
</li>
</ul>
</div>
<div class="section" id="general-purpose-selections">
<h5><a class="toc-backref" href="#id88">General-purpose selections</a><a class="headerlink" href="#general-purpose-selections" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedWorkshopJob([silent])</span></code></p>
<p>When a job is selected in <code class="kbd docutils literal"><span class="pre">q</span></code> mode, returns the job, else
prints error unless silent and returns <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedJob([silent])</span></code></p>
<p>Returns the job selected in a workshop or unit/jobs screen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedUnit([silent])</span></code></p>
<p>Returns the unit selected via <code class="kbd docutils literal"><span class="pre">v</span></code>, <code class="kbd docutils literal"><span class="pre">k</span></code>, unit/jobs, or
a full-screen item view of a cage or suchlike.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedItem([silent])</span></code></p>
<p>Returns the item selected via <code class="kbd docutils literal"><span class="pre">v</span></code> -&gt;inventory, <code class="kbd docutils literal"><span class="pre">k</span></code>, <code class="kbd docutils literal"><span class="pre">t</span></code>, or
a full-screen item view of a container. Note that in the
last case, the highlighted <em>contained item</em> is returned, not
the container itself.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedBuilding([silent])</span></code></p>
<p>Returns the building selected via <code class="kbd docutils literal"><span class="pre">q</span></code>, <code class="kbd docutils literal"><span class="pre">t</span></code>, <code class="kbd docutils literal"><span class="pre">k</span></code> or <code class="kbd docutils literal"><span class="pre">i</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getSelectedPlant([silent])</span></code></p>
<p>Returns the plant selected via <code class="kbd docutils literal"><span class="pre">k</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getAnyUnit(screen)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getAnyItem(screen)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getAnyBuilding(screen)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getAnyPlant(screen)</span></code></p>
<p>Similar to the corresponding <code class="docutils literal"><span class="pre">getSelected</span></code> functions, but operate on the
screen given instead of the current screen and always return <code class="docutils literal"><span class="pre">nil</span></code> silently
on failure.</p>
</li>
</ul>
</div>
<div class="section" id="fortress-mode">
<h5><a class="toc-backref" href="#id89">Fortress mode</a><a class="headerlink" href="#fortress-mode" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getDwarfmodeViewDims()</span></code></p>
<p>Returns dimensions of the main fortress mode screen. See <code class="docutils literal"><span class="pre">getPanelLayout()</span></code>
in the <code class="docutils literal"><span class="pre">gui.dwarfmode</span></code> module for a more Lua-friendly version.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.resetDwarfmodeView([pause])</span></code></p>
<p>Resets the fortress mode sidebar menus and cursors to their default state. If
<code class="docutils literal"><span class="pre">pause</span></code> is true, also pauses the game.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.revealInDwarfmodeMap(pos)</span></code></p>
<p>Centers the view on the given position, which can be a <code class="docutils literal"><span class="pre">df.coord</span></code> instance
or a table assignable to a <code class="docutils literal"><span class="pre">df.coord</span></code> (see <a class="reference internal" href="#lua-api-table-assignment"><span class="std std-ref">Recursive table assignment</span></a>),
e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">}</span>
<span class="n">getSelectedUnit</span><span class="p">()</span><span class="o">.</span><span class="n">pos</span>
<span class="n">xyz2pos</span><span class="p">(</span><span class="n">pos2xyz</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="k">global</span><span class="o">.</span><span class="n">cursor</span><span class="p">))</span>
</pre></div>
</div>
<p>Returns false if unsuccessful.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.refreshSidebar()</span></code></p>
<p>Refreshes the fortress mode sidebar. This can be useful when making changes to
the map, for example, because DF only updates the sidebar when the cursor
position changes.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.inRenameBuilding()</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">true</span></code> if a building is being renamed.</p>
</li>
</ul>
</div>
<div class="section" id="announcements">
<h5><a class="toc-backref" href="#id90">Announcements</a><a class="headerlink" href="#announcements" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.writeToGamelog(text)</span></code></p>
<p>Writes a string to <code class="file docutils literal"><span class="pre">gamelog.txt</span></code> without doing an announcement.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.makeAnnouncement(type,flags,pos,text,color[,is_bright])</span></code></p>
<p>Adds an announcement with given announcement_type, text, color, and brightness.
The is_bright boolean actually seems to invert the brightness.</p>
<p>The announcement is written to <code class="file docutils literal"><span class="pre">gamelog.txt</span></code>. The announcement_flags
argument provides a custom set of <code class="file docutils literal"><span class="pre">announcements.txt</span></code> options,
which specify if the message should actually be displayed in the
announcement list, and whether to recenter or show a popup.</p>
<p>Returns the index of the new announcement in <code class="docutils literal"><span class="pre">df.global.world.status.reports</span></code>, or -1.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.addCombatReport(unit,slot,report_index)</span></code></p>
<p>Adds the report with the given index (returned by makeAnnouncement)
to the specified group of the given unit. Returns <em>true</em> on success.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.addCombatReportAuto(unit,flags,report_index)</span></code></p>
<p>Adds the report with the given index to the appropriate group(s)
of the given unit, as requested by the flags.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.showAnnouncement(text,color[,is_bright])</span></code></p>
<p>Adds a regular announcement with given text, color, and brightness.
The is_bright boolean actually seems to invert the brightness.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.showZoomAnnouncement(type,pos,text,color[,is_bright])</span></code></p>
<p>Like above, but also specifies a position you can zoom to from the announcement menu.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.showPopupAnnouncement(text,color[,is_bright])</span></code></p>
<p>Pops up a titan-style modal announcement window.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.showAutoAnnouncement(type,pos,text,color[,is_bright,unit1,unit2])</span></code></p>
<p>Uses the type to look up options from announcements.txt, and calls the above
operations accordingly. The units are used to call <code class="docutils literal"><span class="pre">addCombatReportAuto</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="other">
<h5><a class="toc-backref" href="#id91">Other</a><a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.gui.getDepthAt(x,</span> <span class="pre">y)</span></code></p>
<p>Returns the distance from the z-level of the tile at map coordinates (x, y) to
the closest ground z-level below. Defaults to 0, unless overriden by plugins.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="job-module">
<h4><a class="toc-backref" href="#id92">Job module</a><a class="headerlink" href="#job-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.cloneJobStruct(job)</span></code></p>
<p>Creates a deep copy of the given job.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.printJobDetails(job)</span></code></p>
<p>Prints info about the job.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.printItemDetails(jobitem,idx)</span></code></p>
<p>Prints info about the job item.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.getGeneralRef(job,</span> <span class="pre">type)</span></code></p>
<p>Searches for a general_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.getSpecificRef(job,</span> <span class="pre">type)</span></code></p>
<p>Searches for a specific_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.getHolder(job)</span></code></p>
<p>Returns the building holding the job.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.getWorker(job)</span></code></p>
<p>Returns the unit performing the job.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.setJobCooldown(building,worker,timeout)</span></code></p>
<p>Prevent the worker from taking jobs at the specified workshop for the specified time.
This doesn’t decrease the timeout in any circumstances.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.removeWorker(job,timeout)</span></code></p>
<p>Removes the worker from the specified workshop job, and sets the cooldown.
Returns <em>true</em> on success.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.checkBuildingsNow()</span></code></p>
<p>Instructs the game to check buildings for jobs next frame and assign workers.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.checkDesignationsNow()</span></code></p>
<p>Instructs the game to check designations for jobs next frame and assign workers.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.is_equal(job1,job2)</span></code></p>
<p>Compares important fields in the job and nested item structures.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.is_item_equal(job_item1,job_item2)</span></code></p>
<p>Compares important fields in the job item structures.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.linkIntoWorld(job,new_id)</span></code></p>
<p>Adds job into <code class="docutils literal"><span class="pre">df.global.job_list</span></code>, and if new_id
is true, then also sets its id and increases
<code class="docutils literal"><span class="pre">df.global.job_next_id</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.listNewlyCreated(first_id)</span></code></p>
<p>Returns the current value of <code class="docutils literal"><span class="pre">df.global.job_next_id</span></code>, and
if there are any jobs with <code class="docutils literal"><span class="pre">first_id</span> <span class="pre">&lt;=</span> <span class="pre">id</span> <span class="pre">&lt;</span> <span class="pre">job_next_id</span></code>,
a lua list containing them.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.isSuitableItem(job_item,</span> <span class="pre">item_type,</span> <span class="pre">item_subtype)</span></code></p>
<p>Does basic sanity checks to verify if the suggested item type matches
the flags in the job item.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.isSuitableMaterial(job_item,</span> <span class="pre">mat_type,</span> <span class="pre">mat_index)</span></code></p>
<p>Likewise, if replacing material.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.job.getName(job)</span></code></p>
<p>Returns the job’s description, as seen in the Units and Jobs screens.</p>
</li>
</ul>
</div>
<div class="section" id="units-module">
<h4><a class="toc-backref" href="#id93">Units module</a><a class="headerlink" href="#units-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getPosition(unit)</span></code></p>
<p>Returns true <em>x,y,z</em> of the unit, or <em>nil</em> if invalid; may be not equal to unit.pos if caged.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.getUnitsInBox(x1,y1,z1,x2,y2,z2[,filter])</span></code></p>
<p>Returns a table of all units within the specified coordinates. If the <code class="docutils literal"><span class="pre">filter</span></code>
argument is given, only units where <code class="docutils literal"><span class="pre">filter(unit)</span></code> returns true will be included.
Note that <code class="docutils literal"><span class="pre">pos2xyz()</span></code> cannot currently be used to convert coordinate objects to
the arguments required by this function.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getGeneralRef(unit,</span> <span class="pre">type)</span></code></p>
<p>Searches for a general_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getSpecificRef(unit,</span> <span class="pre">type)</span></code></p>
<p>Searches for a specific_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getContainer(unit)</span></code></p>
<p>Returns the container (cage) item or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.setNickname(unit,nick)</span></code></p>
<p>Sets the unit’s nickname properly.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getVisibleName(unit)</span></code></p>
<p>Returns the language_name object visible in game, accounting for false identities.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getIdentity(unit)</span></code></p>
<p>Returns the false identity of the unit if it has one, or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getNemesis(unit)</span></code></p>
<p>Returns the nemesis record of the unit if it has one, or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isHidingCurse(unit)</span></code></p>
<p>Checks if the unit hides improved attributes from its curse.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getPhysicalAttrValue(unit,</span> <span class="pre">attr_type)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getMentalAttrValue(unit,</span> <span class="pre">attr_type)</span></code></p>
<p>Computes the effective attribute value, including curse effect.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isCrazed(unit)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isOpposedToLife(unit)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.hasExtravision(unit)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isBloodsucker(unit)</span></code></p>
<p>Simple checks of caste attributes that can be modified by curses.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getMiscTrait(unit,</span> <span class="pre">type[,</span> <span class="pre">create])</span></code></p>
<p>Finds (or creates if requested) a misc trait object with the given id.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isActive(unit)</span></code></p>
<p>The unit is active (alive and on the map).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isAlive(unit)</span></code></p>
<p>The unit isn’t dead or undead.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isDead(unit)</span></code></p>
<p>The unit is completely dead and passive, or a ghost. Equivalent to
<code class="docutils literal"><span class="pre">dfhack.units.isKilled(unit)</span> <span class="pre">or</span> <span class="pre">dfhack.units.isGhost(unit)</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isKilled(unit)</span></code></p>
<p>The unit has been killed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isGhost(unit)</span></code></p>
<p>The unit is a ghost.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isSane(unit)</span></code></p>
<p>The unit is capable of rational action, i.e. not dead, insane, zombie, or active werewolf.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isDwarf(unit)</span></code></p>
<p>The unit is of the correct race of the fortress.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isCitizen(unit)</span></code></p>
<p>The unit is an alive sane citizen of the fortress; wraps the
same checks the game uses to decide game-over by extinction.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.isVisible(unit)</span></code></p>
<p>The unit is visible on the map.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getAge(unit[,true_age])</span></code></p>
<p>Returns the age of the unit in years as a floating-point value.
If <code class="docutils literal"><span class="pre">true_age</span></code> is true, ignores false identities.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getNominalSkill(unit,</span> <span class="pre">skill[,</span> <span class="pre">use_rust])</span></code></p>
<p>Retrieves the nominal skill level for the given unit. If <code class="docutils literal"><span class="pre">use_rust</span></code>
is <em>true</em>, subtracts the rust penalty.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getEffectiveSkill(unit,</span> <span class="pre">skill)</span></code></p>
<p>Computes the effective rating for the given skill, taking into account exhaustion, pain etc.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getExperience(unit,</span> <span class="pre">skill[,</span> <span class="pre">total])</span></code></p>
<p>Returns the experience value for the given skill. If <code class="docutils literal"><span class="pre">total</span></code> is true, adds experience implied by the current rating.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.computeMovementSpeed(unit)</span></code></p>
<p>Computes number of frames * 100 it takes the unit to move in its current state of mind and body.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.computeSlowdownFactor(unit)</span></code></p>
<p>Meandering and floundering in liquid introduces additional slowdown. It is
random, but the function computes and returns the expected mean factor as a float.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getNoblePositions(unit)</span></code></p>
<p>Returns a list of tables describing noble position assignments, or <em>nil</em>.
Every table has fields <code class="docutils literal"><span class="pre">entity</span></code>, <code class="docutils literal"><span class="pre">assignment</span></code> and <code class="docutils literal"><span class="pre">position</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getProfessionName(unit[,ignore_noble,plural])</span></code></p>
<p>Retrieves the profession name using custom profession, noble assignments
or raws. The <code class="docutils literal"><span class="pre">ignore_noble</span></code> boolean disables the use of noble positions.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getCasteProfessionName(race,caste,prof_id[,plural])</span></code></p>
<p>Retrieves the profession name for the given race/caste using raws.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getProfessionColor(unit[,ignore_noble])</span></code></p>
<p>Retrieves the color associated with the profession, using noble assignments
or raws. The <code class="docutils literal"><span class="pre">ignore_noble</span></code> boolean disables the use of noble positions.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getCasteProfessionColor(race,caste,prof_id)</span></code></p>
<p>Retrieves the profession color for the given race/caste using raws.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getStressCategory(unit)</span></code></p>
<p>Returns a number from 0-6 indicating stress. 0 is most stressed; 6 is least.
Note that 0 is guaranteed to remain the most stressed but 6 could change in the future.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getStressCategoryRaw(stress_level)</span></code></p>
<p>Identical to <code class="docutils literal"><span class="pre">getStressCategory</span></code> but takes a raw stress level instead of a unit.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.units.getStressCutoffs()</span></code></p>
<p>Returns a table of the cutoffs used by the above stress level functions.</p>
</li>
</ul>
</div>
<div class="section" id="items-module">
<h4><a class="toc-backref" href="#id94">Items module</a><a class="headerlink" href="#items-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getPosition(item)</span></code></p>
<p>Returns true <em>x,y,z</em> of the item, or <em>nil</em> if invalid; may be not equal to item.pos if in inventory.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getDescription(item,</span> <span class="pre">type[,</span> <span class="pre">decorate])</span></code></p>
<p>Returns the string description of the item, as produced by the <code class="docutils literal"><span class="pre">getItemDescription</span></code>
method. If decorate is true, also adds markings for quality and improvements.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getGeneralRef(item,</span> <span class="pre">type)</span></code></p>
<p>Searches for a general_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getSpecificRef(item,</span> <span class="pre">type)</span></code></p>
<p>Searches for a specific_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getOwner(item)</span></code></p>
<p>Returns the owner unit or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.setOwner(item,unit)</span></code></p>
<p>Replaces the owner of the item. If unit is <em>nil</em>, removes ownership.
Returns <em>false</em> in case of error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getContainer(item)</span></code></p>
<p>Returns the container item or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getContainedItems(item)</span></code></p>
<p>Returns a list of items contained in this one.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getHolderBuilding(item)</span></code></p>
<p>Returns the holder building or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getHolderUnit(item)</span></code></p>
<p>Returns the holder unit or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.moveToGround(item,pos)</span></code></p>
<p>Move the item to the ground at position. Returns <em>false</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.moveToContainer(item,container)</span></code></p>
<p>Move the item to the container. Returns <em>false</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.moveToBuilding(item,building[,use_mode[,force_in_building])</span></code></p>
<p>Move the item to the building. Returns <em>false</em> if impossible.</p>
<p><code class="docutils literal"><span class="pre">use_mode</span></code> defaults to 0. If set to 2, the item will be treated as part of the building.</p>
<p>If <code class="docutils literal"><span class="pre">force_in_building</span></code> is true, the item will be considered to be stored by the building
(used for items temporarily used in traps in vanilla DF)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.moveToInventory(item,unit,use_mode,body_part)</span></code></p>
<p>Move the item to the unit inventory. Returns <em>false</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.remove(item[,</span> <span class="pre">no_uncat])</span></code></p>
<p>Removes the item, and marks it for garbage collection unless <code class="docutils literal"><span class="pre">no_uncat</span></code> is true.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.makeProjectile(item)</span></code></p>
<p>Turns the item into a projectile, and returns the new object, or <em>nil</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.isCasteMaterial(item_type)</span></code></p>
<p>Returns <em>true</em> if this item type uses a creature/caste pair as its material.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getSubtypeCount(item_type)</span></code></p>
<p>Returns the number of raw-defined subtypes of the given item type, or <em>-1</em> if not applicable.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getSubtypeDef(item_type,</span> <span class="pre">subtype)</span></code></p>
<p>Returns the raw definition for the given item type and subtype, or <em>nil</em> if invalid.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getItemBaseValue(item_type,</span> <span class="pre">subtype,</span> <span class="pre">material,</span> <span class="pre">mat_index)</span></code></p>
<p>Calculates the base value for an item of the specified type and material.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.getValue(item)</span></code></p>
<p>Calculates the Basic Value of an item, as seen in the View Item screen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.createItem(item_type,</span> <span class="pre">item_subtype,</span> <span class="pre">mat_type,</span> <span class="pre">mat_index,</span> <span class="pre">unit)</span></code></p>
<p>Creates an item, similar to the <a class="reference internal" href="Plugins.html#createitem"><span class="std std-ref">createitem</span></a> plugin.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.checkMandates(item)</span></code></p>
<p>Returns true if the item is free from mandates, or false if mandates prevent trading the item.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.canTrade(item)</span></code></p>
<p>Checks whether the item can be traded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.canTradeWithContents(item)</span></code></p>
<p>Checks whether the item and all items it contains, if any, can be traded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.isRouteVehicle(item)</span></code></p>
<p>Checks whether the item is an assigned hauling vehicle.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.items.isSquadEquipment(item)</span></code></p>
<p>Checks whether the item is assigned to a squad.</p>
</li>
</ul>
</div>
<div class="section" id="maps-module">
<h4><a class="toc-backref" href="#id95">Maps module</a><a class="headerlink" href="#maps-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getSize()</span></code></p>
<p>Returns map size in blocks: <em>x, y, z</em></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileSize()</span></code></p>
<p>Returns map size in tiles: <em>x, y, z</em></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getBlock(x,y,z)</span></code></p>
<p>Returns a map block object for given x,y,z in local block coordinates.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.isValidTilePos(coords)</span></code>, or <code class="docutils literal"><span class="pre">isValidTilePos(x,y,z)</span></code></p>
<p>Checks if the given df::coord or x,y,z in local tile coordinates are valid.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.isTileVisible(coords)</span></code>, or <code class="docutils literal"><span class="pre">isTileVisible(x,y,z)</span></code></p>
<p>Checks if the given df::coord or x,y,z in local tile coordinates is visible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileBlock(coords)</span></code>, or <code class="docutils literal"><span class="pre">getTileBlock(x,y,z)</span></code></p>
<p>Returns a map block object for given df::coord or x,y,z in local tile coordinates.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.ensureTileBlock(coords)</span></code>, or <code class="docutils literal"><span class="pre">ensureTileBlock(x,y,z)</span></code></p>
<p>Like <code class="docutils literal"><span class="pre">getTileBlock</span></code>, but if the block is not allocated, try creating it.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileType(coords)</span></code>, or <code class="docutils literal"><span class="pre">getTileType(x,y,z)</span></code></p>
<p>Returns the tile type at the given coordinates, or <em>nil</em> if invalid.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileFlags(coords)</span></code>, or <code class="docutils literal"><span class="pre">getTileFlags(x,y,z)</span></code></p>
<p>Returns designation and occupancy references for the given coordinates, or <em>nil, nil</em> if invalid.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getRegionBiome(region_coord2d)</span></code>, or <code class="docutils literal"><span class="pre">getRegionBiome(x,y)</span></code></p>
<p>Returns the biome info struct for the given global map region.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.enableBlockUpdates(block[,flow,temperature])</span></code></p>
<p>Enables updates for liquid flow or temperature, unless already active.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.spawnFlow(pos,type,mat_type,mat_index,dimension)</span></code></p>
<p>Spawns a new flow (i.e. steam/mist/dust/etc) at the given pos, and with
the given parameters. Returns it, or <em>nil</em> if unsuccessful.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getGlobalInitFeature(index)</span></code></p>
<p>Returns the global feature object with the given index.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getLocalInitFeature(region_coord2d,index)</span></code></p>
<p>Returns the local feature object with the given region coords and index.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileBiomeRgn(coords)</span></code>, or <code class="docutils literal"><span class="pre">getTileBiomeRgn(x,y,z)</span></code></p>
<p>Returns <em>x, y</em> for use with <code class="docutils literal"><span class="pre">getRegionBiome</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.canWalkBetween(pos1,</span> <span class="pre">pos2)</span></code></p>
<p>Checks if a dwarf may be able to walk between the two tiles,
using a pathfinding cache maintained by the game.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This cache is only updated when the game is unpaused, and thus
can get out of date if doors are forbidden or unforbidden, or
tools like <a class="reference internal" href="Plugins.html#liquids"><span class="std std-ref">liquids</span></a> or <a class="reference internal" href="Plugins.html#tiletypes"><span class="std std-ref">tiletypes</span></a> are used. It also cannot possibly
take into account anything that depends on the actual units, like
burrows, or the presence of invaders.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.hasTileAssignment(tilemask)</span></code></p>
<p>Checks if the tile_bitmask object is not <em>nil</em> and contains any set bits; returns <em>true</em> or <em>false</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.getTileAssignment(tilemask,x,y)</span></code></p>
<p>Checks if the tile_bitmask object is not <em>nil</em> and has the relevant bit set; returns <em>true</em> or <em>false</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.setTileAssignment(tilemask,x,y,enable)</span></code></p>
<p>Sets the relevant bit in the tile_bitmask object to the <em>enable</em> argument.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.maps.resetTileAssignment(tilemask[,enable])</span></code></p>
<p>Sets all bits in the mask to the <em>enable</em> argument.</p>
</li>
</ul>
</div>
<div class="section" id="burrows-module">
<h4><a class="toc-backref" href="#id96">Burrows module</a><a class="headerlink" href="#burrows-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.findByName(name)</span></code></p>
<p>Returns the burrow pointer or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.clearUnits(burrow)</span></code></p>
<p>Removes all units from the burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.isAssignedUnit(burrow,unit)</span></code></p>
<p>Checks if the unit is in the burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.setAssignedUnit(burrow,unit,enable)</span></code></p>
<p>Adds or removes the unit from the burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.clearTiles(burrow)</span></code></p>
<p>Removes all tiles from the burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.listBlocks(burrow)</span></code></p>
<p>Returns a table of map block pointers.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.isAssignedTile(burrow,tile_coord)</span></code></p>
<p>Checks if the tile is in burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.setAssignedTile(burrow,tile_coord,enable)</span></code></p>
<p>Adds or removes the tile from the burrow. Returns <em>false</em> if invalid coords.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.isAssignedBlockTile(burrow,block,x,y)</span></code></p>
<p>Checks if the tile within the block is in burrow.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.burrows.setAssignedBlockTile(burrow,block,x,y,enable)</span></code></p>
<p>Adds or removes the tile from the burrow. Returns <em>false</em> if invalid coords.</p>
</li>
</ul>
</div>
<div class="section" id="buildings-module">
<h4><a class="toc-backref" href="#id97">Buildings module</a><a class="headerlink" href="#buildings-module" title="Permalink to this headline">¶</a></h4>
<div class="section" id="general">
<h5><a class="toc-backref" href="#id98">General</a><a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getGeneralRef(building,</span> <span class="pre">type)</span></code></p>
<p>Searches for a general_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getSpecificRef(building,</span> <span class="pre">type)</span></code></p>
<p>Searches for a specific_ref with the given type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.setOwner(item,unit)</span></code></p>
<p>Replaces the owner of the building. If unit is <em>nil</em>, removes ownership.
Returns <em>false</em> in case of error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getSize(building)</span></code></p>
<p>Returns <em>width, height, centerx, centery</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.findAtTile(pos)</span></code>, or <code class="docutils literal"><span class="pre">findAtTile(x,y,z)</span></code></p>
<p>Scans the buildings for the one located at the given tile.
Does not work on civzones. Warning: linear scan if the map
tile indicates there are buildings at it.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.findCivzonesAt(pos)</span></code>, or <code class="docutils literal"><span class="pre">findCivzonesAt(x,y,z)</span></code></p>
<p>Scans civzones, and returns a lua sequence of those that touch
the given tile, or <em>nil</em> if none.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getCorrectSize(width,</span> <span class="pre">height,</span> <span class="pre">type,</span> <span class="pre">subtype,</span> <span class="pre">custom,</span> <span class="pre">direction)</span></code></p>
<p>Computes correct dimensions for the specified building type and orientation,
using width and height for flexible dimensions.
Returns <em>is_flexible, width, height, center_x, center_y</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.checkFreeTiles(pos,size[,extents,change_extents,allow_occupied])</span></code></p>
<p>Checks if the rectangle defined by <code class="docutils literal"><span class="pre">pos</span></code> and <code class="docutils literal"><span class="pre">size</span></code>, and possibly extents,
can be used for placing a building. If <code class="docutils literal"><span class="pre">change_extents</span></code> is true, bad tiles
are removed from extents. If <code class="docutils literal"><span class="pre">allow_occupied</span></code>, the occupancy test is skipped.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.countExtentTiles(extents,defval)</span></code></p>
<p>Returns the number of tiles included by extents, or defval.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.containsTile(building,</span> <span class="pre">x,</span> <span class="pre">y[,</span> <span class="pre">room])</span></code></p>
<p>Checks if the building contains the specified tile, either directly, or as room.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.hasSupport(pos,size)</span></code></p>
<p>Checks if a bridge constructed at specified position would have
support from terrain, and thus won’t collapse if retracted.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getStockpileContents(stockpile)</span></code></p>
<p>Returns a list of items stored on the given stockpile.
Ignores empty bins, barrels, and wheelbarrows assigned as storage and transport for that stockpile.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getCageOccupants(cage)</span></code></p>
<p>Returns a list of units in the given built cage. Note that this is different
from the list of units assigned to the cage, which can be accessed with
<code class="docutils literal"><span class="pre">cage.assigned_units</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="low-level">
<h5><a class="toc-backref" href="#id99">Low-level</a><a class="headerlink" href="#low-level" title="Permalink to this headline">¶</a></h5>
<p>Low-level building creation functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.allocInstance(pos,</span> <span class="pre">type,</span> <span class="pre">subtype,</span> <span class="pre">custom)</span></code></p>
<p>Creates a new building instance of given type, subtype and custom type,
at specified position. Returns the object, or <em>nil</em> in case of an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.setSize(building,</span> <span class="pre">width,</span> <span class="pre">height,</span> <span class="pre">direction)</span></code></p>
<p>Configures an object returned by <code class="docutils literal"><span class="pre">allocInstance</span></code>, using specified
parameters wherever appropriate. If the building has fixed size along
any dimension, the corresponding input parameter will be ignored.
Returns <em>false</em> if the building cannot be placed, or <em>true, width,
height, rect_area, true_area</em>. Returned width and height are the
final values used by the building; true_area is less than rect_area
if any tiles were removed from designation.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.constructAbstract(building)</span></code></p>
<p>Links a fully configured object created by <code class="docutils literal"><span class="pre">allocInstance</span></code> into the
world. The object must be an abstract building, i.e. a stockpile or civzone.
Returns <em>true</em>, or <em>false</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.constructWithItems(building,</span> <span class="pre">items)</span></code></p>
<p>Links a fully configured object created by <code class="docutils literal"><span class="pre">allocInstance</span></code> into the
world for construction, using a list of specific items as material.
Returns <em>true</em>, or <em>false</em> if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.constructWithFilters(building,</span> <span class="pre">job_items)</span></code></p>
<p>Links a fully configured object created by <code class="docutils literal"><span class="pre">allocInstance</span></code> into the
world for construction, using a list of job_item filters as inputs.
Returns <em>true</em>, or <em>false</em> if impossible. Filter objects are claimed
and possibly destroyed in any case.
Use a negative <code class="docutils literal"><span class="pre">quantity</span></code> field value to auto-compute the amount
from the size of the building.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.deconstruct(building)</span></code></p>
<p>Destroys the building, or queues a deconstruction job.
Returns <em>true</em> if the building was destroyed and deallocated immediately.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.markedForRemoval(building)</span></code></p>
<p>Returns <em>true</em> if the building is marked for removal (with <code class="kbd docutils literal"><span class="pre">x</span></code>), <em>false</em>
otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getRoomDescription(building[,</span> <span class="pre">unit])</span></code></p>
<p>If the building is a room, returns a description including quality modifiers, e.g. “Royal Bedroom”.
Otherwise, returns an empty string.</p>
<p>The unit argument is passed through to DF and may modify the room’s value depending on the unit given.</p>
</li>
</ul>
</div>
<div class="section" id="high-level">
<h5><a class="toc-backref" href="#id100">High-level</a><a class="headerlink" href="#high-level" title="Permalink to this headline">¶</a></h5>
<p>More high-level functions are implemented in lua and can be loaded by
<code class="docutils literal"><span class="pre">require('dfhack.buildings')</span></code>. See <code class="docutils literal"><span class="pre">hack/lua/dfhack/buildings.lua</span></code>.</p>
<p>Among them are:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.getFiltersByType(argtable,type,subtype,custom)</span></code></p>
<p>Returns a sequence of lua structures, describing input item filters
suitable for the specified building type, or <em>nil</em> if unknown or invalid.
The returned sequence is suitable for use as the <code class="docutils literal"><span class="pre">job_items</span></code> argument
of <code class="docutils literal"><span class="pre">constructWithFilters</span></code>.
Uses tables defined in <code class="docutils literal"><span class="pre">buildings.lua</span></code>.</p>
<p>Argtable members <code class="docutils literal"><span class="pre">material</span></code> (the default name), <code class="docutils literal"><span class="pre">bucket</span></code>, <code class="docutils literal"><span class="pre">barrel</span></code>,
<code class="docutils literal"><span class="pre">chain</span></code>, <code class="docutils literal"><span class="pre">mechanism</span></code>, <code class="docutils literal"><span class="pre">screw</span></code>, <code class="docutils literal"><span class="pre">pipe</span></code>, <code class="docutils literal"><span class="pre">anvil</span></code>, <code class="docutils literal"><span class="pre">weapon</span></code> are used to
augment the basic attributes with more detailed information if the
building has input items with the matching name (see the tables for naming details).
Note that it is impossible to <em>override</em> any properties this way, only supply those that
are not mentioned otherwise; one exception is that flags2.non_economic
is automatically cleared if an explicit material is specified.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.buildings.constructBuilding{...}</span></code></p>
<p>Creates a building in one call, using options contained
in the argument table. Returns the building, or <em>nil, error</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Despite the name, unless the building is abstract,
the function creates it in an ‘unconstructed’ stage, with
a queued in-game job that will actually construct it. I.e.
the function replicates programmatically what can be done
through the construct building menu in the game ui, except
that it does less environment constraint checking.</p>
</div>
<p>The following options can be used:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">pos</span> <span class="pre">=</span> <span class="pre">coordinates</span></code>, or <code class="docutils literal"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">z</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>Mandatory. Specifies the left upper corner of the building.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">type</span> <span class="pre">=</span> <span class="pre">df.building_type.FOO,</span> <span class="pre">subtype</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">custom</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>Mandatory. Specifies the type of the building. Obviously, subtype
and custom are only expected if the type requires them.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">fields</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>Initializes fields of the building object after creation with <code class="docutils literal"><span class="pre">df.assign</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">width</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">height</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">direction</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>Sets size and orientation of the building. If it is
fixed-size, specified dimensions are ignored.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">full_rectangle</span> <span class="pre">=</span> <span class="pre">true</span></code></p>
<p>For buildings like stockpiles or farm plots that can normally
accomodate individual tile exclusion, forces an error if any
tiles within the specified width*height are obstructed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">items</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">item,</span> <span class="pre">item</span> <span class="pre">...</span> <span class="pre">}</span></code>, or <code class="docutils literal"><span class="pre">filters</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">{...},</span> <span class="pre">{...}...</span> <span class="pre">}</span></code></p>
<p>Specifies explicit items or item filters to use in construction.
It is the job of the user to ensure they are correct for the building type.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">abstract</span> <span class="pre">=</span> <span class="pre">true</span></code></p>
<p>Specifies that the building is abstract and does not require construction.
Required for stockpiles and civzones; an error otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">material</span> <span class="pre">=</span> <span class="pre">{...},</span> <span class="pre">mechanism</span> <span class="pre">=</span> <span class="pre">{...},</span> <span class="pre">...</span></code></p>
<p>If none of <code class="docutils literal"><span class="pre">items</span></code>, <code class="docutils literal"><span class="pre">filter</span></code>, or <code class="docutils literal"><span class="pre">abstract</span></code> is used,
the function uses <code class="docutils literal"><span class="pre">getFiltersByType</span></code> to compute the input
item filters, and passes the argument table through. If no filters
can be determined this way, <code class="docutils literal"><span class="pre">constructBuilding</span></code> throws an error.</p>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="constructions-module">
<h4><a class="toc-backref" href="#id101">Constructions module</a><a class="headerlink" href="#constructions-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.constructions.designateNew(pos,type,item_type,mat_index)</span></code></p>
<p>Designates a new construction at given position. If there already is
a planned but not completed construction there, changes its type.
Returns <em>true</em>, or <em>false</em> if obstructed.
Note that designated constructions are technically buildings.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.constructions.designateRemove(pos)</span></code>, or <code class="docutils literal"><span class="pre">designateRemove(x,y,z)</span></code></p>
<p>If there is a construction or a planned construction at the specified
coordinates, designates it for removal, or instantly cancels the planned one.
Returns <em>true, was_only_planned</em> if removed; or <em>false</em> if none found.</p>
</li>
</ul>
</div>
<div class="section" id="kitchen-module">
<h4><a class="toc-backref" href="#id102">Kitchen module</a><a class="headerlink" href="#kitchen-module" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.kitchen.findExclusion(type,</span> <span class="pre">item_type,</span> <span class="pre">item_subtype,</span> <span class="pre">mat_type,</span> <span class="pre">mat_index)</span></code></p>
<p>Finds a kitchen exclusion in the vectors in <code class="docutils literal"><span class="pre">df.global.ui.kitchen</span></code>. Returns
-1 if not found.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">type</span></code> is a <code class="docutils literal"><span class="pre">df.kitchen_exc_type</span></code>, i.e. <code class="docutils literal"><span class="pre">df.kitchen_exc_type.Cook</span></code> or
<code class="docutils literal"><span class="pre">df.kitchen_exc_type.Brew</span></code>.</li>
<li><code class="docutils literal"><span class="pre">item_type</span></code> is a <code class="docutils literal"><span class="pre">df.item_type</span></code></li>
<li><code class="docutils literal"><span class="pre">item_subtype</span></code>, <code class="docutils literal"><span class="pre">mat_type</span></code>, and <code class="docutils literal"><span class="pre">mat_index</span></code> are all numeric</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.kitchen.addExclusion(type,</span> <span class="pre">item_type,</span> <span class="pre">item_subtype,</span> <span class="pre">mat_type,</span> <span class="pre">mat_index)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.kitchen.removeExclusion(type,</span> <span class="pre">item_type,</span> <span class="pre">item_subtype,</span> <span class="pre">mat_type,</span> <span class="pre">mat_index)</span></code></p>
<p>Adds or removes a kitchen exclusion, using the same parameters as
<code class="docutils literal"><span class="pre">findExclusion</span></code>. Both return <code class="docutils literal"><span class="pre">true</span></code> on success and <code class="docutils literal"><span class="pre">false</span></code> on failure,
e.g. when adding an exclusion that already exists or removing one that does
not.</p>
</li>
</ul>
</div>
<div class="section" id="screen-api">
<h4><a class="toc-backref" href="#id103">Screen API</a><a class="headerlink" href="#screen-api" title="Permalink to this headline">¶</a></h4>
<p>The screen module implements support for drawing to the tiled screen of the game.
Note that drawing only has any effect when done from callbacks, so it can only
be feasibly used in the core context.</p>
<p>Basic painting functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.getWindowSize()</span></code></p>
<p>Returns <em>width, height</em> of the screen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.getMousePos()</span></code></p>
<p>Returns <em>x,y</em> of the tile the mouse is over.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.inGraphicsMode()</span></code></p>
<p>Checks if [GRAPHICS:YES] was specified in init.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.paintTile(pen,x,y[,char,tile,map])</span></code></p>
<p>Paints a tile using given parameters. See below for a description of pen.</p>
<p>Returns <em>false</em> if coordinates out of bounds, or other error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.readTile(x,y[,map])</span></code></p>
<p>Retrieves the contents of the specified tile from the screen buffers.
Returns a pen object, or <em>nil</em> if invalid or TrueType.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.paintString(pen,x,y,text[,map])</span></code></p>
<p>Paints the string starting at <em>x,y</em>. Uses the string characters
in sequence to override the <code class="docutils literal"><span class="pre">ch</span></code> field of pen.</p>
<p>Returns <em>true</em> if painting at least one character succeeded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.fillRect(pen,x1,y1,x2,y2[,map])</span></code></p>
<p>Fills the rectangle specified by the coordinates with the given pen.
Returns <em>true</em> if painting at least one character succeeded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.findGraphicsTile(pagename,x,y)</span></code></p>
<p>Finds a tile from a graphics set (i.e. the raws used for creatures),
if in graphics mode and loaded.</p>
<p>Returns: <em>tile, tile_grayscale</em>, or <em>nil</em> if not found.
The values can then be used for the <em>tile</em> field of <em>pen</em> structures.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.clear()</span></code></p>
<p>Fills the screen with blank background.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.invalidate()</span></code></p>
<p>Requests repaint of the screen by setting a flag. Unlike other
functions in this section, this may be used at any time.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.getKeyDisplay(key)</span></code></p>
<p>Returns the string that should be used to represent the given
logical keybinding on the screen in texts like “press Key to …”.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.keyToChar(key)</span></code></p>
<p>Returns the integer character code of the string input
character represented by the given logical keybinding,
or <em>nil</em> if not a string input key.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.charToKey(charcode)</span></code></p>
<p>Returns the keybinding representing the given string input
character, or <em>nil</em> if impossible.</p>
</li>
</ul>
<p>The “pen” argument used by functions above may be represented by
a table with the following possible fields:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="docutils literal"><span class="pre">ch</span></code></dt>
<dd>Provides the ordinary tile character, as either a 1-character string or a number.
Can be overridden with the <code class="docutils literal"><span class="pre">char</span></code> function parameter.</dd>
<dt><code class="docutils literal"><span class="pre">fg</span></code></dt>
<dd>Foreground color for the ordinary tile. Defaults to COLOR_GREY (7).</dd>
<dt><code class="docutils literal"><span class="pre">bg</span></code></dt>
<dd>Background color for the ordinary tile. Defaults to COLOR_BLACK (0).</dd>
<dt><code class="docutils literal"><span class="pre">bold</span></code></dt>
<dd>Bright/bold text flag. If <em>nil</em>, computed based on (fg &amp; 8); fg is masked to 3 bits.
Otherwise should be <em>true/false</em>.</dd>
<dt><code class="docutils literal"><span class="pre">tile</span></code></dt>
<dd>Graphical tile id. Ignored unless [GRAPHICS:YES] was in init.txt.</dd>
<dt><code class="docutils literal"><span class="pre">tile_color</span> <span class="pre">=</span> <span class="pre">true</span></code></dt>
<dd>Specifies that the tile should be shaded with <em>fg/bg</em>.</dd>
<dt><code class="docutils literal"><span class="pre">tile_fg,</span> <span class="pre">tile_bg</span></code></dt>
<dd>If specified, overrides <em>tile_color</em> and supplies shading colors directly.</dd>
</dl>
</div></blockquote>
<p>Alternatively, it may be a pre-parsed native object with the following API:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.pen.make(base[,pen_or_fg,bg,bold])</span></code></p>
<p>Creates a new pre-parsed pen by combining its arguments according to the
following rules:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal"><span class="pre">base</span></code> argument may be a pen object, a pen table as specified above,
or a single color value. In the single value case, it is split into
<code class="docutils literal"><span class="pre">fg</span></code> and <code class="docutils literal"><span class="pre">bold</span></code> properties, and others are initialized to 0.
This argument will be converted to a pre-parsed object and returned
if there are no other arguments.</li>
<li>If the <code class="docutils literal"><span class="pre">pen_or_fg</span></code> argument is specified as a table or object, it
completely replaces the base, and is returned instead of it.</li>
<li>Otherwise, the non-nil subset of the optional arguments is used
to update the <code class="docutils literal"><span class="pre">fg</span></code>, <code class="docutils literal"><span class="pre">bg</span></code> and <code class="docutils literal"><span class="pre">bold</span></code> properties of the base.
If the <code class="docutils literal"><span class="pre">bold</span></code> flag is <em>nil</em>, but <em>pen_or_fg</em> is a number, <code class="docutils literal"><span class="pre">bold</span></code>
is deduced from it like in the simple base case.</li>
</ol>
<p>This function always returns a new pre-parsed pen, or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.pen.parse(base[,pen_or_fg,bg,bold])</span></code></p>
<p>Exactly like the above function, but returns <code class="docutils literal"><span class="pre">base</span></code> or <code class="docutils literal"><span class="pre">pen_or_fg</span></code>
directly if they are already a pre-parsed native object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pen.property</span></code>, <code class="docutils literal"><span class="pre">pen.property</span> <span class="pre">=</span> <span class="pre">value</span></code>, <code class="docutils literal"><span class="pre">pairs(pen)</span></code></p>
<p>Pre-parsed pens support reading and setting their properties,
but don’t behave exactly like a simple table would; for instance,
assigning to <code class="docutils literal"><span class="pre">pen.tile_color</span></code> also resets <code class="docutils literal"><span class="pre">pen.tile_fg</span></code> and
<code class="docutils literal"><span class="pre">pen.tile_bg</span></code> to <em>nil</em>.</p>
</li>
</ul>
<p>In order to actually be able to paint to the screen, it is necessary
to create and register a viewscreen (basically a modal dialog) with
the game.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">As a matter of policy, in order to avoid user confusion, all
interface screens added by dfhack should bear the “DFHack” signature.</p>
</div>
<p>Screens are managed with the following functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.show(screen[,below])</span></code></p>
<p>Displays the given screen, possibly placing it below a different one.
The screen must not be already shown. Returns <em>true</em> if success.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.dismiss(screen[,to_first])</span></code></p>
<p>Marks the screen to be removed when the game enters its event loop.
If <code class="docutils literal"><span class="pre">to_first</span></code> is <em>true</em>, all screens up to the first one will be deleted.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.screen.isDismissed(screen)</span></code></p>
<p>Checks if the screen is already marked for removal.</p>
</li>
</ul>
<p>Apart from a native viewscreen object, these functions accept a table
as a screen. In this case, <code class="docutils literal"><span class="pre">show</span></code> creates a new native viewscreen
that delegates all processing to methods stored in that table.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lua-implemented screens are only supported in the core context.</p>
</div>
<p>Supported callbacks and fields are:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">screen._native</span></code></p>
<p>Initialized by <code class="docutils literal"><span class="pre">show</span></code> with a reference to the backing viewscreen
object, and removed again when the object is deleted.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onShow()</span></code></p>
<p>Called by <code class="docutils literal"><span class="pre">dfhack.screen.show</span></code> if successful.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onDismiss()</span></code></p>
<p>Called by <code class="docutils literal"><span class="pre">dfhack.screen.dismiss</span></code> if successful.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onDestroy()</span></code></p>
<p>Called from the destructor when the viewscreen is deleted.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onResize(w,</span> <span class="pre">h)</span></code></p>
<p>Called before <code class="docutils literal"><span class="pre">onRender</span></code> or <code class="docutils literal"><span class="pre">onIdle</span></code> when the window size has changed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onRender()</span></code></p>
<p>Called when the viewscreen should paint itself. This is the only context
where the above painting functions work correctly.</p>
<p>If omitted, the screen is cleared; otherwise it should do that itself.
In order to make a see-through dialog, call <code class="docutils literal"><span class="pre">self._native.parent:render()</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onIdle()</span></code></p>
<p>Called every frame when the screen is on top of the stack.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onHelp()</span></code></p>
<p>Called when the help keybinding is activated (usually ‘?’).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onInput(keys)</span></code></p>
<p>Called when keyboard or mouse events are available.
If any keys are pressed, the keys argument is a table mapping them to <em>true</em>.
Note that this refers to logical keybingings computed from real keys via
options; if multiple interpretations exist, the table will contain multiple keys.</p>
<p>The table also may contain special keys:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">_STRING</span></code></dt>
<dd><p class="first last">Maps to an integer in range 0-255. Duplicates a separate “STRING_A???” code for convenience.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">_MOUSE_L,</span> <span class="pre">_MOUSE_R</span></code></dt>
<dd><p class="first last">If the left or right mouse button is being pressed.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">_MOUSE_L_DOWN,</span> <span class="pre">_MOUSE_R_DOWN</span></code></dt>
<dd><p class="first last">If the left or right mouse button was just pressed.</p>
</dd>
</dl>
<p>If this method is omitted, the screen is dismissed on receival of the <code class="docutils literal"><span class="pre">LEAVESCREEN</span></code> key.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onGetSelectedUnit()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onGetSelectedItem()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onGetSelectedJob()</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">screen:onGetSelectedBuilding()</span></code></p>
<p>Implement these to provide a return value for the matching
<code class="docutils literal"><span class="pre">dfhack.gui.getSelected...</span></code> function.</p>
</li>
</ul>
</div>
<div class="section" id="penarray-class">
<h4><a class="toc-backref" href="#id104">PenArray class</a><a class="headerlink" href="#penarray-class" title="Permalink to this headline">¶</a></h4>
<p>Screens that require significant computation in their onRender() method can use
a <code class="docutils literal"><span class="pre">dfhack.penarray</span></code> instance to cache their output.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.penarray.new(w,</span> <span class="pre">h)</span></code></p>
<p>Creates a new penarray instance with an internal buffer of <code class="docutils literal"><span class="pre">w</span> <span class="pre">*</span> <span class="pre">h</span></code> tiles.
These dimensions currently cannot be changed after a penarray is instantiated.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">penarray:clear()</span></code></p>
<p>Clears the internal buffer, similar to <code class="docutils literal"><span class="pre">dfhack.screen.clear()</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">penarray:get_dims()</span></code></p>
<p>Returns the x and y dimensions of the internal buffer.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">penarray:get_tile(x,</span> <span class="pre">y)</span></code></p>
<p>Returns a pen corresponding to the tile at (<code class="docutils literal"><span class="pre">x</span></code>, <code class="docutils literal"><span class="pre">y</span></code>) in the internal buffer.
Note that indices are 0-based.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">penarray:set_tile(x,</span> <span class="pre">y,</span> <span class="pre">pen)</span></code></p>
<p>Sets the tile at (<code class="docutils literal"><span class="pre">x</span></code>, <code class="docutils literal"><span class="pre">y</span></code>) in the internal buffer to the pen given.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">penarray:draw(x,</span> <span class="pre">y,</span> <span class="pre">w,</span> <span class="pre">h,</span> <span class="pre">bufferx,</span> <span class="pre">buffery)</span></code></p>
<p>Draws the contents of the internal buffer, beginning at
(<code class="docutils literal"><span class="pre">bufferx</span></code>, <code class="docutils literal"><span class="pre">buffery</span></code>) and spanning <code class="docutils literal"><span class="pre">w</span></code> columns and <code class="docutils literal"><span class="pre">h</span></code> rows, to the
screen starting at (<code class="docutils literal"><span class="pre">x</span></code>, <code class="docutils literal"><span class="pre">y</span></code>). Any invalid screen and buffer coordinates
are skipped.</p>
<p><code class="docutils literal"><span class="pre">bufferx</span></code> and <code class="docutils literal"><span class="pre">buffery</span></code> default to 0.</p>
</li>
</ul>
</div>
<div class="section" id="filesystem-module">
<h4><a class="toc-backref" href="#id105">Filesystem module</a><a class="headerlink" href="#filesystem-module" title="Permalink to this headline">¶</a></h4>
<p>Most of these functions return <code class="docutils literal"><span class="pre">true</span></code> on success and <code class="docutils literal"><span class="pre">false</span></code> on failure,
unless otherwise noted.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.exists(path)</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">true</span></code> if <code class="docutils literal"><span class="pre">path</span></code> exists.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.isfile(path)</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">true</span></code> if <code class="docutils literal"><span class="pre">path</span></code> exists and is a file.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.isdir(path)</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">true</span></code> if <code class="docutils literal"><span class="pre">path</span></code> exists and is a directory.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.getcwd()</span></code></p>
<p>Returns the current working directory. To retrieve the DF path, use <code class="docutils literal"><span class="pre">dfhack.getDFPath()</span></code> instead.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.chdir(path)</span></code></p>
<p>Changes the current directory to <code class="docutils literal"><span class="pre">path</span></code>. Use with caution.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.mkdir(path)</span></code></p>
<p>Creates a new directory. Returns <code class="docutils literal"><span class="pre">false</span></code> if unsuccessful, including if <code class="docutils literal"><span class="pre">path</span></code> already exists.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.rmdir(path)</span></code></p>
<p>Removes a directory. Only works if the directory is already empty.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.mtime(path)</span></code></p>
<p>Returns the modification time (in seconds) of the file or directory specified by <code class="docutils literal"><span class="pre">path</span></code>,
or -1 if <code class="docutils literal"><span class="pre">path</span></code> does not exist. This depends on the system clock and should only be used locally.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.atime(path)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.ctime(path)</span></code></p>
<p>Return values vary across operating systems - return the <code class="docutils literal"><span class="pre">st_atime</span></code> and <code class="docutils literal"><span class="pre">st_ctime</span></code>
fields of a C++ stat struct, respectively.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.listdir(path)</span></code></p>
<p>Lists files/directories in a directory.  Returns <code class="docutils literal"><span class="pre">{}</span></code> if <code class="docutils literal"><span class="pre">path</span></code> does not exist.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.filesystem.listdir_recursive(path</span> <span class="pre">[,</span> <span class="pre">depth</span> <span class="pre">=</span> <span class="pre">10])</span></code></p>
<p>Lists all files/directories in a directory and its subdirectories. All directories
are listed before their contents. Returns a table with subtables of the format:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">path</span><span class="p">:</span> <span class="s1">&#39;path to file&#39;</span><span class="p">,</span> <span class="n">isdir</span><span class="p">:</span> <span class="n">true</span><span class="o">|</span><span class="n">false</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">listdir()</span></code> returns only the base name of each directory entry, while
<code class="docutils literal"><span class="pre">listdir_recursive()</span></code> returns the initial path and all components following it
for each entry.</p>
</li>
</ul>
</div>
<div class="section" id="console-api">
<h4><a class="toc-backref" href="#id106">Console API</a><a class="headerlink" href="#console-api" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.console.clear()</span></code></p>
<p>Clears the console; equivalent to the <code class="docutils literal"><span class="pre">cls</span></code> built-in command.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.console.flush()</span></code></p>
<p>Flushes all output to the console. This can be useful when printing text that
does not end in a newline but should still be displayed.</p>
</li>
</ul>
</div>
<div class="section" id="internal-api">
<h4><a class="toc-backref" href="#id107">Internal API</a><a class="headerlink" href="#internal-api" title="Permalink to this headline">¶</a></h4>
<p>These functions are intended for the use by dfhack developers,
and are only documented here for completeness:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.scripts</span></code></p>
<p>The table used by <code class="docutils literal"><span class="pre">dfhack.run_script()</span></code> to give every script its own
global environment, persistent between calls to the script.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getPE()</span></code></p>
<p>Returns the PE timestamp of the DF executable (only on Windows)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getMD5()</span></code></p>
<p>Returns the MD5 of the DF executable (only on OS X and Linux)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getAddress(name)</span></code></p>
<p>Returns the global address <code class="docutils literal"><span class="pre">name</span></code>, or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.setAddress(name,</span> <span class="pre">value)</span></code></p>
<p>Sets the global address <code class="docutils literal"><span class="pre">name</span></code>. Returns the value of <code class="docutils literal"><span class="pre">getAddress</span></code> before the change.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getVTable(name)</span></code></p>
<p>Returns the pre-extracted vtable address <code class="docutils literal"><span class="pre">name</span></code>, or <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getImageBase()</span></code></p>
<p>Returns the mmap base of the executable.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getRebaseDelta()</span></code></p>
<p>Returns the ASLR rebase offset of the DF executable.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.adjustOffset(offset[,to_file])</span></code></p>
<p>Returns the re-aligned offset, or <em>nil</em> if invalid.
If <code class="docutils literal"><span class="pre">to_file</span></code> is true, the offset is adjusted from memory to file.
This function returns the original value everywhere except windows.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getMemRanges()</span></code></p>
<p>Returns a sequence of tables describing virtual memory ranges of the process.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.patchMemory(dest,src,count)</span></code></p>
<p>Like memmove below, but works even if dest is read-only memory, e.g. code.
If destination overlaps a completely invalid memory region, or another error
occurs, returns false.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.patchBytes(write_table[,</span> <span class="pre">verify_table])</span></code></p>
<p>The first argument must be a lua table, which is interpreted as a mapping from
memory addresses to byte values that should be stored there. The second argument
may be a similar table of values that need to be checked before writing anything.</p>
<p>The function takes care to either apply all of <code class="docutils literal"><span class="pre">write_table</span></code>, or none of it.
An empty <code class="docutils literal"><span class="pre">write_table</span></code> with a nonempty <code class="docutils literal"><span class="pre">verify_table</span></code> can be used to reasonably
safely check if the memory contains certain values.</p>
<p>Returns <em>true</em> if successful, or <em>nil, error_msg, address</em> if not.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.memmove(dest,src,count)</span></code></p>
<p>Wraps the standard memmove function. Accepts both numbers and refs as pointers.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.memcmp(ptr1,ptr2,count)</span></code></p>
<p>Wraps the standard memcmp function.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.memscan(haystack,count,step,needle,nsize)</span></code></p>
<p>Searches for <code class="docutils literal"><span class="pre">needle</span></code> of <code class="docutils literal"><span class="pre">nsize</span></code> bytes in <code class="docutils literal"><span class="pre">haystack</span></code>,
using <code class="docutils literal"><span class="pre">count</span></code> steps of <code class="docutils literal"><span class="pre">step</span></code> bytes.
Returns: <em>step_idx, sum_idx, found_ptr</em>, or <em>nil</em> if not found.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.diffscan(old_data,</span> <span class="pre">new_data,</span> <span class="pre">start_idx,</span> <span class="pre">end_idx,</span> <span class="pre">eltsize[,</span> <span class="pre">oldval,</span> <span class="pre">newval,</span> <span class="pre">delta])</span></code></p>
<p>Searches for differences between buffers at ptr1 and ptr2, as integers of size eltsize.
The oldval, newval or delta arguments may be used to specify additional constraints.
Returns: <em>found_index</em>, or <em>nil</em> if end reached.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getDir(path)</span></code></p>
<p>Lists files/directories in a directory.
Returns: <em>file_names</em> or empty table if not found. Identical to <code class="docutils literal"><span class="pre">dfhack.filesystem.listdir(path)</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.strerror(errno)</span></code></p>
<p>Wraps strerror() - returns a string describing a platform-specific error code</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.addScriptPath(path,</span> <span class="pre">search_before)</span></code></p>
<p>Adds <code class="docutils literal"><span class="pre">path</span></code> to the list of paths searched for scripts (both in Lua and Ruby).
If <code class="docutils literal"><span class="pre">search_before</span></code> is passed and <code class="docutils literal"><span class="pre">true</span></code>, the path will be searched before
the default paths (e.g. <code class="docutils literal"><span class="pre">raw/scripts</span></code>, <code class="docutils literal"><span class="pre">hack/scripts</span></code>); otherwise, it will
be searched after.</p>
<p>Returns <code class="docutils literal"><span class="pre">true</span></code> if successful or <code class="docutils literal"><span class="pre">false</span></code> otherwise (e.g. if the path does
not exist or has already been registered).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.removeScriptPath(path)</span></code></p>
<p>Removes <code class="docutils literal"><span class="pre">path</span></code> from the script search paths and returns <code class="docutils literal"><span class="pre">true</span></code> if successful.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.getScriptPaths()</span></code></p>
<p>Returns the list of script paths in the order they are searched, including defaults.
(This can change if a world is loaded.)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.findScript(name)</span></code></p>
<p>Searches script paths for the script <code class="docutils literal"><span class="pre">name</span></code> and returns the path of the first
file found, or <code class="docutils literal"><span class="pre">nil</span></code> on failure.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This requires an extension to be specified (<code class="docutils literal"><span class="pre">.lua</span></code> or <code class="docutils literal"><span class="pre">.rb</span></code>) - use
<code class="docutils literal"><span class="pre">dfhack.findScript()</span></code> to include the <code class="docutils literal"><span class="pre">.lua</span></code> extension automatically.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.md5(string)</span></code></p>
<p>Returns the MD5 hash of the given string.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.md5File(filename[,first_kb])</span></code></p>
<p>Computes the MD5 hash of the given file. Returns <code class="docutils literal"><span class="pre">hash,</span> <span class="pre">length</span></code> on success
(where <code class="docutils literal"><span class="pre">length</span></code> is the number of bytes read from the file), or <code class="docutils literal"><span class="pre">nil,</span>
<span class="pre">error</span></code> on failure.</p>
<p>If the parameter <code class="docutils literal"><span class="pre">first_kb</span></code> is specified and evaluates to <code class="docutils literal"><span class="pre">true</span></code>, and the
hash was computed successfully, a table containing the first 1024 bytes of the
file is returned as the third return value.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.internal.threadid()</span></code></p>
<p>Returns a numeric identifier of the current thread.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="core-interpreter-context">
<h3><a class="toc-backref" href="#id84">Core interpreter context</a><a class="headerlink" href="#core-interpreter-context" title="Permalink to this headline">¶</a></h3>
<p>While plugins can create any number of interpreter instances,
there is one special context managed by dfhack core. It is the
only context that can receive events from DF and plugins.</p>
<p>Core context specific functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.is_core_context</span></code></p>
<p>Boolean value; <em>true</em> in the core context.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.timeout(time,mode,callback)</span></code></p>
<p>Arranges for the callback to be called once the specified
period of time passes. The <code class="docutils literal"><span class="pre">mode</span></code> argument specifies the
unit of time used, and may be one of <code class="docutils literal"><span class="pre">'frames'</span></code> (raw FPS),
<code class="docutils literal"><span class="pre">'ticks'</span></code> (unpaused FPS), <code class="docutils literal"><span class="pre">'days'</span></code>, <code class="docutils literal"><span class="pre">'months'</span></code>,
<code class="docutils literal"><span class="pre">'years'</span></code> (in-game time). All timers other than
<code class="docutils literal"><span class="pre">'frames'</span></code> are cancelled when the world is unloaded,
and cannot be queued until it is loaded again.
Returns the timer id, or <em>nil</em> if unsuccessful due to
world being unloaded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.timeout_active(id[,new_callback])</span></code></p>
<p>Returns the active callback with the given id, or <em>nil</em>
if inactive or nil id. If called with 2 arguments, replaces
the current callback with the given value, if still active.
Using <code class="docutils literal"><span class="pre">timeout_active(id,nil)</span></code> cancels the timer.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.onStateChange.foo</span> <span class="pre">=</span> <span class="pre">function(code)</span></code></p>
<p>Event. Receives the same codes as plugin_onstatechange in C++.</p>
</li>
</ul>
<div class="section" id="event-type">
<h4><a class="toc-backref" href="#id85">Event type</a><a class="headerlink" href="#event-type" title="Permalink to this headline">¶</a></h4>
<p>An event is a native object transparently wrapping a lua table,
and implementing a __call metamethod. When it is invoked, it loops
through the table with next and calls all contained values.
This is intended as an extensible way to add listeners.</p>
<p>This type itself is available in any context, but only the
core context has the actual events defined by C++ code.</p>
<p>Features:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.event.new()</span></code></p>
<p>Creates a new instance of an event.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">event[key]</span> <span class="pre">=</span> <span class="pre">function</span></code></p>
<p>Sets the function as one of the listeners. Assign <em>nil</em> to remove it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">df.NULL</span></code> key is reserved for the use by
the C++ owner of the event; it is an error to try setting it.</p>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">#event</span></code></p>
<p>Returns the number of non-nil listeners.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pairs(event)</span></code></p>
<p>Iterates over all listeners in the table.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">event(args...)</span></code></p>
<p>Invokes all listeners contained in the event in an arbitrary
order using <code class="docutils literal"><span class="pre">dfhack.safecall</span></code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="lua-modules">
<h2><a class="toc-backref" href="#id25">Lua Modules</a><a class="headerlink" href="#lua-modules" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id4">
<ul class="simple">
<li><a class="reference internal" href="#global-environment" id="id108">Global environment</a></li>
<li><a class="reference internal" href="#utils" id="id109">utils</a></li>
<li><a class="reference internal" href="#dumper" id="id110">dumper</a></li>
<li><a class="reference internal" href="#profiler" id="id111">profiler</a><ul>
<li><a class="reference internal" href="#examples" id="id112">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#class" id="id113">class</a></li>
</ul>
</div>
<p>DFHack sets up the lua interpreter so that the built-in <code class="docutils literal"><span class="pre">require</span></code>
function can be used to load shared lua code from <code class="file docutils literal"><span class="pre">hack/lua/</span></code>.
The <code class="docutils literal"><span class="pre">dfhack</span></code> namespace reference itself may be obtained via
<code class="docutils literal"><span class="pre">require('dfhack')</span></code>, although it is initially created as a
global by C++ bootstrap code.</p>
<p>The following module management functions are provided:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">mkmodule(name)</span></code></p>
<p>Creates an environment table for the module. Intended to be used as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="n">mkmodule</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="k">return</span> <span class="n">_ENV</span>
</pre></div>
</div>
<p>If called the second time, returns the same table; thus providing reload support.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">reload(name)</span></code></p>
<p>Reloads a previously <code class="docutils literal"><span class="pre">require</span></code>-d module <em>“name”</em> from the file.
Intended as a help for module development.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.BASE_G</span></code></p>
<p>This variable contains the root global environment table, which is
used as a base for all module and script environments. Its contents
should be kept limited to the standard Lua library and API described
in this document.</p>
</li>
</ul>
<div class="section" id="global-environment">
<h3><a class="toc-backref" href="#id108">Global environment</a><a class="headerlink" href="#global-environment" title="Permalink to this headline">¶</a></h3>
<p>A number of variables and functions are provided in the base global
environment by the mandatory init file dfhack.lua:</p>
<ul>
<li><p class="first">Color constants</p>
<p>These are applicable both for <code class="docutils literal"><span class="pre">dfhack.color()</span></code> and color fields
in DF functions or structures:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">COLOR_RESET</span><span class="p">,</span> <span class="n">COLOR_BLACK</span><span class="p">,</span> <span class="n">COLOR_BLUE</span><span class="p">,</span> <span class="n">COLOR_GREEN</span><span class="p">,</span> <span class="n">COLOR_CYAN</span><span class="p">,</span>
<span class="n">COLOR_RED</span><span class="p">,</span> <span class="n">COLOR_MAGENTA</span><span class="p">,</span> <span class="n">COLOR_BROWN</span><span class="p">,</span> <span class="n">COLOR_GREY</span><span class="p">,</span> <span class="n">COLOR_DARKGREY</span><span class="p">,</span>
<span class="n">COLOR_LIGHTBLUE</span><span class="p">,</span> <span class="n">COLOR_LIGHTGREEN</span><span class="p">,</span> <span class="n">COLOR_LIGHTCYAN</span><span class="p">,</span> <span class="n">COLOR_LIGHTRED</span><span class="p">,</span>
<span class="n">COLOR_LIGHTMAGENTA</span><span class="p">,</span> <span class="n">COLOR_YELLOW</span><span class="p">,</span> <span class="n">COLOR_WHITE</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.onStateChange</span></code> event codes</p>
<p>Available only in the core context, as is the event itself:</p>
<p>SC_WORLD_LOADED, SC_WORLD_UNLOADED, SC_MAP_LOADED,
SC_MAP_UNLOADED, SC_VIEWSCREEN_CHANGED, SC_CORE_INITIALIZED</p>
</li>
<li><p class="first">Functions already described above</p>
<p>safecall, qerror, mkmodule, reload</p>
</li>
<li><p class="first">Miscellaneous constants</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">NEWLINE</span></code>, <code class="docutils literal"><span class="pre">COMMA</span></code>, <code class="docutils literal"><span class="pre">PERIOD</span></code></dt>
<dd><p class="first last">evaluate to the relevant character strings.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">DEFAULT_NIL</span></code></dt>
<dd><p class="first last">is an unspecified unique token used by the class module below.</p>
</dd>
</dl>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">printall(obj)</span></code></p>
<p>If the argument is a lua table or DF object reference, prints all fields.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">printall_recurse(obj)</span></code></p>
<p>If the argument is a lua table or DF object reference, prints all fields recursively.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">copyall(obj)</span></code></p>
<p>Returns a shallow copy of the table or reference as a lua table.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pos2xyz(obj)</span></code></p>
<p>The object must have fields x, y and z. Returns them as 3 values.
If obj is <em>nil</em>, or x is -30000 (the usual marker for undefined
coordinates), returns <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">xyz2pos(x,y,z)</span></code></p>
<p>Returns a table with x, y and z as fields.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">same_xyz(a,b)</span></code></p>
<p>Checks if <code class="docutils literal"><span class="pre">a</span></code> and <code class="docutils literal"><span class="pre">b</span></code> have the same x, y and z fields.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">get_path_xyz(path,i)</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">path.x[i],</span> <span class="pre">path.y[i],</span> <span class="pre">path.z[i]</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pos2xy(obj)</span></code>, <code class="docutils literal"><span class="pre">xy2pos(x,y)</span></code>, <code class="docutils literal"><span class="pre">same_xy(a,b)</span></code>, <code class="docutils literal"><span class="pre">get_path_xy(a,b)</span></code></p>
<p>Same as above, but for 2D coordinates.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">safe_index(obj,index...)</span></code></p>
<p>Walks a sequence of dereferences, which may be represented by numbers or strings.
Returns <em>nil</em> if any of obj or indices is <em>nil</em>, or a numeric index is out of array bounds.</p>
</li>
</ul>
</div>
<div class="section" id="utils">
<h3><a class="toc-backref" href="#id109">utils</a><a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.compare(a,b)</span></code></p>
<p>Comparator function; returns <em>-1</em> if a&lt;b, <em>1</em> if a&gt;b, <em>0</em> otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.compare_name(a,b)</span></code></p>
<p>Comparator for names; compares empty string last.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.is_container(obj)</span></code></p>
<p>Checks if obj is a container ref.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.make_index_sequence(start,end)</span></code></p>
<p>Returns a lua sequence of numbers in start..end.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.make_sort_order(data,</span> <span class="pre">ordering)</span></code></p>
<p>Computes a sorted permutation of objects in data, as a table of integer
indices into the data sequence. Uses <code class="docutils literal"><span class="pre">data.n</span></code> as input length
if present.</p>
<p>The ordering argument is a sequence of ordering specs, represented
as lua tables with following possible fields:</p>
<dl class="docutils">
<dt>ord.key = <em>function(value)</em></dt>
<dd><p class="first last">Computes comparison key from input data value. Not called on nil.
If omitted, the comparison key is the value itself.</p>
</dd>
<dt>ord.key_table = <em>function(data)</em></dt>
<dd><p class="first last">Computes a key table from the data table in one go.</p>
</dd>
<dt>ord.compare = <em>function(a,b)</em></dt>
<dd><p class="first last">Comparison function. Defaults to <code class="docutils literal"><span class="pre">utils.compare</span></code> above.
Called on non-nil keys; nil sorts last.</p>
</dd>
<dt>ord.nil_first = <em>true/false</em></dt>
<dd><p class="first last">If true, nil keys are sorted first instead of last.</p>
</dd>
<dt>ord.reverse = <em>true/false</em></dt>
<dd><p class="first last">If true, sort non-nil keys in descending order.</p>
</dd>
</dl>
<p>For every comparison during sorting the specs are applied in
order until an unambiguous decision is reached. Sorting is stable.</p>
<p>Example of sorting a sequence by field foo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span> <span class="n">key</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">foo</span> <span class="n">end</span> <span class="p">}</span>
<span class="n">local</span> <span class="n">order</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_sort_order</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">{</span> <span class="n">spec</span> <span class="p">})</span>
<span class="n">local</span> <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="c1">#order do output[i] = data[order[i]] end</span>
</pre></div>
</div>
<p>Separating the actual reordering of the sequence in this
way enables applying the same permutation to multiple arrays.
This function is used by the sort plugin.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">for</span> <span class="pre">link,item</span> <span class="pre">in</span> <span class="pre">utils.listpairs(list)</span></code></p>
<p>Iterates a df-list structure, for example <code class="docutils literal"><span class="pre">df.global.world.job_list</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.assign(tgt,</span> <span class="pre">src)</span></code></p>
<p>Does a recursive assignment of src into tgt.
Uses <code class="docutils literal"><span class="pre">df.assign</span></code> if tgt is a native object ref; otherwise
recurses into lua tables.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.clone(obj,</span> <span class="pre">deep)</span></code></p>
<p>Performs a shallow, or semi-deep copy of the object as a lua table tree.
The deep mode recurses into lua tables and subobjects, except pointers
to other heap objects.
Null pointers are represented as <code class="docutils literal"><span class="pre">df.NULL</span></code>. Zero-based native containers
are converted to 1-based lua sequences.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.clone_with_default(obj,</span> <span class="pre">default,</span> <span class="pre">force)</span></code></p>
<p>Copies the object, using the <code class="docutils literal"><span class="pre">default</span></code> lua table tree
as a guide to which values should be skipped as uninteresting.
The <code class="docutils literal"><span class="pre">force</span></code> argument makes it always return a non-<em>nil</em> value.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.parse_bitfield_int(value,</span> <span class="pre">type_ref)</span></code></p>
<p>Given an int <code class="docutils literal"><span class="pre">value</span></code>, and a bitfield type in the <code class="docutils literal"><span class="pre">df</span></code> tree,
it returns a lua table mapping the enabled bit keys to <em>true</em>,
unless value is 0, in which case it returns <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.list_bitfield_flags(bitfield[,</span> <span class="pre">list])</span></code></p>
<p>Adds all enabled bitfield keys to <code class="docutils literal"><span class="pre">list</span></code> or a newly-allocated
empty sequence, and returns it. The <code class="docutils literal"><span class="pre">bitfield</span></code> argument may
be <em>nil</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.sort_vector(vector,field,cmpfun)</span></code></p>
<p>Sorts a native vector or lua sequence using the comparator function.
If <code class="docutils literal"><span class="pre">field</span></code> is not <em>nil</em>, applies the comparator to the field instead
of the whole object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.linear_index(vector,key[,field])</span></code></p>
<p>Searches for <code class="docutils literal"><span class="pre">key</span></code> in the vector, and returns <em>index, found_value</em>,
or <em>nil</em> if none found.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.binsearch(vector,key,field,cmpfun,min,max)</span></code></p>
<p>Does a binary search in a native vector or lua sequence for
<code class="docutils literal"><span class="pre">key</span></code>, using <code class="docutils literal"><span class="pre">cmpfun</span></code> and <code class="docutils literal"><span class="pre">field</span></code> like sort_vector.
If <code class="docutils literal"><span class="pre">min</span></code> and <code class="docutils literal"><span class="pre">max</span></code> are specified, they are used as the
search subrange bounds.</p>
<p>If found, returns <em>item, true, idx</em>. Otherwise returns
<em>nil, false, insert_idx</em>, where <em>insert_idx</em> is the correct
insertion point.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.insert_sorted(vector,item,field,cmpfun)</span></code></p>
<p>Does a binary search, and inserts item if not found.
Returns <em>did_insert, vector[idx], idx</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.insert_or_update(vector,item,field,cmpfun)</span></code></p>
<p>Like <code class="docutils literal"><span class="pre">insert_sorted</span></code>, but also assigns the item into
the vector cell if insertion didn’t happen.</p>
<p>As an example, you can use this to set skill values:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">insert_or_update</span><span class="p">(</span><span class="n">soul</span><span class="o">.</span><span class="n">skills</span><span class="p">,</span> <span class="p">{</span><span class="n">new</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="nb">id</span><span class="o">=...</span><span class="p">,</span> <span class="n">rating</span><span class="o">=...</span><span class="p">},</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>(For an explanation of <code class="docutils literal"><span class="pre">new=true</span></code>, see <a class="reference internal" href="#lua-api-table-assignment"><span class="std std-ref">Recursive table assignment</span></a>)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.erase_sorted_key(vector,key,field,cmpfun)</span></code></p>
<p>Removes the item with the given key from the list. Returns: <em>did_erase, vector[idx], idx</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.erase_sorted(vector,item,field,cmpfun)</span></code></p>
<p>Exactly like <code class="docutils literal"><span class="pre">erase_sorted_key</span></code>, but if field is specified, takes the key from <code class="docutils literal"><span class="pre">item[field]</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.call_with_string(obj,methodname,...)</span></code></p>
<p>Allocates a temporary string object, calls <code class="docutils literal"><span class="pre">obj:method(tmp,...)</span></code>, and
returns the value written into the temporary after deleting it.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.getBuildingName(building)</span></code></p>
<p>Returns the string description of the given building.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.getBuildingCenter(building)</span></code></p>
<p>Returns an x/y/z table pointing at the building center.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.split_string(string,</span> <span class="pre">delimiter)</span></code></p>
<p>Splits the string by the given delimiter, and returns a sequence of results.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.prompt_yes_no(prompt,</span> <span class="pre">default)</span></code></p>
<p>Presents a yes/no prompt to the user. If <code class="docutils literal"><span class="pre">default</span></code> is not <em>nil</em>,
allows just pressing Enter to submit the default choice.
If the user enters <code class="docutils literal"><span class="pre">'abort'</span></code>, throws an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.prompt_input(prompt,</span> <span class="pre">checkfun,</span> <span class="pre">quit_str)</span></code></p>
<p>Presents a prompt to input data, until a valid string is entered.
Once <code class="docutils literal"><span class="pre">checkfun(input)</span></code> returns <em>true, …</em>, passes the values
through. If the user enters the quit_str (defaults to <code class="docutils literal"><span class="pre">'~~~'</span></code>),
throws an error.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">utils.check_number(text)</span></code></p>
<p>A <code class="docutils literal"><span class="pre">prompt_input</span></code> <code class="docutils literal"><span class="pre">checkfun</span></code> that verifies a number input.</p>
</li>
</ul>
</div>
<div class="section" id="dumper">
<h3><a class="toc-backref" href="#id110">dumper</a><a class="headerlink" href="#dumper" title="Permalink to this headline">¶</a></h3>
<p>A third-party lua table dumper module from
<a class="reference external" href="http://lua-users.org/wiki/DataDumper">http://lua-users.org/wiki/DataDumper</a>. Defines one
function:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dumper.DataDumper(value,</span> <span class="pre">varname,</span> <span class="pre">fastmode,</span> <span class="pre">ident,</span> <span class="pre">indent_step)</span></code></p>
<p>Returns <code class="docutils literal"><span class="pre">value</span></code> converted to a string. The <code class="docutils literal"><span class="pre">indent_step</span></code>
argument specifies the indentation step size in spaces. For
the other arguments see the original documentation link above.</p>
</li>
</ul>
</div>
<div class="section" id="profiler">
<h3><a class="toc-backref" href="#id111">profiler</a><a class="headerlink" href="#profiler" title="Permalink to this headline">¶</a></h3>
<p>A third-party lua profiler module from
<a class="reference external" href="http://lua-users.org/wiki/PepperfishProfiler">http://lua-users.org/wiki/PepperfishProfiler</a>. Module defines one function to
create profiler objects which can be used to profile and generate report.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">profiler.newProfiler([variant[,</span> <span class="pre">sampling_frequency]])</span></code></p>
<p>Returns an profile object with <code class="docutils literal"><span class="pre">variant</span></code> either <code class="docutils literal"><span class="pre">'time'</span></code> or <code class="docutils literal"><span class="pre">'call'</span></code>.
<code class="docutils literal"><span class="pre">'time'</span></code> variant takes optional <code class="docutils literal"><span class="pre">sampling_frequency</span></code> parameter to select
lua instruction counts between samples. Default is <code class="docutils literal"><span class="pre">'time'</span></code> variant with
<code class="docutils literal"><span class="pre">10*1000</span></code> frequency.</p>
<p><code class="docutils literal"><span class="pre">'call'</span></code> variant has much higher runtime cost which will increase the
runtime of profiled code by factor of ten. For the extreme costs it provides
accurate function call counts that can help locate code which takes much time
in native calls.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">obj:start()</span></code></p>
<p>Resets collected statistics. Then it starts collecting new statistics.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">obj:stop()</span></code></p>
<p>Stops profile collection.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">obj:report(outfile[,</span> <span class="pre">sort_by_total_time])</span></code></p>
<p>Write a report from previous statistics collection to <code class="docutils literal"><span class="pre">outfile</span></code>.
<code class="docutils literal"><span class="pre">outfile</span></code> should be writeable io file object (<code class="docutils literal"><span class="pre">io.open</span></code> or
<code class="docutils literal"><span class="pre">io.stdout</span></code>). Passing <code class="docutils literal"><span class="pre">true</span></code> as second parameter <code class="docutils literal"><span class="pre">sort_by_total_time</span></code>
switches sorting order to use total time instead of default self time order.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">obj:prevent(function)</span></code></p>
<p>Adds an ignore filter for a <code class="docutils literal"><span class="pre">function</span></code>. It will ignore the pointed function
and all of it children.</p>
</li>
</ul>
<div class="section" id="examples">
<h4><a class="toc-backref" href="#id112">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">prof</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">newProfiler</span><span class="p">()</span>
<span class="n">prof</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>

<span class="n">profiledCode</span><span class="p">()</span>

<span class="n">prof</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span>

<span class="n">local</span> <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="s2">&quot;lua-profile.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
<span class="n">prof</span><span class="p">:</span><span class="n">report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="class">
<h3><a class="toc-backref" href="#id113">class</a><a class="headerlink" href="#class" title="Permalink to this headline">¶</a></h3>
<p>Implements a trivial single-inheritance class system.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">Foo</span> <span class="pre">=</span> <span class="pre">defclass(Foo[,</span> <span class="pre">ParentClass])</span></code></p>
<p>Defines or updates class Foo. The <code class="docutils literal"><span class="pre">Foo</span> <span class="pre">=</span> <span class="pre">defclass(Foo)</span></code> syntax
is needed so that when the module or script is reloaded, the
class identity will be preserved through the preservation of
global variable values.</p>
<p>The <code class="docutils literal"><span class="pre">defclass</span></code> function is defined as a stub in the global
namespace, and using it will auto-load the class module.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Class.super</span></code></p>
<p>This class field is set by defclass to the parent class, and
allows a readable <code class="docutils literal"><span class="pre">Class.super.method(self,</span> <span class="pre">...)</span></code> syntax for
calling superclass methods.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Class.ATTRS</span> <span class="pre">{</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">xxx,</span> <span class="pre">bar</span> <span class="pre">=</span> <span class="pre">yyy</span> <span class="pre">}</span></code></p>
<p>Declares certain instance fields to be attributes, i.e. auto-initialized
from fields in the table used as the constructor argument. If omitted,
they are initialized with the default values specified in this declaration.</p>
<p>If the default value should be <em>nil</em>, use <code class="docutils literal"><span class="pre">ATTRS</span> <span class="pre">{</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">DEFAULT_NIL</span> <span class="pre">}</span></code>.</p>
<p>Declaring an attribute is mostly the same as defining your <code class="docutils literal"><span class="pre">init</span></code> method like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">Class</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attr1</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">attr1</span> <span class="ow">or</span> <span class="n">default1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attr2</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">attr2</span> <span class="ow">or</span> <span class="n">default2</span>
    <span class="o">...</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The main difference is that attributes are processed as a separate
initialization step, before any <code class="docutils literal"><span class="pre">init</span></code> methods are called. They
also make the directy relation between instance fields and constructor
arguments more explicit.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">new_obj</span> <span class="pre">=</span> <span class="pre">Class{</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">arg,</span> <span class="pre">bar</span> <span class="pre">=</span> <span class="pre">arg,</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>Calling the class as a function creates and initializes a new instance.
Initialization happens in this order:</p>
<ol class="arabic simple">
<li>An empty instance table is created, and its metatable set.</li>
<li>The <code class="docutils literal"><span class="pre">preinit</span></code> methods are called via <code class="docutils literal"><span class="pre">invoke_before</span></code> (see below)
with the table used as argument to the class. These methods are intended
for validating and tweaking that argument table.</li>
<li>Declared ATTRS are initialized from the argument table or their default values.</li>
<li>The <code class="docutils literal"><span class="pre">init</span></code> methods are called via <code class="docutils literal"><span class="pre">invoke_after</span></code> with the argument table.
This is the main constructor method.</li>
<li>The <code class="docutils literal"><span class="pre">postinit</span></code> methods are called via <code class="docutils literal"><span class="pre">invoke_after</span></code> with the argument table.
Place code that should be called after the object is fully constructed here.</li>
</ol>
</li>
</ul>
<p>Predefined instance methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:assign{</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">xxx</span> <span class="pre">}</span></code></p>
<p>Assigns all values in the input table to the matching instance fields.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:callback(method_name,</span> <span class="pre">[args...])</span></code></p>
<p>Returns a closure that invokes the specified method of the class,
properly passing in self, and optionally a number of initial arguments too.
The arguments given to the closure are appended to these.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:cb_getfield(field_name)</span></code></p>
<p>Returns a closure that returns the specified field of the object when called.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:cb_setfield(field_name)</span></code></p>
<p>Returns a closure that sets the specified field to its argument when called.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:invoke_before(method_name,</span> <span class="pre">args...)</span></code></p>
<p>Navigates the inheritance chain of the instance starting from the most specific
class, and invokes the specified method with the arguments if it is defined in
that specific class. Equivalent to the following definition in every class:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">Class</span><span class="p">:</span><span class="n">invoke_before</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">rawget</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="n">then</span>
    <span class="n">rawget</span><span class="p">(</span><span class="n">Class</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="n">end</span>
  <span class="n">Class</span><span class="o">.</span><span class="n">super</span><span class="o">.</span><span class="n">invoke_before</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">instance:invoke_after(method_name,</span> <span class="pre">args...)</span></code></p>
<p>Like invoke_before, only the method is called after the recursive call to super,
i.e. invocations happen in the parent to child order.</p>
<p>These two methods are inspired by the Common Lisp before and after methods, and
are intended for implementing similar protocols for certain things. The class
library itself uses them for constructors.</p>
</li>
</ul>
<p>To avoid confusion, these methods cannot be redefined.</p>
</div>
</div>
<div class="section" id="in-game-ui-library">
<h2><a class="toc-backref" href="#id31">In-game UI Library</a><a class="headerlink" href="#in-game-ui-library" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id5">
<ul class="simple">
<li><a class="reference internal" href="#gui" id="id114">gui</a><ul>
<li><a class="reference internal" href="#misc" id="id115">Misc</a></li>
<li><a class="reference internal" href="#viewrect-class" id="id116">ViewRect class</a></li>
<li><a class="reference internal" href="#painter-class" id="id117">Painter class</a></li>
<li><a class="reference internal" href="#view-class" id="id118">View class</a></li>
<li><a class="reference internal" href="#screen-class" id="id119">Screen class</a></li>
<li><a class="reference internal" href="#framedscreen-class" id="id120">FramedScreen class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gui-widgets" id="id121">gui.widgets</a><ul>
<li><a class="reference internal" href="#widget-class" id="id122">Widget class</a></li>
<li><a class="reference internal" href="#panel-class" id="id123">Panel class</a></li>
<li><a class="reference internal" href="#pages-class" id="id124">Pages class</a></li>
<li><a class="reference internal" href="#editfield-class" id="id125">EditField class</a></li>
<li><a class="reference internal" href="#label-class" id="id126">Label class</a></li>
<li><a class="reference internal" href="#list-class" id="id127">List class</a></li>
<li><a class="reference internal" href="#filteredlist-class" id="id128">FilteredList class</a></li>
</ul>
</li>
</ul>
</div>
<p>A number of lua modules with names starting with <code class="docutils literal"><span class="pre">gui</span></code> are dedicated
to wrapping the natives of the <code class="docutils literal"><span class="pre">dfhack.screen</span></code> module in a way that
is easy to use. This allows relatively easily and naturally creating
dialogs that integrate in the main game UI window.</p>
<p>These modules make extensive use of the <code class="docutils literal"><span class="pre">class</span></code> module, and define
things ranging from the basic <code class="docutils literal"><span class="pre">Painter</span></code>, <code class="docutils literal"><span class="pre">View</span></code> and <code class="docutils literal"><span class="pre">Screen</span></code>
classes, to fully functional predefined dialogs.</p>
<div class="section" id="gui">
<h3><a class="toc-backref" href="#id114">gui</a><a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<p>This module defines the most important classes and functions for
implementing interfaces. This documents those of them that are
considered stable.</p>
<div class="section" id="misc">
<h4><a class="toc-backref" href="#id115">Misc</a><a class="headerlink" href="#misc" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">USE_GRAPHICS</span></code></p>
<p>Contains the value of <code class="docutils literal"><span class="pre">dfhack.screen.inGraphicsMode()</span></code>, which cannot be
changed without restarting the game and thus is constant during the session.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">CLEAR_PEN</span></code></p>
<p>The black pen used to clear the screen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">simulateInput(screen,</span> <span class="pre">keys...)</span></code></p>
<p>This function wraps an undocumented native function that passes a set of
keycodes to a screen, and is the official way to do that.</p>
<p>Every argument after the initial screen may be <em>nil</em>, a numeric keycode,
a string keycode, a sequence of numeric or string keycodes, or a mapping
of keycodes to <em>true</em> or <em>false</em>. For instance, it is possible to use the
table passed as argument to <code class="docutils literal"><span class="pre">onInput</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">mkdims_xy(x1,y1,x2,y2)</span></code></p>
<p>Returns a table containing the arguments as fields, and also <code class="docutils literal"><span class="pre">width</span></code> and
<code class="docutils literal"><span class="pre">height</span></code> that contains the rectangle dimensions.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">mkdims_wh(x1,y1,width,height)</span></code></p>
<p>Returns the same kind of table as <code class="docutils literal"><span class="pre">mkdims_xy</span></code>, only this time it computes
<code class="docutils literal"><span class="pre">x2</span></code> and <code class="docutils literal"><span class="pre">y2</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">is_in_rect(rect,x,y)</span></code></p>
<p>Checks if the given point is within a rectangle, represented by a table produced
by one of the <code class="docutils literal"><span class="pre">mkdims</span></code> functions.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">blink_visible(delay)</span></code></p>
<p>Returns <em>true</em> or <em>false</em>, with the value switching to the opposite every <code class="docutils literal"><span class="pre">delay</span></code>
msec. This is intended for rendering blinking interface objects.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">getKeyDisplay(keycode)</span></code></p>
<p>Wraps <code class="docutils literal"><span class="pre">dfhack.screen.getKeyDisplay</span></code> in order to allow using strings for the keycode argument.</p>
</li>
</ul>
</div>
<div class="section" id="viewrect-class">
<h4><a class="toc-backref" href="#id116">ViewRect class</a><a class="headerlink" href="#viewrect-class" title="Permalink to this headline">¶</a></h4>
<p>This class represents an on-screen rectangle with an associated independent
clip area rectangle. It is the base of the <code class="docutils literal"><span class="pre">Painter</span></code> class, and is used by
<code class="docutils literal"><span class="pre">Views</span></code> to track their client area.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">ViewRect{</span> <span class="pre">rect</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">clip_rect</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">view_rect</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">clip_view</span> <span class="pre">=</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>The constructor has the following arguments:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">rect:</th><td class="field-body">The <code class="docutils literal"><span class="pre">mkdims</span></code> rectangle in screen coordinates of the logical viewport.
Defaults to the whole screen.</td>
</tr>
<tr class="field-even field"><th class="field-name">clip_rect:</th><td class="field-body">The clip rectangle in screen coordinates. Defaults to <code class="docutils literal"><span class="pre">rect</span></code>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">view_rect:</th><td class="field-body">A ViewRect object to copy from; overrides both <code class="docutils literal"><span class="pre">rect</span></code> and <code class="docutils literal"><span class="pre">clip_rect</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">clip_view:</th><td class="field-body">A ViewRect object to intersect the specified clip area with.</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:isDefunct()</span></code></p>
<p>Returns <em>true</em> if the clip area is empty, i.e. no painting is possible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:inClipGlobalXY(x,y)</span></code></p>
<p>Checks if these global coordinates are within the clip rectangle.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:inClipLocalXY(x,y)</span></code></p>
<p>Checks if these coordinates (specified relative to <code class="docutils literal"><span class="pre">x1,y1</span></code>) are within the clip rectangle.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:localXY(x,y)</span></code></p>
<p>Converts a pair of global coordinates to local; returns <em>x_local,y_local</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:globalXY(x,y)</span></code></p>
<p>Converts a pair of local coordinates to global; returns <em>x_global,y_global</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rect:viewport(x,y,w,h)</span></code> or <code class="docutils literal"><span class="pre">rect:viewport(subrect)</span></code></p>
<p>Returns a ViewRect representing a sub-rectangle of the current one.
The arguments are specified in local coordinates; the <code class="docutils literal"><span class="pre">subrect</span></code>
argument must be a <code class="docutils literal"><span class="pre">mkdims</span></code> table. The returned object consists of
the exact specified rectangle, and a clip area produced by intersecting
it with the clip area of the original object.</p>
</li>
</ul>
</div>
<div class="section" id="painter-class">
<h4><a class="toc-backref" href="#id117">Painter class</a><a class="headerlink" href="#painter-class" title="Permalink to this headline">¶</a></h4>
<p>The painting natives in <code class="docutils literal"><span class="pre">dfhack.screen</span></code> apply to the whole screen, are
completely stateless and don’t implement clipping.</p>
<p>The Painter class inherits from ViewRect to provide clipping and local
coordinates, and tracks current cursor position and current pen.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">Painter{</span> <span class="pre">...,</span> <span class="pre">pen</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">key_pen</span> <span class="pre">=</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>In addition to ViewRect arguments, Painter accepts a suggestion of
the initial value for the main pen, and the keybinding pen. They
default to COLOR_GREY and COLOR_LIGHTGREEN otherwise.</p>
<p>There are also some convenience functions that wrap this constructor:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Painter.new(rect,pen)</span></code></li>
<li><code class="docutils literal"><span class="pre">Painter.new_view(view_rect,pen)</span></code></li>
<li><code class="docutils literal"><span class="pre">Painter.new_xy(x1,y1,x2,y2,pen)</span></code></li>
<li><code class="docutils literal"><span class="pre">Painter.new_wh(x1,y1,width,height,pen)</span></code></li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:isValidPos()</span></code></p>
<p>Checks if the current cursor position is within the clip area.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:viewport(x,y,w,h)</span></code></p>
<p>Like the superclass method, but returns a Painter object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:cursor()</span></code></p>
<p>Returns the current cursor <em>x,y</em> in local coordinates.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:seek(x,y)</span></code></p>
<p>Sets the current cursor position, and returns <em>self</em>.
Either of the arguments may be <em>nil</em> to keep the current value.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:advance(dx,dy)</span></code></p>
<p>Adds the given offsets to the cursor position, and returns <em>self</em>.
Either of the arguments may be <em>nil</em> to keep the current value.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:newline([dx])</span></code></p>
<p>Advances the cursor to the start of the next line plus the given x offset, and returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:pen(...)</span></code></p>
<p>Sets the current pen to <code class="docutils literal"><span class="pre">dfhack.pen.parse(old_pen,...)</span></code>, and returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:key_pen(...)</span></code></p>
<p>Sets the current keybinding pen to <code class="docutils literal"><span class="pre">dfhack.pen.parse(old_pen,...)</span></code>, and returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:clear()</span></code></p>
<p>Fills the whole clip rectangle with <code class="docutils literal"><span class="pre">CLEAR_PEN</span></code>, and returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:fill(x1,y1,x2,y2[,...])</span></code> or <code class="docutils literal"><span class="pre">painter:fill(rect[,...])</span></code></p>
<p>Fills the specified local coordinate rectangle with <code class="docutils literal"><span class="pre">dfhack.pen.parse(cur_pen,...)</span></code>,
and returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:char([char[,</span> <span class="pre">...]])</span></code></p>
<p>Paints one character using <code class="docutils literal"><span class="pre">char</span></code> and <code class="docutils literal"><span class="pre">dfhack.pen.parse(cur_pen,...)</span></code>; returns <em>self</em>.
The <code class="docutils literal"><span class="pre">char</span></code> argument, if not nil, is used to override the <code class="docutils literal"><span class="pre">ch</span></code> property of the pen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:tile([char,</span> <span class="pre">tile[,</span> <span class="pre">...]])</span></code></p>
<p>Like above, but also allows overriding the <code class="docutils literal"><span class="pre">tile</span></code> property on ad-hoc basis.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:string(text[,</span> <span class="pre">...])</span></code></p>
<p>Paints the string with <code class="docutils literal"><span class="pre">dfhack.pen.parse(cur_pen,...)</span></code>; returns <em>self</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">painter:key(keycode[,</span> <span class="pre">...])</span></code></p>
<p>Paints the description of the keycode using <code class="docutils literal"><span class="pre">dfhack.pen.parse(cur_key_pen,...)</span></code>; returns <em>self</em>.</p>
</li>
</ul>
<p>As noted above, all painting methods return <em>self</em>, in order to allow chaining them like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">painter</span><span class="p">:</span><span class="n">pen</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span><span class="n">seek</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span><span class="n">char</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="view-class">
<h4><a class="toc-backref" href="#id118">View class</a><a class="headerlink" href="#view-class" title="Permalink to this headline">¶</a></h4>
<p>This class is the common abstract base of both the stand-alone screens
and common widgets to be used inside them. It defines the basic layout,
rendering and event handling framework.</p>
<p>The class defines the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">visible:</th><td class="field-body">Specifies that the view should be painted.</td>
</tr>
<tr class="field-even field"><th class="field-name">active:</th><td class="field-body">Specifies that the view should receive events, if also visible.</td>
</tr>
<tr class="field-odd field"><th class="field-name">view_id:</th><td class="field-body">Specifies an identifier to easily identify the view among subviews.
This is reserved for implementation of top-level views, and should
not be used by widgets for their internal subviews.</td>
</tr>
</tbody>
</table>
<p>It also always has the following fields:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">subviews:</th><td class="field-body">Contains a table of all subviews. The sequence part of the
table is used for iteration. In addition, subviews are also
indexed under their <em>view_id</em>, if any; see <code class="docutils literal"><span class="pre">addviews()</span></code> below.</td>
</tr>
</tbody>
</table>
<p>These fields are computed by the layout process:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">frame_parent_rect:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body">The ViewRect represeting the client area of the parent view.</td>
</tr>
<tr class="field-even field"><th class="field-name">frame_rect:</th><td class="field-body">The <code class="docutils literal"><span class="pre">mkdims</span></code> rect of the outer frame in parent-local coordinates.</td>
</tr>
<tr class="field-odd field"><th class="field-name">frame_body:</th><td class="field-body">The ViewRect representing the body part of the View’s own frame.</td>
</tr>
</tbody>
</table>
<p>The class has the following methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">view:addviews(list)</span></code></p>
<p>Adds the views in the list to the <code class="docutils literal"><span class="pre">subviews</span></code> sequence. If any of the views
in the list have <code class="docutils literal"><span class="pre">view_id</span></code> attributes that don’t conflict with existing keys
in <code class="docutils literal"><span class="pre">subviews</span></code>, also stores them under the string keys. Finally, copies any
non-conflicting string keys from the <code class="docutils literal"><span class="pre">subviews</span></code> tables of the listed views.</p>
<p>Thus, doing something like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="p">:</span><span class="n">addviews</span><span class="p">{</span>
    <span class="n">Panel</span><span class="p">{</span>
        <span class="n">view_id</span> <span class="o">=</span> <span class="s1">&#39;panel&#39;</span><span class="p">,</span>
        <span class="n">subviews</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Label</span><span class="p">{</span> <span class="n">view_id</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Would make the label accessible as both <code class="docutils literal"><span class="pre">self.subviews.label</span></code> and
<code class="docutils literal"><span class="pre">self.subviews.panel.subviews.label</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:getWindowSize()</span></code></p>
<p>Returns the dimensions of the <code class="docutils literal"><span class="pre">frame_body</span></code> rectangle.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:getMousePos()</span></code></p>
<p>Returns the mouse <em>x,y</em> in coordinates local to the <code class="docutils literal"><span class="pre">frame_body</span></code>
rectangle if it is within its clip area, or nothing otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:updateLayout([parent_rect])</span></code></p>
<p>Recomputes layout of the view and its subviews. If no argument is
given, re-uses the previous parent rect. The process goes as follows:</p>
<ol class="arabic simple">
<li>Calls <code class="docutils literal"><span class="pre">preUpdateLayout(parent_rect)</span></code> via <code class="docutils literal"><span class="pre">invoke_before</span></code>.</li>
<li>Uses <code class="docutils literal"><span class="pre">computeFrame(parent_rect)</span></code> to compute the desired frame.</li>
<li>Calls <code class="docutils literal"><span class="pre">postComputeFrame(frame_body)</span></code> via <code class="docutils literal"><span class="pre">invoke_after</span></code>.</li>
<li>Calls <code class="docutils literal"><span class="pre">updateSubviewLayout(frame_body)</span></code> to update children.</li>
<li>Calls <code class="docutils literal"><span class="pre">postUpdateLayout(frame_body)</span></code> via <code class="docutils literal"><span class="pre">invoke_after</span></code>.</li>
</ol>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:computeFrame(parent_rect)</span></code> <em>(for overriding)</em></p>
<p>Called by <code class="docutils literal"><span class="pre">updateLayout</span></code> in order to compute the frame rectangle(s).
Should return the <code class="docutils literal"><span class="pre">mkdims</span></code> rectangle for the outer frame, and optionally
also for the body frame. If only one rectangle is returned, it is used
for both frames, and the margin becomes zero.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:updateSubviewLayout(frame_body)</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">updateLayout</span></code> on all children.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:render(painter)</span></code></p>
<p>Given the parent’s painter, renders the view via the following process:</p>
<ol class="arabic simple">
<li>Calls <code class="docutils literal"><span class="pre">onRenderFrame(painter,</span> <span class="pre">frame_rect)</span></code> to paint the outer frame.</li>
<li>Creates a new painter using the <code class="docutils literal"><span class="pre">frame_body</span></code> rect.</li>
<li>Calls <code class="docutils literal"><span class="pre">onRenderBody(new_painter)</span></code> to paint the client area.</li>
<li>Calls <code class="docutils literal"><span class="pre">renderSubviews(new_painter)</span></code> to paint visible children.</li>
</ol>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:renderSubviews(painter)</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">render</span></code> on all <code class="docutils literal"><span class="pre">visible</span></code> subviews in the order they
appear in the <code class="docutils literal"><span class="pre">subviews</span></code> sequence.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:onRenderFrame(painter,</span> <span class="pre">rect)</span></code> <em>(for overriding)</em></p>
<p>Called by <code class="docutils literal"><span class="pre">render</span></code> to paint the outer frame; by default does nothing.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:onRenderBody(painter)</span></code> <em>(for overriding)</em></p>
<p>Called by <code class="docutils literal"><span class="pre">render</span></code> to paint the client area; by default does nothing.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:onInput(keys)</span></code> <em>(for overriding)</em></p>
<p>Override this to handle events. By default directly calls <code class="docutils literal"><span class="pre">inputToSubviews</span></code>.
Return a true value from this method to signal that the event has been handled
and should not be passed on to more views.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">view:inputToSubviews(keys)</span></code></p>
<p>Calls <code class="docutils literal"><span class="pre">onInput</span></code> on all visible active subviews, iterating the <code class="docutils literal"><span class="pre">subviews</span></code>
sequence in <em>reverse order</em>, so that topmost subviews get events first.
Returns <em>true</em> if any of the subviews handled the event.</p>
</li>
</ul>
</div>
<div class="section" id="screen-class">
<h4><a class="toc-backref" href="#id119">Screen class</a><a class="headerlink" href="#screen-class" title="Permalink to this headline">¶</a></h4>
<p>This is a View subclass intended for use as a stand-alone dialog or screen.
It adds the following methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:isShown()</span></code></p>
<p>Returns <em>true</em> if the screen is currently in the game engine’s display stack.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:isDismissed()</span></code></p>
<p>Returns <em>true</em> if the screen is dismissed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:isActive()</span></code></p>
<p>Returns <em>true</em> if the screen is shown and not dismissed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:invalidate()</span></code></p>
<p>Requests a repaint. Note that currently using it is not necessary, because
repaints are constantly requested automatically, due to issues with native
screens happening otherwise.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:renderParent()</span></code></p>
<p>Asks the parent native screen to render itself, or clears the screen if impossible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:sendInputToParent(...)</span></code></p>
<p>Uses <code class="docutils literal"><span class="pre">simulateInput</span></code> to send keypresses to the native parent screen.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:show([parent])</span></code></p>
<p>Adds the screen to the display stack with the given screen as the parent;
if parent is not specified, places this one one topmost. Before calling
<code class="docutils literal"><span class="pre">dfhack.screen.show</span></code>, calls <code class="docutils literal"><span class="pre">self:onAboutToShow(parent)</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:onAboutToShow(parent)</span></code> <em>(for overriding)</em></p>
<p>Called when <code class="docutils literal"><span class="pre">dfhack.screen.show</span></code> is about to be called.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:onShow()</span></code></p>
<p>Called by <code class="docutils literal"><span class="pre">dfhack.screen.show</span></code> once the screen is successfully shown.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:dismiss()</span></code></p>
<p>Dismisses the screen. A dismissed screen does not receive any more
events or paint requests, but may remain in the display stack for
a short time until the game removes it.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:onDismiss()</span></code> <em>(for overriding)</em></p>
<p>Called by <code class="docutils literal"><span class="pre">dfhack.screen.dismiss()</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:onDestroy()</span></code> <em>(for overriding)</em></p>
<p>Called by the native code when the screen is fully destroyed and removed
from the display stack. Place code that absolutely must be called whenever
the screen is removed by any means here.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">screen:onResize</span></code>, <code class="docutils literal"><span class="pre">screen:onRender</span></code></p>
<p>Defined as callbacks for native code.</p>
</li>
</ul>
</div>
<div class="section" id="framedscreen-class">
<h4><a class="toc-backref" href="#id120">FramedScreen class</a><a class="headerlink" href="#framedscreen-class" title="Permalink to this headline">¶</a></h4>
<p>A Screen subclass that paints a visible frame around its body.
Most dialogs should inherit from this class.</p>
<p>A framed screen has the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">frame_style:</th><td class="field-body">A table that defines a set of pens to draw various parts of the frame.</td>
</tr>
<tr class="field-even field"><th class="field-name">frame_title:</th><td class="field-body">A string to display in the middle of the top of the frame.</td>
</tr>
<tr class="field-odd field"><th class="field-name">frame_width:</th><td class="field-body">Desired width of the client area. If <em>nil</em>, the screen will occupy the whole width.</td>
</tr>
<tr class="field-even field"><th class="field-name">frame_height:</th><td class="field-body">Likewise, for height.</td>
</tr>
<tr class="field-odd field"><th class="field-name">frame_inset:</th><td class="field-body">The gap between the frame and the client area. Defaults to 0.</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">frame_background:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">The pen to fill in the frame with. Defaults to CLEAR_PEN.</td>
</tr>
</tbody>
</table>
<p>There are the following predefined frame style tables:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">GREY_FRAME</span></code></p>
<p>A plain grey-colored frame.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">BOUNDARY_FRAME</span></code></p>
<p>The same frame as used by the usual full-screen DF views, like dwarfmode.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">GREY_LINE_FRAME</span></code></p>
<p>A frame consisting of grey lines, similar to the one used by titan announcements.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="gui-widgets">
<h3><a class="toc-backref" href="#id121">gui.widgets</a><a class="headerlink" href="#gui-widgets" title="Permalink to this headline">¶</a></h3>
<p>This module implements some basic widgets based on the View infrastructure.</p>
<div class="section" id="widget-class">
<h4><a class="toc-backref" href="#id122">Widget class</a><a class="headerlink" href="#widget-class" title="Permalink to this headline">¶</a></h4>
<p>Base of all the widgets. Inherits from View and has the following attributes:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">frame</span> <span class="pre">=</span> <span class="pre">{...}</span></code></p>
<p>Specifies the constraints on the outer frame of the widget.
If omitted, the widget will occupy the whole parent rectangle.</p>
<p>The frame is specified as a table with the following possible fields:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">l:</th><td class="field-body">gap between the left edges of the frame and the parent.</td>
</tr>
<tr class="field-even field"><th class="field-name">t:</th><td class="field-body">gap between the top edges of the frame and the parent.</td>
</tr>
<tr class="field-odd field"><th class="field-name">r:</th><td class="field-body">gap between the right edges of the frame and the parent.</td>
</tr>
<tr class="field-even field"><th class="field-name">b:</th><td class="field-body">gap between the bottom edges of the frame and the parent.</td>
</tr>
<tr class="field-odd field"><th class="field-name">w:</th><td class="field-body">maximum width of the frame.</td>
</tr>
<tr class="field-even field"><th class="field-name">h:</th><td class="field-body">maximum heigth of the frame.</td>
</tr>
<tr class="field-odd field"><th class="field-name">xalign:</th><td class="field-body">X alignment of the frame.</td>
</tr>
<tr class="field-even field"><th class="field-name">yalign:</th><td class="field-body">Y alignment of the frame.</td>
</tr>
</tbody>
</table>
<p>First the <code class="docutils literal"><span class="pre">l,t,r,b</span></code> fields restrict the available area for
placing the frame. If <code class="docutils literal"><span class="pre">w</span></code> and <code class="docutils literal"><span class="pre">h</span></code> are not specified or
larger then the computed area, it becomes the frame. Otherwise
the smaller frame is placed within the are based on the
<code class="docutils literal"><span class="pre">xalign/yalign</span></code> fields. If the align hints are omitted, they
are assumed to be 0, 1, or 0.5 based on which of the <code class="docutils literal"><span class="pre">l/r/t/b</span></code>
fields are set.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">frame_inset</span> <span class="pre">=</span> <span class="pre">{...}</span></code></p>
<p>Specifies the gap between the outer frame, and the client area.
The attribute may be a simple integer value to specify a uniform
inset, or a table with the following fields:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">l:</th><td class="field-body">left margin.</td>
</tr>
<tr class="field-even field"><th class="field-name">t:</th><td class="field-body">top margin.</td>
</tr>
<tr class="field-odd field"><th class="field-name">r:</th><td class="field-body">right margin.</td>
</tr>
<tr class="field-even field"><th class="field-name">b:</th><td class="field-body">bottom margin.</td>
</tr>
<tr class="field-odd field"><th class="field-name">x:</th><td class="field-body">left/right margin, if <code class="docutils literal"><span class="pre">l</span></code> and/or <code class="docutils literal"><span class="pre">r</span></code> are omitted.</td>
</tr>
<tr class="field-even field"><th class="field-name">y:</th><td class="field-body">top/bottom margin, if <code class="docutils literal"><span class="pre">t</span></code> and/or <code class="docutils literal"><span class="pre">b</span></code> are omitted.</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">frame_background</span> <span class="pre">=</span> <span class="pre">pen</span></code></p>
<p>The pen to fill the outer frame with. Defaults to no fill.</p>
</li>
</ul>
</div>
<div class="section" id="panel-class">
<h4><a class="toc-backref" href="#id123">Panel class</a><a class="headerlink" href="#panel-class" title="Permalink to this headline">¶</a></h4>
<p>Inherits from Widget, and intended for grouping a number of subviews.</p>
<p>Has attributes:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">subviews</span> <span class="pre">=</span> <span class="pre">{}</span></code></p>
<p>Used to initialize the subview list in the constructor.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">on_render</span> <span class="pre">=</span> <span class="pre">function(painter)</span></code></p>
<p>Called from <code class="docutils literal"><span class="pre">onRenderBody</span></code>.</p>
</li>
</ul>
</div>
<div class="section" id="pages-class">
<h4><a class="toc-backref" href="#id124">Pages class</a><a class="headerlink" href="#pages-class" title="Permalink to this headline">¶</a></h4>
<p>Subclass of Panel; keeps exactly one child visible.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">Pages{</span> <span class="pre">...,</span> <span class="pre">selected</span> <span class="pre">=</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>Specifies which child to select initially; defaults to the first one.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pages:getSelected()</span></code></p>
<p>Returns the selected <em>index, child</em>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pages:setSelected(index)</span></code></p>
<p>Selects the specified child, hiding the previous selected one.
It is permitted to use the subview object, or its <code class="docutils literal"><span class="pre">view_id</span></code> as index.</p>
</li>
</ul>
</div>
<div class="section" id="editfield-class">
<h4><a class="toc-backref" href="#id125">EditField class</a><a class="headerlink" href="#editfield-class" title="Permalink to this headline">¶</a></h4>
<p>Subclass of Widget; implements a simple edit field.</p>
<p>Attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">text:</th><td class="field-body">The current contents of the field.</td>
</tr>
<tr class="field-even field"><th class="field-name">text_pen:</th><td class="field-body">The pen to draw the text with.</td>
</tr>
<tr class="field-odd field"><th class="field-name">on_char:</th><td class="field-body">Input validation callback; used as <code class="docutils literal"><span class="pre">on_char(new_char,text)</span></code>.
If it returns false, the character is ignored.</td>
</tr>
<tr class="field-even field"><th class="field-name">on_change:</th><td class="field-body">Change notification callback; used as <code class="docutils literal"><span class="pre">on_change(new_text,old_text)</span></code>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">on_submit:</th><td class="field-body">Enter key callback; if set the field will handle the key and call <code class="docutils literal"><span class="pre">on_submit(text)</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">key:</th><td class="field-body">If specified, the field is disabled until this key is pressed. Must be given as a string.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="label-class">
<h4><a class="toc-backref" href="#id126">Label class</a><a class="headerlink" href="#label-class" title="Permalink to this headline">¶</a></h4>
<p>This Widget subclass implements flowing semi-static text.</p>
<p>It has the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">text_pen:</th><td class="field-body">Specifies the pen for active text.</td>
</tr>
<tr class="field-even field"><th class="field-name">text_dpen:</th><td class="field-body">Specifies the pen for disabled text.</td>
</tr>
<tr class="field-odd field"><th class="field-name">text_hpen:</th><td class="field-body">Specifies the pen for text hovered over by the mouse, if a click handler is registered.</td>
</tr>
<tr class="field-even field"><th class="field-name">disabled:</th><td class="field-body">Boolean or a callback; if true, the label is disabled.</td>
</tr>
<tr class="field-odd field"><th class="field-name">enabled:</th><td class="field-body">Boolean or a callback; if false, the label is disabled.</td>
</tr>
<tr class="field-even field"><th class="field-name">auto_height:</th><td class="field-body">Sets self.frame.h from the text height.</td>
</tr>
<tr class="field-odd field"><th class="field-name">auto_width:</th><td class="field-body">Sets self.frame.w from the text width.</td>
</tr>
<tr class="field-even field"><th class="field-name">on_click:</th><td class="field-body">A callback called when the label is clicked (optional)</td>
</tr>
<tr class="field-odd field"><th class="field-name">on_rclick:</th><td class="field-body">A callback called when the label is right-clicked (optional)</td>
</tr>
</tbody>
</table>
<p>The text itself is represented as a complex structure, and passed
to the object via the <code class="docutils literal"><span class="pre">text</span></code> argument of the constructor, or via
the <code class="docutils literal"><span class="pre">setText</span></code> method, as one of:</p>
<ul class="simple">
<li>A simple string, possibly containing newlines.</li>
<li>A sequence of tokens.</li>
</ul>
<p>Every token in the sequence in turn may be either a string, possibly
containing newlines, or a table with the following possible fields:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">token.text</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>Specifies the main text content of a token, and may be a string, or
a callback returning a string.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.gap</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>Specifies the number of character positions to advance on the line
before rendering the token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.tile</span> <span class="pre">=</span> <span class="pre">pen</span></code></p>
<p>Specifies a pen to paint as one tile before the main part of the token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.width</span> <span class="pre">=</span> <span class="pre">...</span></code></p>
<p>If specified either as a value or a callback, the text field is padded
or truncated to the specified number.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.pad_char</span> <span class="pre">=</span> <span class="pre">'?'</span></code></p>
<p>If specified together with <code class="docutils literal"><span class="pre">width</span></code>, the padding area is filled with
this character instead of just being skipped over.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.key</span> <span class="pre">=</span> <span class="pre">'...'</span></code></p>
<p>Specifies the keycode associated with the token. The string description
of the key binding is added to the text content of the token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.key_sep</span> <span class="pre">=</span> <span class="pre">'...'</span></code></p>
<p>Specifies the separator to place between the keybinding label produced
by <code class="docutils literal"><span class="pre">token.key</span></code>, and the main text of the token. If the separator is
‘()’, the token is formatted as <code class="docutils literal"><span class="pre">text..'</span> <span class="pre">('..binding..')'</span></code>. Otherwise
it is simply <code class="docutils literal"><span class="pre">binding..sep..text</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.enabled</span></code>, <code class="docutils literal"><span class="pre">token.disabled</span></code></p>
<p>Same as the attributes of the label itself, but applies only to the token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.pen</span></code>, <code class="docutils literal"><span class="pre">token.dpen</span></code></p>
<p>Specify the pen and disabled pen to be used for the token’s text.
The field may be either the pen itself, or a callback that returns it.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.on_activate</span></code></p>
<p>If this field is not nil, and <code class="docutils literal"><span class="pre">token.key</span></code> is set, the token will actually
respond to that key binding unless disabled, and call this callback. Eventually
this may be extended with mouse click support.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.id</span></code></p>
<p>Specifies a unique identifier for the token.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">token.line</span></code>, <code class="docutils literal"><span class="pre">token.x1</span></code>, <code class="docutils literal"><span class="pre">token.x2</span></code></p>
<p>Reserved for internal use.</p>
</li>
</ul>
<p>The Label widget implements the following methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">label:setText(new_text)</span></code></p>
<p>Replaces the text currently contained in the widget.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">label:itemById(id)</span></code></p>
<p>Finds a token by its <code class="docutils literal"><span class="pre">id</span></code> field.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">label:getTextHeight()</span></code></p>
<p>Computes the height of the text.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">label:getTextWidth()</span></code></p>
<p>Computes the width of the text.</p>
</li>
</ul>
</div>
<div class="section" id="list-class">
<h4><a class="toc-backref" href="#id127">List class</a><a class="headerlink" href="#list-class" title="Permalink to this headline">¶</a></h4>
<p>The List widget implements a simple list with paging.</p>
<p>It has the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">text_pen:</th><td class="field-body">Specifies the pen for deselected list entries.</td>
</tr>
<tr class="field-even field"><th class="field-name">cursor_pen:</th><td class="field-body">Specifies the pen for the selected entry.</td>
</tr>
<tr class="field-odd field"><th class="field-name">inactive_pen:</th><td class="field-body">If specified, used for the cursor when the widget is not active.</td>
</tr>
<tr class="field-even field"><th class="field-name">icon_pen:</th><td class="field-body">Default pen for icons.</td>
</tr>
<tr class="field-odd field"><th class="field-name">on_select:</th><td class="field-body">Selection change callback; called as <code class="docutils literal"><span class="pre">on_select(index,choice)</span></code>.
This is also called with <em>nil</em> arguments if <code class="docutils literal"><span class="pre">setChoices</span></code> is called
with an empty list.</td>
</tr>
<tr class="field-even field"><th class="field-name">on_submit:</th><td class="field-body">Enter key callback; if specified, the list reacts to the key
and calls it as <code class="docutils literal"><span class="pre">on_submit(index,choice)</span></code>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">on_submit2:</th><td class="field-body">Shift-Enter key callback; if specified, the list reacts to the key
and calls it as <code class="docutils literal"><span class="pre">on_submit2(index,choice)</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">row_height:</th><td class="field-body">Height of every row in text lines.</td>
</tr>
<tr class="field-odd field"><th class="field-name">icon_width:</th><td class="field-body">If not <em>nil</em>, the specified number of character columns
are reserved to the left of the list item for the icons.</td>
</tr>
<tr class="field-even field"><th class="field-name">scroll_keys:</th><td class="field-body">Specifies which keys the list should react to as a table.</td>
</tr>
</tbody>
</table>
<p>Every list item may be specified either as a string, or as a lua table
with the following fields:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">text:</th><td class="field-body">Specifies the label text in the same format as the Label text.</td>
</tr>
<tr class="field-even field"><th class="field-name">caption, [1]:</th><td class="field-body">Deprecated legacy aliases for <strong>text</strong>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">text_*:</th><td class="field-body">Reserved for internal use.</td>
</tr>
<tr class="field-even field"><th class="field-name">key:</th><td class="field-body">Specifies a keybinding that acts as a shortcut for the specified item.</td>
</tr>
<tr class="field-odd field"><th class="field-name">icon:</th><td class="field-body">Specifies an icon string, or a pen to paint a single character. May be a callback.</td>
</tr>
<tr class="field-even field"><th class="field-name">icon_pen:</th><td class="field-body">When the icon is a string, used to paint it.</td>
</tr>
</tbody>
</table>
<p>The list supports the following methods:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">List{</span> <span class="pre">...,</span> <span class="pre">choices</span> <span class="pre">=</span> <span class="pre">...,</span> <span class="pre">selected</span> <span class="pre">=</span> <span class="pre">...</span> <span class="pre">}</span></code></p>
<p>Same as calling <code class="docutils literal"><span class="pre">setChoices</span></code> after construction.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:setChoices(choices[,</span> <span class="pre">selected])</span></code></p>
<p>Replaces the list of choices, possibly also setting the currently selected index.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:setSelected(selected)</span></code></p>
<p>Sets the currently selected index. Returns the index after validation.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getChoices()</span></code></p>
<p>Returns the list of choices.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getSelected()</span></code></p>
<p>Returns the selected <em>index, choice</em>, or nothing if the list is empty.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getContentWidth()</span></code></p>
<p>Returns the minimal width to draw all choices without clipping.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getContentHeight()</span></code></p>
<p>Returns the minimal width to draw all choices without scrolling.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:submit()</span></code></p>
<p>Call the <code class="docutils literal"><span class="pre">on_submit</span></code> callback, as if the Enter key was handled.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:submit2()</span></code></p>
<p>Call the <code class="docutils literal"><span class="pre">on_submit2</span></code> callback, as if the Shift-Enter key was handled.</p>
</li>
</ul>
</div>
<div class="section" id="filteredlist-class">
<h4><a class="toc-backref" href="#id128">FilteredList class</a><a class="headerlink" href="#filteredlist-class" title="Permalink to this headline">¶</a></h4>
<p>This widget combines List, EditField and Label into a combo-box like
construction that allows filtering the list by subwords of its items.</p>
<p>In addition to passing through all attributes supported by List, it
supports:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">edit_pen:</th><td class="field-body">If specified, used instead of <code class="docutils literal"><span class="pre">cursor_pen</span></code> for the edit field.</td>
</tr>
<tr class="field-even field"><th class="field-name">edit_below:</th><td class="field-body">If true, the edit field is placed below the list instead of above.</td>
</tr>
<tr class="field-odd field"><th class="field-name">edit_key:</th><td class="field-body">If specified, the edit field is disabled until this key is pressed.</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">not_found_label:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">Specifies the text of the label shown when no items match the filter.</td>
</tr>
</tbody>
</table>
<p>The list choices may include the following attributes:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">search_key:</th><td class="field-body">If specified, used instead of <strong>text</strong> to match against the filter.
This is required for any entries where <strong>text</strong> is not a string.</td>
</tr>
</tbody>
</table>
<p>The widget implements:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">list:setChoices(choices[,</span> <span class="pre">selected])</span></code></p>
<p>Resets the filter, and passes through to the inner list.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getChoices()</span></code></p>
<p>Returns the list of <em>all</em> choices.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getVisibleChoices()</span></code></p>
<p>Returns the <em>filtered</em> list of choices.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getFilter()</span></code></p>
<p>Returns the current filter string, and the <em>filtered</em> list of choices.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:setFilter(filter[,pos])</span></code></p>
<p>Sets the new filter string, filters the list, and selects the item at
index <code class="docutils literal"><span class="pre">pos</span></code> in the <em>unfiltered</em> list if possible.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:canSubmit()</span></code></p>
<p>Checks if there are currently any choices in the filtered list.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">list:getSelected()</span></code>, <code class="docutils literal"><span class="pre">list:getContentWidth()</span></code>, <code class="docutils literal"><span class="pre">list:getContentHeight()</span></code>, <code class="docutils literal"><span class="pre">list:submit()</span></code></p>
<p>Same as with an ordinary list.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="plugins">
<span id="lua-plugins"></span><h2><a class="toc-backref" href="#id34">Plugins</a><a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id6">
<ul class="simple">
<li><a class="reference internal" href="#blueprint" id="id129">blueprint</a></li>
<li><a class="reference internal" href="#burrows" id="id130">burrows</a></li>
<li><a class="reference internal" href="#sort" id="id131">sort</a></li>
<li><a class="reference internal" href="#eventful" id="id132">Eventful</a><ul>
<li><a class="reference internal" href="#list-of-events" id="id133">List of events</a></li>
<li><a class="reference internal" href="#events-from-eventmanager" id="id134">Events from EventManager</a></li>
<li><a class="reference internal" href="#functions" id="id135">Functions</a></li>
<li><a class="reference internal" href="#id8" id="id136">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-hacks" id="id137">Building-hacks</a><ul>
<li><a class="reference internal" href="#id10" id="id138">Functions</a></li>
<li><a class="reference internal" href="#id11" id="id139">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#luasocket" id="id140">Luasocket</a><ul>
<li><a class="reference internal" href="#socket-class" id="id141">Socket class</a></li>
<li><a class="reference internal" href="#client-class" id="id142">Client class</a></li>
<li><a class="reference internal" href="#server-class" id="id143">Server class</a></li>
<li><a class="reference internal" href="#tcp-class" id="id144">Tcp class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cxxrandom" id="id145">cxxrandom</a><ul>
<li><a class="reference internal" href="#native-functions-exported-to-lua" id="id146">Native functions (exported to Lua)</a></li>
<li><a class="reference internal" href="#lua-plugin-functions" id="id147">Lua plugin functions</a></li>
<li><a class="reference internal" href="#lua-plugin-classes" id="id148">Lua plugin classes</a><ul>
<li><a class="reference internal" href="#crng" id="id149"><code class="docutils literal"><span class="pre">crng</span></code></a></li>
<li><a class="reference internal" href="#normal-distribution" id="id150"><code class="docutils literal"><span class="pre">normal_distribution</span></code></a></li>
<li><a class="reference internal" href="#real-distribution" id="id151"><code class="docutils literal"><span class="pre">real_distribution</span></code></a></li>
<li><a class="reference internal" href="#int-distribution" id="id152"><code class="docutils literal"><span class="pre">int_distribution</span></code></a></li>
<li><a class="reference internal" href="#bool-distribution" id="id153"><code class="docutils literal"><span class="pre">bool_distribution</span></code></a></li>
<li><a class="reference internal" href="#num-sequence" id="id154"><code class="docutils literal"><span class="pre">num_sequence</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>DFHack plugins may export native functions and events
to lua contexts. They are automatically imported by
<code class="docutils literal"><span class="pre">mkmodule('plugins.&lt;name&gt;')</span></code>; this means that a lua
module file is still necessary for <code class="docutils literal"><span class="pre">require</span></code> to read.</p>
<p>The following plugins have lua support.</p>
<div class="section" id="blueprint">
<h3><a class="toc-backref" href="#id129">blueprint</a><a class="headerlink" href="#blueprint" title="Permalink to this headline">¶</a></h3>
<p>Native functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dig(start,</span> <span class="pre">end,</span> <span class="pre">name)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">build(start,</span> <span class="pre">end,</span> <span class="pre">name)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">place(start,</span> <span class="pre">end,</span> <span class="pre">name)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">query(start,</span> <span class="pre">end,</span> <span class="pre">name)</span></code></p>
<p><code class="docutils literal"><span class="pre">start</span></code> and <code class="docutils literal"><span class="pre">end</span></code> are tables containing positions (see
<code class="docutils literal"><span class="pre">xyz2pos</span></code>). <code class="docutils literal"><span class="pre">name</span></code> is used as the basis for the filename.</p>
</li>
</ul>
</div>
<div class="section" id="burrows">
<h3><a class="toc-backref" href="#id130">burrows</a><a class="headerlink" href="#burrows" title="Permalink to this headline">¶</a></h3>
<p>Implements extended burrow manipulations.</p>
<p>Events:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">onBurrowRename.foo</span> <span class="pre">=</span> <span class="pre">function(burrow)</span></code></p>
<p>Emitted when a burrow might have been renamed either through
the game UI, or <code class="docutils literal"><span class="pre">renameBurrow()</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onDigComplete.foo</span> <span class="pre">=</span> <span class="pre">function(job_type,pos,old_tiletype,new_tiletype,worker)</span></code></p>
<p>Emitted when a tile might have been dug out. Only tracked if the
auto-growing burrows feature is enabled.</p>
</li>
</ul>
<p>Native functions:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">renameBurrow(burrow,name)</span></code></p>
<p>Renames the burrow, emitting <code class="docutils literal"><span class="pre">onBurrowRename</span></code> and updating auto-grow state properly.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">findByName(burrow,name)</span></code></p>
<p>Finds a burrow by name, using the same rules as the plugin command line interface.
Namely, trailing <code class="docutils literal"><span class="pre">'+'</span></code> characters marking auto-grow burrows are ignored.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">copyUnits(target,source,enable)</span></code></p>
<p>Applies units from <code class="docutils literal"><span class="pre">source</span></code> burrow to <code class="docutils literal"><span class="pre">target</span></code>. The <code class="docutils literal"><span class="pre">enable</span></code>
parameter specifies if they are to be added or removed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">copyTiles(target,source,enable)</span></code></p>
<p>Applies tiles from <code class="docutils literal"><span class="pre">source</span></code> burrow to <code class="docutils literal"><span class="pre">target</span></code>. The <code class="docutils literal"><span class="pre">enable</span></code>
parameter specifies if they are to be added or removed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">setTilesByKeyword(target,keyword,enable)</span></code></p>
<p>Adds or removes tiles matching a predefined keyword. The keyword
set is the same as used by the command line.</p>
</li>
</ul>
<p>The lua module file also re-exports functions from <code class="docutils literal"><span class="pre">dfhack.burrows</span></code>.</p>
</div>
<div class="section" id="sort">
<h3><a class="toc-backref" href="#id131">sort</a><a class="headerlink" href="#sort" title="Permalink to this headline">¶</a></h3>
<p>Does not export any native functions as of now. Instead, it
calls lua code to perform the actual ordering of list items.</p>
</div>
<div class="section" id="eventful">
<span id="id7"></span><h3><a class="toc-backref" href="#id132">Eventful</a><a class="headerlink" href="#eventful" title="Permalink to this headline">¶</a></h3>
<p>This plugin exports some events to lua thus allowing to run lua functions
on DF world events.</p>
<div class="section" id="list-of-events">
<h4><a class="toc-backref" href="#id133">List of events</a><a class="headerlink" href="#list-of-events" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first"><code class="docutils literal"><span class="pre">onReactionComplete(reaction,reaction_product,unit,input_items,input_reagents,output_items,call_native)</span></code></p>
<p>Auto activates if detects reactions starting with <code class="docutils literal"><span class="pre">LUA_HOOK_</span></code>. Is called when reaction finishes.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onItemContaminateWound(item,unit,wound,number1,number2)</span></code></p>
<p>Is called when item tries to contaminate wound (e.g. stuck in).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onProjItemCheckMovement(projectile)</span></code></p>
<p>Is called when projectile moves.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onProjItemCheckImpact(projectile,somebool)</span></code></p>
<p>Is called when projectile hits something.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onProjUnitCheckMovement(projectile)</span></code></p>
<p>Is called when projectile moves.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onProjUnitCheckImpact(projectile,somebool)</span></code></p>
<p>Is called when projectile hits something.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onWorkshopFillSidebarMenu(workshop,callnative)</span></code></p>
<p>Is called when viewing a workshop in ‘q’ mode, to populate reactions, useful for custom viewscreens for shops.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">postWorkshopFillSidebarMenu(workshop)</span></code></p>
<p>Is called after calling (or not) native fillSidebarMenu(). Useful for job button
tweaking (e.g. adding custom reactions)</p>
</li>
</ol>
</div>
<div class="section" id="events-from-eventmanager">
<span id="eventmanager"></span><h4><a class="toc-backref" href="#id134">Events from EventManager</a><a class="headerlink" href="#events-from-eventmanager" title="Permalink to this headline">¶</a></h4>
<p>These events are straight from EventManager module. Each of them first needs to be enabled. See functions for more info. If you register a listener before the game is loaded, be aware that no events will be triggered immediately after loading, so you might need to add another event listener for when the game first loads in some cases.</p>
<ol class="arabic">
<li><p class="first"><code class="docutils literal"><span class="pre">onBuildingCreatedDestroyed(building_id)</span></code></p>
<p>Gets called when building is created or destroyed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onConstructionCreatedDestroyed(building_id)</span></code></p>
<p>Gets called when construction is created or destroyed.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onJobInitiated(job)</span></code></p>
<p>Gets called when job is issued.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onJobCompleted(job)</span></code></p>
<p>Gets called when job is finished. The job that is passed to this function is a copy. Requires a frequency of 0 in order to distinguish between workshop jobs that were cancelled by the user and workshop jobs that completed successfully.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onUnitDeath(unit_id)</span></code></p>
<p>Gets called on unit death.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onItemCreated(item_id)</span></code></p>
<p>Gets called when item is created (except due to traders, migrants, invaders and spider webs).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onSyndrome(unit_id,syndrome_index)</span></code></p>
<p>Gets called when new syndrome appears on a unit.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onInvasion(invasion_id)</span></code></p>
<p>Gets called when new invasion happens.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onInventoryChange(unit_id,item_id,old_equip,new_equip)</span></code></p>
<p>Gets called when someone picks up an item, puts one down, or changes the way they are holding it. If an item is picked up, old_equip will be null. If an item is dropped, new_equip will be null. If an item is re-equipped in a new way, then neither will be null. You absolutely must NOT alter either old_equip or new_equip or you might break other plugins.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onReport(reportId)</span></code></p>
<p>Gets called when a report happens. This happens more often than you probably think, even if it doesn’t show up in the announcements.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onUnitAttack(attackerId,</span> <span class="pre">defenderId,</span> <span class="pre">woundId)</span></code></p>
<p>Called when a unit wounds another with a weapon. Is NOT called if blocked, dodged, deflected, or parried.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onUnload()</span></code></p>
<p>A convenience event in case you don’t want to register for every onStateChange event.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">onInteraction(attackVerb,</span> <span class="pre">defendVerb,</span> <span class="pre">attackerId,</span> <span class="pre">defenderId,</span> <span class="pre">attackReportId,</span> <span class="pre">defendReportId)</span></code></p>
<p>Called when a unit uses an interaction on another.</p>
</li>
</ol>
</div>
<div class="section" id="functions">
<h4><a class="toc-backref" href="#id135">Functions</a><a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first"><code class="docutils literal"><span class="pre">registerReaction(reaction_name,callback)</span></code></p>
<p>Simplified way of using onReactionComplete; the callback is function (same params as event).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">removeNative(shop_name)</span></code></p>
<p>Removes native choice list from the building.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">addReactionToShop(reaction_name,shop_name)</span></code></p>
<p>Add a custom reaction to the building.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">enableEvent(evType,frequency)</span></code></p>
<p>Enable event checking for EventManager events. For event types use <code class="docutils literal"><span class="pre">eventType</span></code> table. Note that different types of events require different frequencies to be effective. The frequency is how many ticks EventManager will wait before checking if that type of event has happened. If multiple scripts or plugins use the same event type, the smallest frequency is the one that is used, so you might get events triggered more often than the frequency you use here.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">registerSidebar(shop_name,callback)</span></code></p>
<p>Enable callback when sidebar for <code class="docutils literal"><span class="pre">shop_name</span></code> is drawn. Usefull for custom workshop views e.g. using gui.dwarfmode lib. Also accepts a <code class="docutils literal"><span class="pre">class</span></code> instead of function
as callback. Best used with <code class="docutils literal"><span class="pre">gui.dwarfmode</span></code> class <code class="docutils literal"><span class="pre">WorkshopOverlay</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id136">Examples</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Spawn dragon breath on each item attempt to contaminate wound:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">=</span><span class="n">require</span> <span class="s2">&quot;plugins.eventful&quot;</span>
<span class="n">b</span><span class="o">.</span><span class="n">onItemContaminateWound</span><span class="o">.</span><span class="n">one</span><span class="o">=</span><span class="n">function</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">un_wound</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">flw</span><span class="o">=</span><span class="n">dfhack</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">spawnFlow</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">50000</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Reaction complete example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">=</span><span class="n">require</span> <span class="s2">&quot;plugins.eventful&quot;</span>

<span class="n">b</span><span class="o">.</span><span class="n">registerReaction</span><span class="p">(</span><span class="s2">&quot;LUA_HOOK_LAY_BOMB&quot;</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">reaction</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">in_items</span><span class="p">,</span><span class="n">in_reag</span><span class="p">,</span><span class="n">out_items</span><span class="p">,</span><span class="n">call_native</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">pos</span><span class="o">=</span><span class="n">copyall</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
  <span class="o">--</span> <span class="n">spawn</span> <span class="n">dragonbreath</span> <span class="n">after</span> <span class="mi">100</span> <span class="n">ticks</span>
  <span class="n">dfhack</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span><span class="n">function</span><span class="p">()</span> <span class="n">dfhack</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">spawnFlow</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">50000</span><span class="p">)</span> <span class="n">end</span><span class="p">)</span>
  <span class="o">--</span><span class="n">do</span> <span class="ow">not</span> <span class="n">call</span> <span class="n">real</span> <span class="n">item</span> <span class="n">creation</span> <span class="n">code</span>
  <span class="n">call_native</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">false</span>
<span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<p>Grenade example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">=</span><span class="n">require</span> <span class="s2">&quot;plugins.eventful&quot;</span>
<span class="n">b</span><span class="o">.</span><span class="n">onProjItemCheckImpact</span><span class="o">.</span><span class="n">one</span><span class="o">=</span><span class="n">function</span><span class="p">(</span><span class="n">projectile</span><span class="p">)</span>
  <span class="o">--</span> <span class="n">you</span> <span class="n">can</span> <span class="n">check</span> <span class="k">if</span> <span class="n">projectile</span><span class="o">.</span><span class="n">item</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">has</span> <span class="n">correct</span> <span class="n">material</span>
  <span class="n">dfhack</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">spawnFlow</span><span class="p">(</span><span class="n">projectile</span><span class="o">.</span><span class="n">cur_pos</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">50000</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Integrated tannery:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">=</span><span class="n">require</span> <span class="s2">&quot;plugins.eventful&quot;</span>
<span class="n">b</span><span class="o">.</span><span class="n">addReactionToShop</span><span class="p">(</span><span class="s2">&quot;TAN_A_HIDE&quot;</span><span class="p">,</span><span class="s2">&quot;LEATHERWORKS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="building-hacks">
<span id="id9"></span><h3><a class="toc-backref" href="#id137">Building-hacks</a><a class="headerlink" href="#building-hacks" title="Permalink to this headline">¶</a></h3>
<p>This plugin overwrites some methods in workshop df class so that mechanical workshops are possible. Although
plugin export a function it’s recommended to use lua decorated function.</p>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id138">Functions</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">registerBuilding(table)</span></code> where table must contain name, as a workshop raw name, the rest are optional:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body"><p class="first">custom workshop id e.g. <code class="docutils literal"><span class="pre">SOAPMAKER</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this is the only mandatory field.</p>
</div>
</td>
</tr>
<tr class="field-even field"><th class="field-name">fix_impassible:</th><td class="field-body"><p class="first">if true make impassible tiles impassible to liquids too</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">consume:</th><td class="field-body"><p class="first">how much machine power is needed to work.
Disables reactions if not supplied enough and <code class="docutils literal"><span class="pre">needs_power==1</span></code></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">produce:</th><td class="field-body"><p class="first">how much machine power is produced.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">needs_power:</th><td class="field-body"><p class="first">if produced in network &lt; consumed stop working, default true</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">gears:</th><td class="field-body"><p class="first">a table or <code class="docutils literal"><span class="pre">{x=?,y=?}</span></code> of connection points for machines.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">action:</th><td class="field-body"><p class="first">a table of number (how much ticks to skip) and a function which
gets called on shop update</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">animate:</th><td class="field-body"><p class="first">a table of frames which can be a table of:</p>
<ol class="loweralpha simple">
<li>tables of 4 numbers <code class="docutils literal"><span class="pre">{tile,fore,back,bright}</span></code> OR</li>
<li>empty table (tile not modified) OR</li>
<li><code class="docutils literal"><span class="pre">{x=&lt;number&gt;</span> <span class="pre">y=&lt;number&gt;</span> <span class="pre">+</span> <span class="pre">4</span> <span class="pre">numbers</span> <span class="pre">like</span> <span class="pre">in</span> <span class="pre">first</span> <span class="pre">case}</span></code>,
this generates full frame useful for animations that change little (1-2 tiles)</li>
</ol>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">canBeRoomSubset:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body"><p class="first">a flag if this building can be counted in room. 1 means it can, 0 means it can’t and -1 default building behaviour</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">auto_gears:</th><td class="field-body"><p class="first last">a flag that automatically fills up gears and animate. It looks over building definition for gear icons and maps them.</p>
</td>
</tr>
</tbody>
</table>
<p>Animate table also might contain:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">frameLength:</th><td class="field-body">how many ticks does one frame take OR</td>
</tr>
<tr class="field-even field"><th class="field-name">isMechanical:</th><td class="field-body">a bool that says to try to match to mechanical system (i.e. how gears are turning)</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">getPower(building)</span></code> returns two number - produced and consumed power if building can be modified and returns nothing otherwise</p>
<p><code class="docutils literal"><span class="pre">setPower(building,produced,consumed)</span></code> sets current productiona and consumption for a building.</p>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id139">Examples</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>Simple mechanical workshop:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;plugins.building-hacks&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">registerBuilding</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BONE_GRINDER&quot;</span><span class="p">,</span>
  <span class="n">consume</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
  <span class="n">gears</span><span class="o">=</span><span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">},</span> <span class="o">--</span><span class="n">connection</span> <span class="n">point</span>
  <span class="n">animate</span><span class="o">=</span><span class="p">{</span>
    <span class="n">isMechanical</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="o">--</span><span class="n">animate</span> <span class="n">the</span> <span class="n">same</span> <span class="n">conn</span><span class="o">.</span> <span class="n">point</span> <span class="k">as</span> <span class="n">vanilla</span> <span class="n">gear</span>
    <span class="n">frames</span><span class="o">=</span><span class="p">{</span>
    <span class="p">{{</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}},</span> <span class="o">--</span><span class="n">first</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">1</span> <span class="n">changed</span> <span class="n">tile</span>
    <span class="p">{{</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}}</span> <span class="o">--</span> <span class="n">second</span> <span class="n">frame</span><span class="p">,</span> <span class="n">same</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Or with auto_gears:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;plugins.building-hacks&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">registerBuilding</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BONE_GRINDER&quot;</span><span class="p">,</span>
  <span class="n">consume</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
  <span class="n">auto_gears</span><span class="o">=</span><span class="n">true</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="luasocket">
<span id="id12"></span><h3><a class="toc-backref" href="#id140">Luasocket</a><a class="headerlink" href="#luasocket" title="Permalink to this headline">¶</a></h3>
<p>A way to access csocket from lua. The usage is made similar to luasocket in vanilla lua distributions. Currently
only subset of functions exist and only tcp mode is implemented.</p>
<div class="section" id="socket-class">
<h4><a class="toc-backref" href="#id141">Socket class</a><a class="headerlink" href="#socket-class" title="Permalink to this headline">¶</a></h4>
<p>This is a base class for <code class="docutils literal"><span class="pre">client</span></code> and <code class="docutils literal"><span class="pre">server</span></code> sockets. You can not create it - it’s like a virtual
base class in c++.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">socket:close()</span></code></p>
<p>Closes the connection.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">socket:setTimeout(sec,msec)</span></code></p>
<p>Sets the operation timeout for this socket. It’s possible to set timeout to 0. Then it performs like
a non-blocking socket.</p>
</li>
</ul>
</div>
<div class="section" id="client-class">
<h4><a class="toc-backref" href="#id142">Client class</a><a class="headerlink" href="#client-class" title="Permalink to this headline">¶</a></h4>
<p>Client is a connection socket to a server. You can get this object either from <code class="docutils literal"><span class="pre">tcp:connect(address,port)</span></code> or
from <code class="docutils literal"><span class="pre">server:accept()</span></code>. It’s a subclass of <code class="docutils literal"><span class="pre">socket</span></code>.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">client:receive(pattern)</span></code></p>
<p>Receives data.  Pattern is one of:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">*l</span></code>:</th><td class="field-body">read one line (default, if pattern is <em>nil</em>)</td>
</tr>
<tr class="field-even field"><th class="field-name">&lt;number&gt;:</th><td class="field-body">read specified number of bytes</td>
</tr>
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">*a</span></code>:</th><td class="field-body">read all available data</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">client:send(data)</span></code></p>
<p>Sends data. Data is a string.</p>
</li>
</ul>
</div>
<div class="section" id="server-class">
<h4><a class="toc-backref" href="#id143">Server class</a><a class="headerlink" href="#server-class" title="Permalink to this headline">¶</a></h4>
<p>Server is a socket that is waiting for clients.
You can get this object from <code class="docutils literal"><span class="pre">tcp:bind(address,port)</span></code>.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">server:accept()</span></code></p>
<p>Accepts an incoming connection if it exists.
Returns a <code class="docutils literal"><span class="pre">client</span></code> object representing that socket.</p>
</li>
</ul>
</div>
<div class="section" id="tcp-class">
<h4><a class="toc-backref" href="#id144">Tcp class</a><a class="headerlink" href="#tcp-class" title="Permalink to this headline">¶</a></h4>
<p>A class with all the tcp functionality.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">tcp:bind(address,port)</span></code></p>
<p>Starts listening on that port for incoming connections. Returns <code class="docutils literal"><span class="pre">server</span></code> object.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">tcp:connect(address,port)</span></code></p>
<p>Tries connecting to that address and port. Returns <code class="docutils literal"><span class="pre">client</span></code> object.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="cxxrandom">
<span id="id13"></span><h3><a class="toc-backref" href="#id145">cxxrandom</a><a class="headerlink" href="#cxxrandom" title="Permalink to this headline">¶</a></h3>
<p>Exposes some features of the C++11 random number library to Lua.</p>
<div class="section" id="native-functions-exported-to-lua">
<h4><a class="toc-backref" href="#id146">Native functions (exported to Lua)</a><a class="headerlink" href="#native-functions-exported-to-lua" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">GenerateEngine(seed)</span></code></p>
<p>returns engine id</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">DestroyEngine(rngID)</span></code></p>
<p>destroys corresponding engine</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">NewSeed(rngID,</span> <span class="pre">seed)</span></code></p>
<p>re-seeds engine</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rollInt(rngID,</span> <span class="pre">min,</span> <span class="pre">max)</span></code></p>
<p>generates random integer</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rollDouble(rngID,</span> <span class="pre">min,</span> <span class="pre">max)</span></code></p>
<p>generates random double</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rollNormal(rngID,</span> <span class="pre">avg,</span> <span class="pre">stddev)</span></code></p>
<p>generates random normal[gaus.]</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">rollBool(rngID,</span> <span class="pre">chance)</span></code></p>
<p>generates random boolean</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">MakeNumSequence(start,</span> <span class="pre">end)</span></code></p>
<p>returns sequence id</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">AddToSequence(seqID,</span> <span class="pre">num)</span></code></p>
<p>adds a number to the sequence</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ShuffleSequence(rngID,</span> <span class="pre">seqID)</span></code></p>
<p>shuffles the number sequence</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">NextInSequence(seqID)</span></code></p>
<p>returns the next number in sequence</p>
</li>
</ul>
</div>
<div class="section" id="lua-plugin-functions">
<h4><a class="toc-backref" href="#id147">Lua plugin functions</a><a class="headerlink" href="#lua-plugin-functions" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">MakeNewEngine(seed)</span></code></p>
<p>returns engine id</p>
</li>
</ul>
</div>
<div class="section" id="lua-plugin-classes">
<h4><a class="toc-backref" href="#id148">Lua plugin classes</a><a class="headerlink" href="#lua-plugin-classes" title="Permalink to this headline">¶</a></h4>
<div class="section" id="crng">
<h5><a class="toc-backref" href="#id149"><code class="docutils literal"><span class="pre">crng</span></code></a><a class="headerlink" href="#crng" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(id,</span> <span class="pre">df,</span> <span class="pre">dist)</span></code>: constructor<ul>
<li><code class="docutils literal"><span class="pre">id</span></code>: Reference ID of engine to use in RNGenerations</li>
<li><code class="docutils literal"><span class="pre">df</span></code> (optional): bool indicating whether to destroy the Engine when the crng object is garbage collected</li>
<li><code class="docutils literal"><span class="pre">dist</span></code> (optional): lua number distribution to use</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">changeSeed(seed)</span></code>: alters engine’s seed value</li>
<li><code class="docutils literal"><span class="pre">setNumDistrib(distrib)</span></code>: sets the number distribution crng object should use<ul>
<li><code class="docutils literal"><span class="pre">distrib</span></code>: number distribution object to use in RNGenerations</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">next()</span></code>: returns the next number in the distribution</li>
<li><code class="docutils literal"><span class="pre">shuffle()</span></code>: effectively shuffles the number distribution</li>
</ul>
</div>
<div class="section" id="normal-distribution">
<h5><a class="toc-backref" href="#id150"><code class="docutils literal"><span class="pre">normal_distribution</span></code></a><a class="headerlink" href="#normal-distribution" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(avg,</span> <span class="pre">stddev)</span></code>: constructor</li>
<li><code class="docutils literal"><span class="pre">next(id)</span></code>: returns next number in the distribution<ul>
<li><code class="docutils literal"><span class="pre">id</span></code>: engine ID to pass to native function</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="real-distribution">
<h5><a class="toc-backref" href="#id151"><code class="docutils literal"><span class="pre">real_distribution</span></code></a><a class="headerlink" href="#real-distribution" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(min,</span> <span class="pre">max)</span></code>: constructor</li>
<li><code class="docutils literal"><span class="pre">next(id)</span></code>: returns next number in the distribution<ul>
<li><code class="docutils literal"><span class="pre">id</span></code>: engine ID to pass to native function</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="int-distribution">
<h5><a class="toc-backref" href="#id152"><code class="docutils literal"><span class="pre">int_distribution</span></code></a><a class="headerlink" href="#int-distribution" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(min,</span> <span class="pre">max)</span></code>: constructor</li>
<li><code class="docutils literal"><span class="pre">next(id)</span></code>: returns next number in the distribution<ul>
<li><code class="docutils literal"><span class="pre">id</span></code>: engine ID to pass to native function</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="bool-distribution">
<h5><a class="toc-backref" href="#id153"><code class="docutils literal"><span class="pre">bool_distribution</span></code></a><a class="headerlink" href="#bool-distribution" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(min,</span> <span class="pre">max)</span></code>: constructor</li>
<li><code class="docutils literal"><span class="pre">next(id)</span></code>: returns next boolean in the distribution<ul>
<li><code class="docutils literal"><span class="pre">id</span></code>: engine ID to pass to native function</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="num-sequence">
<h5><a class="toc-backref" href="#id154"><code class="docutils literal"><span class="pre">num_sequence</span></code></a><a class="headerlink" href="#num-sequence" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">init(a,</span> <span class="pre">b)</span></code>: constructor</li>
<li><code class="docutils literal"><span class="pre">add(num)</span></code>: adds num to the end of the number sequence</li>
<li><code class="docutils literal"><span class="pre">shuffle()</span></code>: shuffles the sequence of numbers</li>
<li><code class="docutils literal"><span class="pre">next()</span></code>: returns next number in the sequence</li>
</ul>
</div>
</div>
</div>
</div>
<div class="section" id="scripts">
<h2><a class="toc-backref" href="#id42">Scripts</a><a class="headerlink" href="#scripts" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id14">
<ul class="simple">
<li><a class="reference internal" href="#enabling-and-disabling-scripts" id="id155">Enabling and disabling scripts</a></li>
<li><a class="reference internal" href="#save-init-script" id="id156">Save init script</a></li>
</ul>
</div>
<p>Any files with the .lua extension placed into <code class="file docutils literal"><span class="pre">hack/scripts/*</span></code>
are automatically used by the DFHack core as commands. The
matching command name consists of the name of the file without
the extension. First DFHack searches for the script in the <code class="file docutils literal"><span class="pre">&lt;save_folder&gt;/raw/scripts/</span></code> folder. If it is not found there, it searches in the <code class="file docutils literal"><span class="pre">&lt;DF&gt;/raw/scripts/</span></code> folder. If it is not there, it searches in
<code class="file docutils literal"><span class="pre">&lt;DF&gt;/hack/scripts/</span></code>. If it is not there, it gives up.</p>
<p>If the first line of the script is a one-line comment, it is
used by the built-in <code class="docutils literal"><span class="pre">ls</span></code> and <code class="docutils literal"><span class="pre">help</span></code> commands.
Such a comment is required for every script in the official DFHack repository.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Scripts placed in subdirectories still can be accessed, but
do not clutter the <a class="reference internal" href="Core.html#ls"><span class="std std-ref">ls</span></a> command list (unless <code class="docutils literal"><span class="pre">ls</span> <span class="pre">-a</span></code>; thus it is preferred
for obscure developer-oriented scripts and scripts used by tools.
When calling such scripts, always use ‘/’ as the separator for
directories, e.g. <code class="docutils literal"><span class="pre">devel/lua-example</span></code>.</p>
</div>
<p>Scripts are re-read from disk if they have changed since the last time they were read.
Global variable values persist in memory between calls, unless the file has changed.
Every script gets its own separate environment for global
variables.</p>
<p>Arguments are passed in to the scripts via the <strong>…</strong> built-in
quasi-variable; when the script is called by the DFHack core,
they are all guaranteed to be non-nil strings.</p>
<p>DFHack core invokes the scripts in the <em>core context</em> (see above);
however it is possible to call them from any lua code (including
from other scripts) in any context, via the same function the core uses:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.run_script(name[,args...])</span></code></p>
<p>Run a lua script in hack/scripts/, as if it was started from dfhack command-line.
The <code class="docutils literal"><span class="pre">name</span></code> argument should be the name stem, as would be used on the command line.</p>
</li>
</ul>
<p>Note that this function lets errors propagate to the caller.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.script_environment(name)</span></code></p>
<p>Run an Lua script and return its environment.
This command allows you to use scripts like modules for increased portability.
It is highly recommended that if you are a modder you put your custom modules in <code class="docutils literal"><span class="pre">raw/scripts</span></code> and use <code class="docutils literal"><span class="pre">script_environment</span></code> instead of <code class="docutils literal"><span class="pre">require</span></code> so that saves with your mod installed will be self-contained and can be transferred to people who do have DFHack but do not have your mod installed.</p>
<p>You can say <code class="docutils literal"><span class="pre">dfhack.script_environment('add-thought').addEmotionToUnit([arguments</span> <span class="pre">go</span> <span class="pre">here])</span></code> and it will have the desired effect.
It will call the script in question with the global <code class="docutils literal"><span class="pre">moduleMode</span></code> set to <code class="docutils literal"><span class="pre">true</span></code> so that the script can return early.
This is useful because if the script is called from the console it should deal with its console arguments and if it is called by <code class="docutils literal"><span class="pre">script_environment</span></code> it should only create its global functions and return.
You can also access global variables with, for example <code class="docutils literal"><span class="pre">print(dfhack.script_environment('add-thought').validArgs)</span></code></p>
<p>The function <code class="docutils literal"><span class="pre">script_environment</span></code> is fast enough that it is recommended that you not store its result in a nonlocal variable, because your script might need to load a different version of that script if the save is unloaded and a save with a different mod that overrides the same script with a slightly different functionality is loaded.
This will not be an issue in most cases.</p>
<p>This function also permits circular dependencies of scripts.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.reqscript(name)</span></code> or <code class="docutils literal"><span class="pre">reqscript(name)</span></code></p>
<p>Nearly identical to script_environment() but requires scripts being loaded to
include a line similar to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">--@</span> <span class="n">module</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>This is intended to only allow scripts that take appropriate action when used
as a module to be loaded.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dfhack.script_help([name,</span> <span class="pre">[extension]])</span></code></p>
<p>Returns the contents of the embedded documentation of the specified script.
<code class="docutils literal"><span class="pre">extension</span></code> defaults to “lua”, and <code class="docutils literal"><span class="pre">name</span></code> defaults to the name of the
script where this function was called.</p>
</li>
</ul>
<div class="section" id="enabling-and-disabling-scripts">
<h3><a class="toc-backref" href="#id155">Enabling and disabling scripts</a><a class="headerlink" href="#enabling-and-disabling-scripts" title="Permalink to this headline">¶</a></h3>
<p>Scripts can choose to recognize the built-in <code class="docutils literal"><span class="pre">enable</span></code> and <code class="docutils literal"><span class="pre">disable</span></code> commands
by including the following line anywhere in their file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">--@</span> <span class="n">enable</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>When the <code class="docutils literal"><span class="pre">enable</span></code> and <code class="docutils literal"><span class="pre">disable</span></code> commands are invoked, a <code class="docutils literal"><span class="pre">dfhack_flags</span></code>
table will be passed to the script with the following fields set:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">enable</span></code>: Always true if the script is being enabled <em>or</em> disabled</li>
<li><code class="docutils literal"><span class="pre">enable_state</span></code>: True if the script is being enabled, false otherwise</li>
</ul>
</div>
<div class="section" id="save-init-script">
<h3><a class="toc-backref" href="#id156">Save init script</a><a class="headerlink" href="#save-init-script" title="Permalink to this headline">¶</a></h3>
<p>If a save directory contains a file called <code class="docutils literal"><span class="pre">raw/init.lua</span></code>, it is
automatically loaded and executed every time the save is loaded.
The same applies to any files called <code class="docutils literal"><span class="pre">raw/init.d/*.lua</span></code>. Every
such script can define the following functions to be called by dfhack:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">onStateChange(op)</span> <span class="pre">...</span> <span class="pre">end</span></code></p>
<p>Automatically called from the regular onStateChange event as long
as the save is still loaded. This avoids the need to install a hook
into the global <code class="docutils literal"><span class="pre">dfhack.onStateChange</span></code> table, with associated
cleanup concerns.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">function</span> <span class="pre">onUnload()</span> <span class="pre">...</span> <span class="pre">end</span></code></p>
<p>Called when the save containing the script is unloaded. This function
should clean up any global hooks installed by the script. Note that
when this is called, the world is already completely unloaded.</p>
</li>
</ul>
<p>Within the init script, the path to the save directory is available as <code class="docutils literal"><span class="pre">SAVE_PATH</span></code>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/dfhack-logo.png" alt="Logo"/>
    
  </a>
</p>










<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="NEWS-dev.html" title="previous chapter">Development Changelog</a></li>
      <li>Next: <a href="../library/xml/SYNTAX.html" title="next chapter">Data Structure Definition Syntax</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">DFHack Lua API</a><ul>
<li><a class="reference internal" href="#df-data-structure-wrapper">DF data structure wrapper</a><ul>
<li><a class="reference internal" href="#typed-object-references">Typed object references</a><ul>
<li><a class="reference internal" href="#primitive-references">Primitive references</a></li>
<li><a class="reference internal" href="#struct-references">Struct references</a></li>
<li><a class="reference internal" href="#container-references">Container references</a></li>
<li><a class="reference internal" href="#bitfield-references">Bitfield references</a></li>
</ul>
</li>
<li><a class="reference internal" href="#named-types">Named types</a></li>
<li><a class="reference internal" href="#global-functions">Global functions</a></li>
<li><a class="reference internal" href="#recursive-table-assignment">Recursive table assignment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dfhack-api">DFHack API</a><ul>
<li><a class="reference internal" href="#native-utilities">Native utilities</a><ul>
<li><a class="reference internal" href="#input-output">Input &amp; Output</a></li>
<li><a class="reference internal" href="#exception-handling">Exception handling</a></li>
<li><a class="reference internal" href="#miscellaneous">Miscellaneous</a></li>
<li><a class="reference internal" href="#locking-and-finalization">Locking and finalization</a></li>
<li><a class="reference internal" href="#persistent-configuration-storage">Persistent configuration storage</a></li>
<li><a class="reference internal" href="#material-info-lookup">Material info lookup</a></li>
<li><a class="reference internal" href="#random-number-generation">Random number generation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#c-function-wrappers">C++ function wrappers</a><ul>
<li><a class="reference internal" href="#gui-module">Gui module</a><ul>
<li><a class="reference internal" href="#screens">Screens</a></li>
<li><a class="reference internal" href="#general-purpose-selections">General-purpose selections</a></li>
<li><a class="reference internal" href="#fortress-mode">Fortress mode</a></li>
<li><a class="reference internal" href="#announcements">Announcements</a></li>
<li><a class="reference internal" href="#other">Other</a></li>
</ul>
</li>
<li><a class="reference internal" href="#job-module">Job module</a></li>
<li><a class="reference internal" href="#units-module">Units module</a></li>
<li><a class="reference internal" href="#items-module">Items module</a></li>
<li><a class="reference internal" href="#maps-module">Maps module</a></li>
<li><a class="reference internal" href="#burrows-module">Burrows module</a></li>
<li><a class="reference internal" href="#buildings-module">Buildings module</a><ul>
<li><a class="reference internal" href="#general">General</a></li>
<li><a class="reference internal" href="#low-level">Low-level</a></li>
<li><a class="reference internal" href="#high-level">High-level</a></li>
</ul>
</li>
<li><a class="reference internal" href="#constructions-module">Constructions module</a></li>
<li><a class="reference internal" href="#kitchen-module">Kitchen module</a></li>
<li><a class="reference internal" href="#screen-api">Screen API</a></li>
<li><a class="reference internal" href="#penarray-class">PenArray class</a></li>
<li><a class="reference internal" href="#filesystem-module">Filesystem module</a></li>
<li><a class="reference internal" href="#console-api">Console API</a></li>
<li><a class="reference internal" href="#internal-api">Internal API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#core-interpreter-context">Core interpreter context</a><ul>
<li><a class="reference internal" href="#event-type">Event type</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#lua-modules">Lua Modules</a><ul>
<li><a class="reference internal" href="#global-environment">Global environment</a></li>
<li><a class="reference internal" href="#utils">utils</a></li>
<li><a class="reference internal" href="#dumper">dumper</a></li>
<li><a class="reference internal" href="#profiler">profiler</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#class">class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#in-game-ui-library">In-game UI Library</a><ul>
<li><a class="reference internal" href="#gui">gui</a><ul>
<li><a class="reference internal" href="#misc">Misc</a></li>
<li><a class="reference internal" href="#viewrect-class">ViewRect class</a></li>
<li><a class="reference internal" href="#painter-class">Painter class</a></li>
<li><a class="reference internal" href="#view-class">View class</a></li>
<li><a class="reference internal" href="#screen-class">Screen class</a></li>
<li><a class="reference internal" href="#framedscreen-class">FramedScreen class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gui-widgets">gui.widgets</a><ul>
<li><a class="reference internal" href="#widget-class">Widget class</a></li>
<li><a class="reference internal" href="#panel-class">Panel class</a></li>
<li><a class="reference internal" href="#pages-class">Pages class</a></li>
<li><a class="reference internal" href="#editfield-class">EditField class</a></li>
<li><a class="reference internal" href="#label-class">Label class</a></li>
<li><a class="reference internal" href="#list-class">List class</a></li>
<li><a class="reference internal" href="#filteredlist-class">FilteredList class</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#plugins">Plugins</a><ul>
<li><a class="reference internal" href="#blueprint">blueprint</a></li>
<li><a class="reference internal" href="#burrows">burrows</a></li>
<li><a class="reference internal" href="#sort">sort</a></li>
<li><a class="reference internal" href="#eventful">Eventful</a><ul>
<li><a class="reference internal" href="#list-of-events">List of events</a></li>
<li><a class="reference internal" href="#events-from-eventmanager">Events from EventManager</a></li>
<li><a class="reference internal" href="#functions">Functions</a></li>
<li><a class="reference internal" href="#id8">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-hacks">Building-hacks</a><ul>
<li><a class="reference internal" href="#id10">Functions</a></li>
<li><a class="reference internal" href="#id11">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#luasocket">Luasocket</a><ul>
<li><a class="reference internal" href="#socket-class">Socket class</a></li>
<li><a class="reference internal" href="#client-class">Client class</a></li>
<li><a class="reference internal" href="#server-class">Server class</a></li>
<li><a class="reference internal" href="#tcp-class">Tcp class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cxxrandom">cxxrandom</a><ul>
<li><a class="reference internal" href="#native-functions-exported-to-lua">Native functions (exported to Lua)</a></li>
<li><a class="reference internal" href="#lua-plugin-functions">Lua plugin functions</a></li>
<li><a class="reference internal" href="#lua-plugin-classes">Lua plugin classes</a><ul>
<li><a class="reference internal" href="#crng"><code class="docutils literal"><span class="pre">crng</span></code></a></li>
<li><a class="reference internal" href="#normal-distribution"><code class="docutils literal"><span class="pre">normal_distribution</span></code></a></li>
<li><a class="reference internal" href="#real-distribution"><code class="docutils literal"><span class="pre">real_distribution</span></code></a></li>
<li><a class="reference internal" href="#int-distribution"><code class="docutils literal"><span class="pre">int_distribution</span></code></a></li>
<li><a class="reference internal" href="#bool-distribution"><code class="docutils literal"><span class="pre">bool_distribution</span></code></a></li>
<li><a class="reference internal" href="#num-sequence"><code class="docutils literal"><span class="pre">num_sequence</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#scripts">Scripts</a><ul>
<li><a class="reference internal" href="#enabling-and-disabling-scripts">Enabling and disabling scripts</a></li>
<li><a class="reference internal" href="#save-init-script">Save init script</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, The DFHack Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../_sources/docs/Lua API.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>